/**
 * ğŸ¯ Webview æ‰“åŒ…è„šæœ¬
 * 
 * ç”¨é€”ï¼šå°†æ–°æ¶æ„çš„ 9 ä¸ª ES6 æ¨¡å—æ‰“åŒ…æˆå•ä¸ª bundle.js
 * - åŒ…å«æœ¬åœ° elk.bundled.js
 * - æ”¯æŒ CSP nonce
 * - ç”Ÿæˆ sourcemap ç”¨äºè°ƒè¯•
 */

const esbuild = require('esbuild');
const path = require('path');
const fs = require('fs');

const MEDIA_DIR = path.resolve(__dirname, '../media/filetree-blueprint');
const OUT_DIR = path.join(MEDIA_DIR, 'dist');
const ENTRY = path.join(MEDIA_DIR, 'graphView-slim.js');

async function buildBundle() {
  console.log('ğŸš€ å¼€å§‹æ‰“åŒ… Webview ä»£ç ...');
  
  // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
  if (!fs.existsSync(OUT_DIR)) {
    fs.mkdirSync(OUT_DIR, { recursive: true });
  }

  try {
    const result = await esbuild.build({
      entryPoints: [ENTRY],
      bundle: true,
      outfile: path.join(OUT_DIR, 'bundle.js'),
      format: 'iife', // ç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œé€‚åˆæµè§ˆå™¨ç¯å¢ƒ
      platform: 'browser',
      target: ['es2020'],
      sourcemap: true,
      minify: true, // ç”Ÿäº§ç¯å¢ƒå‹ç¼©
      treeShaking: true,
      metafile: true, // ç”Ÿæˆå…ƒæ•°æ®ç”¨äºåˆ†æ
      logLevel: 'info',
      banner: {
        js: '// ğŸ¨ AI Explorer - FileTree Blueprint Webview Bundle\n// Generated by esbuild\n'
      }
    });

    // è¾“å‡ºæ‰“åŒ…ä¿¡æ¯
    if (result.metafile) {
      const stats = await esbuild.analyzeMetafile(result.metafile, {
        verbose: false
      });
      console.log('\nğŸ“Š æ‰“åŒ…åˆ†æ:\n' + stats);
    }

    // æ£€æŸ¥æ–‡ä»¶å¤§å°
    const bundlePath = path.join(OUT_DIR, 'bundle.js');
    const stats = fs.statSync(bundlePath);
    const sizeKB = (stats.size / 1024).toFixed(2);
    
    console.log(`\nâœ… æ‰“åŒ…æˆåŠŸ!`);
    console.log(`   ğŸ“¦ è¾“å‡ºæ–‡ä»¶: ${bundlePath}`);
    console.log(`   ğŸ“ æ–‡ä»¶å¤§å°: ${sizeKB} KB`);
    
    // è­¦å‘Šï¼šå¦‚æœæ–‡ä»¶è¿‡å¤§
    if (stats.size > 500 * 1024) {
      console.warn(`\nâš ï¸  è­¦å‘Š: bundle æ–‡ä»¶å¤§äº 500KB (${sizeKB} KB)`);
      console.warn('   å»ºè®®æ£€æŸ¥æ˜¯å¦åŒ…å«äº†ä¸å¿…è¦çš„ä¾èµ–');
    }

    return true;
  } catch (error) {
    console.error('âŒ æ‰“åŒ…å¤±è´¥:', error);
    process.exit(1);
  }
}

// æ‰§è¡Œæ‰“åŒ…
buildBundle();
