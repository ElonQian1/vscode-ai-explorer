# 测试清单：大写词处理完整验证

## 前置条件

- ✅ 代码已编译（无错误）
- ✅ VS Code 已重新加载
- ✅ 直译风格已启用（`aiExplorer.alias.style = "literal"`）

## 测试场景 1：纯大写词（非白名单）

### 步骤

1. **创建测试文件**：
   ```
   DEBUG_WARNING_ATTRIBUTION.md
   ```

2. **右键翻译**：
   - 右键文件 → `AI Explorer: Translate File/Folder`

3. **预期结果**：

   | 原词 | 类型 | 词典查找 | AI 兜底 | 最终翻译 |
   |------|------|----------|---------|----------|
   | DEBUG | word | ✗ | ✓ | 调试 |
   | WARNING | word | ✗ | ✓ | 警告 |
   | ATTRIBUTION | word | ✗ | ✓ | 归因 |

   **最终别名**：`调试_警告_归因.md`

4. **验证学习词典**：
   
   打开 `.ai/.ai-glossary.literal.learned.json`：
   
   ```json
   {
     "words": {
       "debug": { "alias": "调试", "confidence": 1.0 },
       "warning": { "alias": "警告", "confidence": 1.0 },
       "attribution": { "alias": "归因", "confidence": 0.9 }
     }
   }
   ```
   
   ✅ **检查点**：键必须是小写

5. **检查控制台日志**：
   
   打开 `帮助` → `切换开发人员工具` → `Console`
   
   查找：
   ```
   [LiteralAIFallback] 对齐警告：...
   ```
   
   ✅ **检查点**：应该**没有**对齐警告（所有词都翻译了）

---

## 测试场景 2：混合大小写 + 白名单词

### 步骤

1. **创建测试文件**：
   ```
   DEBUG_API_useForm.ts
   ```

2. **右键翻译**

3. **预期结果**：

   | 原词 | 类型 | 词典查找 | 处理 | 最终翻译 |
   |------|------|----------|------|----------|
   | DEBUG | word | ✗ | AI | 调试 |
   | API | acronym | - | 保留 | API |
   | use | word | ✓/✗ | 词典/AI | 使用 |
   | Form | word | ✓/✗ | 词典/AI | 表单 |

   **最终别名**：`调试_API_使用表单.ts` 或 `调试_API_使用_表单.ts`
   
   （取决于 `keepOriginalDelimiters` 配置）

4. **验证**：
   
   ✅ **检查点**：API 应保留为大写（白名单词）
   
   ✅ **检查点**：DEBUG 应翻译为"调试"（非白名单词）

---

## 测试场景 3：驼峰 + 数字边界

### 步骤

1. **创建测试文件**：
   ```
   json2CSV_WARNING.js
   ```

2. **右键翻译**

3. **预期分词**：

   | 原词 | 分词结果 | 类型 |
   |------|----------|------|
   | json2CSV | json, 2, CSV | word, num, word |
   | WARNING | WARNING | word |

4. **预期翻译**：

   | 词元 | 翻译 |
   |------|------|
   | json | JSON (如果在白名单) / 杰森 (AI) |
   | 2 | 2 |
   | CSV | CSV (如果在白名单) / 逗号分隔值 (AI) |
   | WARNING | 警告 |

   **最终别名**：取决于白名单配置

5. **验证**：
   
   ✅ **检查点**：数字 `2` 应保留
   
   ✅ **检查点**：驼峰边界正确分割（json ↔ 2 ↔ CSV）

---

## 测试场景 4：对齐检测（触发警告）

### 步骤

1. **模拟 AI 错误**（需要手动修改 AI 提示词或响应）：
   
   假设 AI 遗漏了某个词的翻译

2. **预期控制台日志**：
   ```
   [LiteralAIFallback] 对齐警告：输入3个词，AI返回2个单词翻译
     输入词: DEBUG, UNKNOWN, WARNING
     AI返回: debug, warning
     缺失词: UNKNOWN
   ```

3. **验证**：
   
   ✅ **检查点**：警告日志应清晰标记缺失词
   
   ✅ **检查点**：缺失词应保留原文（作为后备）

---

## 测试场景 5：配置白名单

### 步骤

1. **修改配置**：
   
   在 `.vscode/settings.json` 中添加：
   
   ```json
   {
     "aiExplorer.alias.acronymAllowlist": [
       "UI", "API", "HTTP", "JSON", "CSV", "DEBUG"
     ]
   }
   ```
   
   ⚠️ **注意**：将 `DEBUG` 添加到白名单

2. **重新加载 VS Code**

3. **创建测试文件**：
   ```
   DEBUG_WARNING.md
   ```

4. **预期结果**：

   | 原词 | 是否白名单 | 类型 | 最终翻译 |
   |------|------------|------|----------|
   | DEBUG | ✓ | acronym | DEBUG |
   | WARNING | ✗ | word | 警告 |

   **最终别名**：`DEBUG_警告.md`

5. **验证**：
   
   ✅ **检查点**：DEBUG 现在应保留为大写（因为在白名单中）

---

## 测试场景 6：短语 + 大写词

### 步骤

1. **创建测试文件**：
   ```
   DEBUG_element_hierarchy.md
   ```

2. **词典准备**：
   
   确保 `.ai/.ai-glossary.literal.json` 包含：
   
   ```json
   {
     "phrases": {
       "element hierarchy": { "alias": "元素层级", "confidence": 1.0 }
     }
   }
   ```

3. **预期翻译**：

   | 词元 | 类型 | 翻译 |
   |------|------|------|
   | DEBUG | word | 调试 |
   | element | word (短语一部分) | 元素 |
   | hierarchy | word (短语一部分) | 层级 |

   **最终别名**：`调试_元素_层级.md`
   
   （保留内部分隔符）

4. **验证**：
   
   ✅ **检查点**：短语应逐词翻译，保留分隔符
   
   ✅ **检查点**：DEBUG 应翻译（非白名单）

---

## 综合验证清单

### 代码层面

- ✅ `SplitWithDelimiters.ts` - classify() 正确分类大写词
- ✅ `DictionaryResolver.ts` - resolveWord() 使用小写查找
- ✅ `DictionaryResolver.ts` - writeProjectLearning() 使用小写写入
- ✅ `LiteralAIFallback.ts` - 结构化 JSON 响应
- ✅ `LiteralAIFallback.ts` - 对齐检测（Alignment Guard）
- ✅ `LiteralAliasBuilderV2.ts` - 逐词翻译保留分隔符

### 功能层面

- ✅ 非白名单大写词被标记为普通词
- ✅ 白名单词被标记为缩写并保留
- ✅ 词典查找自动转小写
- ✅ AI 兜底明确大写词处理
- ✅ 对齐检测防止 AI 遗漏
- ✅ 学习词典使用小写键
- ✅ 保留原始分隔符和扩展名

### 配置层面

- ✅ `aiExplorer.alias.acronymAllowlist` - 白名单配置
- ✅ `aiExplorer.alias.keepOriginalDelimiters` - 分隔符保留
- ✅ `aiExplorer.alias.appendExtSuffix` - 扩展名后缀
- ✅ `aiExplorer.alias.literalJoiner` - 默认连接符

---

## 已知问题 / 注意事项

### 1. AI 提示词调优

- AI 可能偶尔遗漏某些词的翻译
- 解决方案：对齐检测会记录警告，用户可重试

### 2. 白名单维护

- 默认白名单可能不包含所有项目常用缩写
- 解决方案：在 `.vscode/settings.json` 中扩展

### 3. 短语匹配 vs 逐词翻译

- 当前实现：短语匹配后仍逐词翻译（保留分隔符）
- 原因：文档要求保留原始分隔符

### 4. 置信度阈值

- 当前 `MIN_CONFIDENCE = 0.5`
- 低于此值的翻译会被过滤（可能导致词缺失）

---

## 测试报告模板

### 测试日期：____________________

### 测试人员：____________________

### 测试环境：

- VS Code 版本：____________________
- 扩展版本：____________________
- AI 提供商：____________________

### 测试结果：

| 场景 | 测试文件 | 预期别名 | 实际别名 | 状态 | 备注 |
|------|----------|----------|----------|------|------|
| 场景 1 | DEBUG_WARNING_ATTRIBUTION.md | 调试_警告_归因.md | | ☐ 通过 ☐ 失败 | |
| 场景 2 | DEBUG_API_useForm.ts | 调试_API_使用表单.ts | | ☐ 通过 ☐ 失败 | |
| 场景 3 | json2CSV_WARNING.js | | | ☐ 通过 ☐ 失败 | |
| 场景 4 | （对齐检测） | | | ☐ 通过 ☐ 失败 | |
| 场景 5 | DEBUG_WARNING.md | DEBUG_警告.md | | ☐ 通过 ☐ 失败 | |
| 场景 6 | DEBUG_element_hierarchy.md | 调试_元素_层级.md | | ☐ 通过 ☐ 失败 | |

### 发现问题：

1. ____________________________________
2. ____________________________________
3. ____________________________________

### 改进建议：

1. ____________________________________
2. ____________________________________
3. ____________________________________

---

## 快速自检命令

### 1. 验证代码编译

```powershell
npm run compile
```

### 2. 检查配置

```powershell
code .vscode/settings.json
```

### 3. 查看词典

```powershell
code .ai/.ai-glossary.literal.learned.json
```

### 4. 清空学习词典（重置测试）

```powershell
Remove-Item .ai/.ai-glossary.literal.learned.json
```

### 5. 查看日志

```
帮助 → 切换开发人员工具 → Console
```

---

## 测试完成标志

- ☐ 所有 6 个场景测试通过
- ☐ 控制台无对齐警告（或警告符合预期）
- ☐ 学习词典使用小写键
- ☐ 白名单词正确保留
- ☐ 非白名单大写词正确翻译
- ☐ 分隔符和扩展名正确保留

**最终确认**：____________________（签名/日期）
