# 文件分析卡片功能 - 使用指南

## 功能概述

在文件树蓝图中双击代码文件,会弹出一张**AI分析卡片**,提供文件的结构化分析信息。

## 使用方法

### 1. 打开文件分析卡片

1. 在文件树蓝图中找到你想分析的代码文件
2. **双击文件节点**
3. 系统会自动弹出分析卡片

### 2. Tab页面说明

分析卡片包含4个Tab页面:

#### 📝 概览 (Overview)
- **摘要**: AI生成的文件功能说明
- **事实**: 从代码中直接提取的确定性信息
  - 例如: "该文件包含2个导出符号"
  - 每个事实都有 **[证据]** 链接,点击可跳转到源代码
- **推断**: AI基于代码分析的推测性结论
  - 包含置信度百分比
  - 也有证据链接支持
- **元信息**: 最后验证时间、是否需要刷新等

#### 📦 API
- 显示文件导出的所有符号(函数、类、接口等)
- 每个API包含:
  - **符号类型**: function, class, interface等
  - **符号名称**: 导出的标识符
  - **签名**: 完整的类型签名
  - **[证据]**: 点击跳转到定义位置

#### 📥📤 依赖
- **出依赖**: 该文件引用了哪些模块
  - 显示模块名和引用次数
- **入依赖样本**: 哪些文件引用了当前文件
  - 显示文件路径和行号
  - 可点击查看引用位置

#### 🔍 证据
- 所有证据的索引列表
- 点击任意证据可跳转到对应源代码位置
- 证据ID格式: `ev1`, `ev2`, ...

### 3. 操作按钮

卡片右上角有3个操作按钮:

- **📂 打开源文件**: 在编辑器中打开当前分析的文件
- **↻ 刷新分析**: 强制重新分析文件(清除缓存)
- **✕ 关闭**: 关闭分析卡片

### 4. 证据链接

在所有Tab页面中,你会看到蓝色的 **[证据]** 或 **[查看]** 链接:

- 点击这些链接会自动打开源文件
- 并跳转到证据对应的代码行
- 该行会被高亮显示

## 当前状态

### ✅ 已实现功能

- 双击文件触发分析
- 卡片UI渲染(4个Tab)
- Tab切换交互
- 证据链接跳转
- 打开源文件跳转
- 刷新/关闭操作

### 🔄 模拟数据阶段

当前返回的是**模拟数据**,仅用于演示UI流程:

```typescript
{
  summary: "这是一个模拟的文件摘要。实际分析功能正在开发中...",
  api: [{ name: 'mockFunction', kind: 'function', ... }],
  facts: [{ text: '该文件包含2个导出符号', ... }],
  ...
}
```

### ⏸️ 待实现功能

按优先级排序:

1. **StaticAnalyzer** - 静态代码分析器
   - 使用 `ts-morph` 或 `tree-sitter` 解析代码
   - 提取API、依赖、导入导出等结构化信息
   - 生成证据索引

2. **LLMAnalyzer** - AI语义分析器
   - 调用 OpenAI API
   - 生成摘要、推断、建议等
   - 使用 PromptProfiles 管理提示词

3. **CapsuleCache** - 缓存层
   - 基于文件内容哈希缓存分析结果
   - 检测文件变更自动失效
   - 支持强制刷新

4. **MCP集成** (未来计划)
   - 将FileCapsule暴露为MCP工具
   - 让 Copilot/Agent 调用分析结果
   - 实现渐进式增强

## 数据结构: FileCapsule

分析结果使用 `FileCapsule` 数据结构:

```typescript
interface FileCapsule {
    version: "1.0";
    file: string;              // 文件路径
    lang: string;              // 语言类型
    contentHash: string;       // 内容哈希(用于缓存)
    
    summary: {                 // 摘要
        zh: string;
        en: string;
    };
    
    api: Array<{              // API导出
        name: string;
        kind: 'function' | 'class' | 'interface' | ...;
        signature: string;
        evidence: string[];    // 证据ID列表
    }>;
    
    deps: {                   // 依赖关系
        out: Array<{          // 出依赖
            module: string;
            count: number;
            evidence: string[];
        }>;
        inSample: Array<{     // 入依赖样本
            file: string;
            line: number;
            evidence: string[];
        }>;
    };
    
    facts: Array<{            // 事实列表
        id: string;
        text: string;
        evidence: string[];
    }>;
    
    inferences: Array<{       // 推断列表
        id: string;
        text: string;
        confidence: number;   // 0-1
        evidence: string[];
    }>;
    
    recommendations: Array<{  // 建议列表
        id: string;
        text: string;
        reason: string;
        evidence: string[];
    }>;
    
    evidence: {               // 证据索引
        [evidenceId: string]: {
            file: string;
            lines: [number, number];  // 起始行-结束行
            sha256: string;           // 代码片段哈希
        };
    };
    
    stale: boolean;           // 是否过期
    lastVerifiedAt: string;   // 最后验证时间(ISO格式)
}
```

## 技术实现

### 前端 (graphView.js)

1. **事件绑定** (Lines 236-248):
   ```javascript
   if (n.type === "file" && n.data?.path && graph?.metadata?.graphType === "filetree") {
       el.addEventListener("dblclick", (e) => {
           vscode.postMessage({
               type: "analyze-file",
               payload: { path: n.data.path, nodeId: n.id }
           });
       });
   }
   ```

2. **消息处理** (Lines 156-159):
   ```javascript
   } else if (msg?.type === 'show-analysis-card') {
       showAnalysisCard(msg.payload);
   }
   ```

3. **卡片渲染** (Lines ~620-800):
   - `showAnalysisCard()`: 主渲染函数
   - `renderOverviewTab()`: 概览页
   - `renderApiTab()`: API页
   - `renderDepsTab()`: 依赖页
   - `renderEvidenceTab()`: 证据页

### 后端 (BlueprintPanel.ts)

1. **消息路由** (Lines 146-151):
   ```typescript
   case 'analyze-file':
       await this.handleAnalyzeFile(message.payload);
       break;
   
   case 'open-source':
       await this.handleOpenSource(message.payload);
       break;
   ```

2. **文件分析** (`handleAnalyzeFile`):
   - 接收文件路径
   - 调用分析器(当前返回模拟数据)
   - 发送 `show-analysis-card` 消息回前端

3. **源码跳转** (`handleOpenSource`):
   - 打开文件
   - 跳转到指定行
   - 高亮显示范围

### 样式 (analysisCard.css)

- 响应式卡片布局
- VSCode主题变量适配
- Tab切换动画
- 证据链接样式
- 空状态提示

## 下一步计划

### Phase 1: 静态分析 (本周)
- [ ] 创建 `StaticAnalyzer.ts`
- [ ] 集成 `ts-morph` 解析TypeScript
- [ ] 提取API符号、依赖关系
- [ ] 生成证据索引

### Phase 2: AI分析 (下周)
- [ ] 创建 `LLMAnalyzer.ts`
- [ ] 集成 OpenAI API
- [ ] 设计分析提示词
- [ ] 生成摘要、推断、建议

### Phase 3: 缓存优化 (下下周)
- [ ] 创建 `CapsuleCache.ts`
- [ ] 实现内容哈希缓存
- [ ] 文件变更检测
- [ ] 失效策略

### Phase 4: MCP集成 (未来)
- [ ] 设计MCP工具接口
- [ ] 暴露FileCapsule查询
- [ ] Copilot集成测试

## 故障排查

### 双击文件没反应?

1. 检查是否在 **文件树蓝图** 模式
   - 只有graphType为'filetree'的图支持此功能
   
2. 确认双击的是 **文件节点** 而非文件夹
   - 文件夹双击是下钻功能
   - 文件双击才会分析

3. 查看开发者控制台
   - 按 `Ctrl+Shift+I` 打开DevTools
   - 查看是否有 `[双击] 文件，请求分析:` 日志

### 证据链接点击无效?

1. 检查证据ID是否存在于 `evidence` 字典中
2. 确认文件路径是否正确
3. 查看后端日志确认 `open-source` 消息是否收到

### 卡片样式错乱?

1. 确认 `analysisCard.css` 已被加载
2. 检查浏览器控制台是否有CSS加载错误
3. 尝试刷新Webview

## 相关文件

- **前端**:
  - `media/filetree-blueprint/graphView.js` - 主视图逻辑
  - `media/filetree-blueprint/analysisCard.css` - 卡片样式

- **后端**:
  - `src/features/filetree-blueprint/panel/BlueprintPanel.ts` - 消息处理

- **未来模块**:
  - `src/features/file-analysis/StaticAnalyzer.ts` - 静态分析
  - `src/features/file-analysis/LLMAnalyzer.ts` - AI分析
  - `src/features/file-analysis/CapsuleCache.ts` - 缓存层
  - `src/features/file-analysis/types.ts` - FileCapsule接口

- **文档**:
  - `docs/实现方案.md` - 完整实现计划
  - `docs/文件分析卡片使用指南.md` - 本文档
