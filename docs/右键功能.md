我自己的 ai explorer 右键啥功能都没有， 我可以 自己增加功能吗？

可以的！你完全可以给自己的 **AI Explorer** 视图加右键菜单（上下文菜单）和视图工具栏按钮。
做法分 4 步：给每个节点设置 `contextValue` → 在 `package.json` 里声明 `menus` → 注册命令 → 实现命令逻辑。下面给你**可直接粘贴**的改动。

---

## 1) 给 TreeItem 设置 `contextValue`（区分文件/文件夹/是否已有别名）

```ts
// src/features/explorer-alias/ui/AIExplorerProvider.ts
// [module: explorer-alias] [tags: TreeItem, contextValue, menus]
getTreeItem(element: AINode): vscode.TreeItem {
  const base = path.basename(element.uri.fsPath);
  const cached = this.deps.cache.get(element.uri.fsPath);
  const alias = cached?.alias;

  const item = new vscode.TreeItem(
    this.showAlias ? (alias ?? base) : base,
    element.kind === 'folder' ? vscode.TreeItemCollapsibleState.Collapsed : vscode.TreeItemCollapsibleState.None
  );

  // 关键：为“右键菜单 when 条件”提供上下文
  // file | folder | fileHasAlias | folderHasAlias
  const hasAlias = Boolean(alias && alias !== base);
  item.contextValue = element.kind === 'file'
    ? (hasAlias ? 'fileHasAlias' : 'file')
    : (hasAlias ? 'folderHasAlias' : 'folder');

  item.description = this.showAlias ? base : (alias ?? '');
  item.resourceUri = element.uri;
  item.iconPath = element.kind === 'folder' ? new vscode.ThemeIcon('folder') : new vscode.ThemeIcon('file');
  if (element.kind === 'file') {
    item.command = { command: 'vscode.open', title: '打开', arguments: [element.uri] };
  }
  return item;
}
```

---

## 2) 在 `package.json` 声明右键菜单 & 视图工具栏

```json
// package.json（只展示新增片段）
{
  "contributes": {
    "commands": [
      {
        "command": "aiExplorer.translateNode",
        "title": "AI 资源管理器：翻译所选节点"
      },
      {
        "command": "aiExplorer.translateAll",
        "title": "AI 资源管理器：翻译整个工作区"
      },
      {
        "command": "aiExplorer.renameToAlias",
        "title": "AI 资源管理器：用别名重命名（谨慎）"
      },
      { "command": "aiExplorer.copyAlias", "title": "AI 资源管理器：复制别名" },
      {
        "command": "aiExplorer.clearCacheForNode",
        "title": "AI 资源管理器：清除此节点缓存"
      }
    ],
    "menus": {
      "view/item/context": [
        {
          "when": "view == aiExplorer && (viewItem == file || viewItem == folder)",
          "command": "aiExplorer.translateNode",
          "group": "navigation@10"
        },
        {
          "when": "view == aiExplorer && (viewItem == fileHasAlias || viewItem == folderHasAlias)",
          "command": "aiExplorer.renameToAlias",
          "group": "inline@10"
        },
        {
          "when": "view == aiExplorer && (viewItem == fileHasAlias || viewItem == folderHasAlias)",
          "command": "aiExplorer.copyAlias",
          "group": "navigation@20"
        },
        {
          "when": "view == aiExplorer && (viewItem == file || viewItem == folder || viewItem == fileHasAlias || viewItem == folderHasAlias)",
          "command": "aiExplorer.clearCacheForNode",
          "group": "z_cleanup@99"
        }
      ],
      "view/title": [
        {
          "when": "view == aiExplorer",
          "command": "aiExplorer.translateAll",
          "group": "navigation@10"
        },
        {
          "when": "view == aiExplorer",
          "command": "aiExplorer.toggleShowAlias",
          "group": "navigation@11"
        },
        {
          "when": "view == aiExplorer",
          "command": "aiExplorer.refresh",
          "group": "navigation@90"
        }
      ]
    }
  },
  "activationEvents": [
    "onView:aiExplorer",
    "onCommand:aiExplorer.translateNode",
    "onCommand:aiExplorer.translateAll",
    "onCommand:aiExplorer.renameToAlias",
    "onCommand:aiExplorer.copyAlias",
    "onCommand:aiExplorer.clearCacheForNode"
  ]
}
```

> 说明：
>
> - `view == aiExplorer` 必须与你视图 id 保持一致。
> - `group: "inline@10"` 会把按钮**内联显示**在树节点右侧（更顺手）。
> - `viewItem` 就是我们在 TreeItem 上设置的 `contextValue`。

---

## 3) 注册新命令（转给 provider 处理）

```ts
// src/features/explorer-alias/index.ts
// [module: explorer-alias] [tags: registerCommand]
export function registerExplorerAlias(context: vscode.ExtensionContext) {
  // … 省略依赖初始化
  const provider = new AIExplorerProvider({
    cache,
    translateNode,
    translateBatch,
    showAlias,
  });

  // 视图 & 命令
  context.subscriptions.push(
    vscode.window.createTreeView("aiExplorer", {
      treeDataProvider: provider,
      showCollapseAll: true,
    }),

    vscode.commands.registerCommand("aiExplorer.translateNode", (item?: any) =>
      provider.translateNode(item)
    ),
    vscode.commands.registerCommand("aiExplorer.translateAll", () =>
      provider.translateAllInWorkspace()
    ),
    vscode.commands.registerCommand("aiExplorer.renameToAlias", (item?: any) =>
      provider.renameToAlias(item)
    ),
    vscode.commands.registerCommand("aiExplorer.copyAlias", (item?: any) =>
      provider.copyAlias(item)
    ),
    vscode.commands.registerCommand(
      "aiExplorer.clearCacheForNode",
      (item?: any) => provider.clearCacheForNode(item)
    )
  );

  return provider;
}
```

---

## 4) 在 Provider 里实现两个小功能：复制别名、清除缓存

```ts
// src/features/explorer-alias/ui/AIExplorerProvider.ts
// [module: explorer-alias] [tags: copyAlias, clearCache]
async copyAlias(item?: AINode) {
  const node = item ?? (await this.getRoots())[0];
  if (!node) return;
  const rec = this.deps.cache.get(node.uri.fsPath);
  const alias = rec?.alias;
  if (!alias) { vscode.window.showInformationMessage('此节点暂无别名可复制'); return; }
  await vscode.env.clipboard.writeText(alias);
  vscode.window.showInformationMessage(`已复制别名：${alias}`);
}

async clearCacheForNode(item?: AINode) {
  const target = item ?? (await this.getRoots())[0];
  if (!target) return;

  // 递归清此节点（及子节点）缓存：
  const toClear: AINode[] = [];
  await this.collectRecursively(target, toClear as any); // 你已有 collectRecursively，可复用
  for (const n of toClear) this.deps.cache.delete?.(n.uri.fsPath); // 见下方 NameCacheStore 的 delete
  await this.deps.cache.flushToDiskIfPossible?.();
  this.refresh();
}
```

> 上面用到了 `cache.delete` —— 如果你的 `NameCacheStore` 里还没有，按下面加一个。

```ts
// src/features/explorer-alias/infra/cache/NameCacheStore.ts
// [module: explorer-alias] [tags: cache, delete]
delete(fsPath: string) {
  if (this.map.delete(fsPath)) this.persist();
}
```

> 如果你已经实现了整树剪切的 `removeOrRemovePrefix` / `movePrefix`，也可以在 `clearCacheForNode` 里用它们按前缀删除。

---

## 5) 常见“看不到右键菜单”的原因自查

1. **视图 id 不一致**：`contributes.views.explorer[].id` 必须等于 `aiExplorer`，并且 `menus` 里的 `view == aiExplorer` 也要一致。
2. **没有设置 `contextValue`**：右键菜单条件里用了 `viewItem == fileHasAlias` 等，TreeItem 没设的话就匹配不到。
3. **命令没激活**：`activationEvents` 里要有 `onCommand:<commandId>` 或 `onView:aiExplorer`。
4. **没重启宿主**：改了 `package.json` 需要重启扩展开发宿主（F5 窗口）才能加载新的菜单贡献。

---

## 6) 还能加什么右键菜单？

- “**提升到项目词表**”：把当前别名写入 `/.ai-glossary.json`（团队共享）。
- “**仅本地策略翻译此目录**”：只跑 词表/学习词典/规则，不打 API。
- “**用系统文件管理器打开**”：调用 `vscode.commands.executeCommand('revealFileInOS', uri)`。
- “**复制相对路径/绝对路径**”：自己写到剪贴板，或调用 VS Code 内置命令（不同版本 id 略有差异，自己测试一下）。

---

照着上面 4 步做完，**右键就会出现菜单**，而且还能在节点右侧显示内联按钮（如“重命名为别名”）。
如果你把仓库链接贴过来，我也可以按你当前文件结构给你一个**逐行补丁清单**，直接粘贴更快。
