# 腾讯云混元集成说明 - 技术细节

## 📌 关键概念澄清

### ❌ 常见误解

**误解 1**：使用"元宝 App"的 API
- ❌ 元宝（Yuanbao）是 C 端应用，不提供官方 API
- ✅ 实际使用：腾讯云混元大模型的 OpenAI 兼容接口

**误解 2**：需要使用 SecretId + SecretKey
- ❌ 传统腾讯云 API 的认证方式（复杂的签名算法）
- ✅ OpenAI 兼容接口使用专用 API Key（直接传递）

**误解 3**：需要特殊的 SDK
- ❌ 需要安装腾讯云专用 SDK
- ✅ 直接使用标准 OpenAI SDK（`openai` npm 包）

## 🏗️ 技术架构

### 集成原理

```
┌─────────────────────────────────────────┐
│      AI Explorer Extension              │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  MultiProviderAIClient            │ │
│  │                                   │ │
│  │  ┌─────────────┐  ┌─────────────┐│ │
│  │  │  Provider A │  │  Provider B ││ │
│  │  │  (OpenAI)   │  │  (Hunyuan)  ││ │
│  │  └─────────────┘  └─────────────┘│ │
│  │         │                 │       │ │
│  └─────────┼─────────────────┼───────┘ │
│            │                 │         │
└────────────┼─────────────────┼─────────┘
             │                 │
             ↓                 ↓
  ┌──────────────────┐  ┌──────────────────────┐
  │  OpenAI Client   │  │  OpenAI Client       │
  │  (openai npm)    │  │  (same package)      │
  ├──────────────────┤  ├──────────────────────┤
  │ baseURL:         │  │ baseURL:             │
  │ api.openai.com   │  │ api.hunyuan.cloud... │
  │                  │  │                      │
  │ apiKey:          │  │ apiKey:              │
  │ sk-xxxxxx        │  │ hunyuan-xxxxxx       │
  └──────────────────┘  └──────────────────────┘
             │                 │
             ↓                 ↓
  ┌──────────────────┐  ┌──────────────────────┐
  │  OpenAI API      │  │  Tencent Cloud       │
  │  (Official)      │  │  Hunyuan OpenAI      │
  │                  │  │  Compatible API      │
  └──────────────────┘  └──────────────────────┘
```

### 代码实现

```typescript
// 统一使用 OpenAI SDK
import { OpenAI } from 'openai';

// OpenAI 官方
const openaiClient = new OpenAI({
  apiKey: 'sk-xxxxxxxx',
  baseURL: 'https://api.openai.com/v1'
});

// 腾讯云混元（OpenAI 兼容）
const hunyuanClient = new OpenAI({
  apiKey: 'hunyuan-xxxxxxxx',  // 不是 SecretId/SecretKey
  baseURL: 'https://api.hunyuan.cloud.tencent.com/v1'
});

// 调用方式完全相同
const response = await client.chat.completions.create({
  model: 'gpt-3.5-turbo',  // 或 'hunyuan-turbo'
  messages: [{ role: 'user', content: 'Hello' }]
});
```

## 🔄 OpenAI 兼容性详解

### 兼容的 API 端点

根据[腾讯云官方文档](https://cloud.tencent.com/document/product/1729/111007)：

| API 端点 | OpenAI | 腾讯混元 | 说明 |
|---------|--------|----------|------|
| `/v1/chat/completions` | ✅ | ✅ | 对话补全（主要使用） |
| `/v1/embeddings` | ✅ | ✅ | 向量嵌入 |
| Function Calling | ✅ | ✅ | 函数调用 |
| Streaming | ✅ | ✅ | 流式响应 |
| `/v1/images/generations` | ✅ | ❌ | 图像生成（混元不支持） |
| `/v1/audio/*` | ✅ | ❌ | 音频处理（混元不支持） |

### 参数兼容性

```typescript
// 完全兼容的参数
{
  model: string,           // ✅ 模型名称（不同提供商使用各自模型）
  messages: Array,         // ✅ 消息数组
  temperature: number,     // ✅ 温度参数 (0-2)
  max_tokens: number,      // ✅ 最大 token 数
  stream: boolean,         // ✅ 是否流式返回
  top_p: number,          // ✅ 核采样参数
  frequency_penalty: number, // ⚠️ 部分支持，查看文档
  presence_penalty: number,  // ⚠️ 部分支持，查看文档
}
```

### 响应格式

```typescript
// 两者响应格式完全一致
{
  id: string,
  object: "chat.completion",
  created: number,
  model: string,
  choices: [{
    index: number,
    message: {
      role: "assistant",
      content: string
    },
    finish_reason: string
  }],
  usage: {
    prompt_tokens: number,
    completion_tokens: number,
    total_tokens: number
  }
}
```

## 🔐 认证机制对比

### OpenAI 官方

```http
POST https://api.openai.com/v1/chat/completions
Authorization: Bearer sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Content-Type: application/json
```

### 腾讯云混元（OpenAI 兼容）

```http
POST https://api.hunyuan.cloud.tencent.com/v1/chat/completions
Authorization: Bearer hunyuan-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Content-Type: application/json
```

**关键差异**：
- OpenAI: API Key 以 `sk-` 开头
- 腾讯混元: API Key 以 `hunyuan-` 开头（或其他前缀）
- 两者都使用 `Authorization: Bearer` 头部
- **不需要**传统腾讯云 API 的签名算法

## 🚀 切换提供商的优势

### 1. 代码零修改

```typescript
// 配置驱动，代码无需改动
const client = new OpenAI({
  apiKey: config.get('apiKey'),      // 从配置读取
  baseURL: config.get('baseURL')     // 从配置读取
});

// 调用代码完全相同
const result = await client.chat.completions.create({...});
```

### 2. 自动降级

```typescript
async sendRequest(request: AIRequest): Promise<AIResponse> {
  try {
    // 尝试主提供商（如 OpenAI）
    return await this.sendToProvider('openai', request);
  } catch (error) {
    // 自动降级到备用提供商（如混元）
    return await this.sendToProvider('hunyuan', request);
  }
}
```

### 3. 成本优化

```typescript
// 根据任务类型选择提供商
if (task.type === 'batch-translation') {
  // 批量任务用更便宜的混元
  provider = 'hunyuan';
  model = 'hunyuan-lite';
} else if (task.type === 'critical') {
  // 关键任务用 OpenAI
  provider = 'openai';
  model = 'gpt-4';
}
```

## 📊 性能与成本比较

| 维度 | OpenAI (GPT-3.5) | 腾讯混元 (turbo) | 说明 |
|------|------------------|------------------|------|
| **延迟** | 200-500ms | 150-400ms | 国内访问混元更快 |
| **可用性** | 99.9% | 99.5%+ | 两者都高可用 |
| **成本** | $$ | $ | 混元相对便宜 |
| **质量** | ⭐⭐⭐⭐ | ⭐⭐⭐ | GPT-3.5 略优 |
| **中文** | ⭐⭐⭐ | ⭐⭐⭐⭐ | 混元中文更好 |

## ⚠️ 注意事项与限制

### 1. 模型名称不通用

```typescript
// ❌ 不能直接替换
openai: 'gpt-3.5-turbo'  →  hunyuan: 'gpt-3.5-turbo'  // 错误！

// ✅ 需要使用对应模型
openai: 'gpt-3.5-turbo'  →  hunyuan: 'hunyuan-turbo'  // 正确
```

### 2. 部分高级功能差异

```typescript
// OpenAI 独有
- DALL-E 图像生成
- Whisper 语音识别
- GPT-4V 视觉理解

// 腾讯混元独有
- 更好的中文语义理解
- 国内合规性保证
- 更低的访问延迟（国内）
```

### 3. 速率限制不同

```typescript
// OpenAI (免费层)
- 3 RPM (requests per minute)
- 40,000 TPM (tokens per minute)

// 腾讯混元 (按量计费)
- 根据账号等级动态调整
- 通常比 OpenAI 更宽松
```

## 🎯 最佳实践

### 1. 配置管理

```json
// .vscode/settings.json (项目级)
{
  "aiExplorer.provider.primary": "hunyuan",
  "aiExplorer.hunyuanModel": "hunyuan-turbo"
}

// User Settings (全局)
{
  "aiExplorer.hunyuanApiKey": "hunyuan-xxxxxxxx",
  "aiExplorer.openaiApiKey": "sk-xxxxxxxx"
}
```

### 2. 错误处理

```typescript
try {
  result = await aiClient.sendRequest(request);
} catch (error) {
  if (error.message.includes('model_not_found')) {
    // 模型不存在，检查模型名称配置
  } else if (error.message.includes('Invalid API key')) {
    // API Key 无效，检查密钥格式
  } else if (error.message.includes('Rate limit')) {
    // 速率限制，实施退避策略
  }
}
```

### 3. 日志监控

```typescript
logger.debug(`[${provider}] 请求: model=${model}, tokens=${tokens}`);
logger.info(`[${provider}] 响应: cost=${cost}, latency=${latency}ms`);
logger.warn(`[${provider}] 降级: ${primaryProvider} → ${fallbackProvider}`);
```

## 📚 参考链接

- [腾讯云混元 OpenAI 兼容接口文档](https://cloud.tencent.com/document/product/1729/111007)
- [OpenAI API 参考](https://platform.openai.com/docs/api-reference)
- [OpenAI Node.js SDK](https://github.com/openai/openai-node)

## 💡 总结

**核心要点**：
1. ✅ 使用腾讯云混元的**官方 OpenAI 兼容接口**
2. ✅ 使用标准 **OpenAI SDK**（`openai` npm 包）
3. ✅ 通过切换 `baseURL` 和 `apiKey` 实现提供商切换
4. ❌ 不使用"元宝 App"的非官方接口
5. ❌ 不使用传统腾讯云 API 的 SecretId/SecretKey 认证

**技术优势**：
- 代码零修改
- 自动降级
- 成本优化
- 高可用性
