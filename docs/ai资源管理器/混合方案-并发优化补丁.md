# 混合方案 - 并发优化补丁

## 概述

本补丁为 `EnhancedTranslateBatchUseCase` 添加并发控制和重试机制，性能提升约 6 倍。

## 修改清单

### 1. 已完成 ✅

- [x] 创建 `src/shared/utils/ConcurrencyPool.ts`
- [x] 创建 `src/shared/utils/RetryHelper.ts`
- [x] 添加导入语句

### 2. 配置修改（package.json）

在 `package.json` 的 `"contributes"."configuration"."properties"` 中添加：

```json
{
  "contributes": {
    "configuration": {
      "properties": {
        "aiExplorer.batch.maxConcurrency": {
          "type": "number",
          "default": 6,
          "minimum": 1,
          "maximum": 16,
          "description": "批量翻译最大并发数（默认 6）。更高的并发数可以提升性能，但可能触发 API 限流"
        },
        "aiExplorer.batch.retryTimes": {
          "type": "number",
          "default": 1,
          "minimum": 0,
          "maximum": 3,
          "description": "批量翻译失败重试次数（默认 1）。用于处理短暂错误（如 429 限流、网络超时）"
        }
      }
    }
  }
}
```

### 3. 调用处修改（ExplorerAliasModule.ts）

在 `ExplorerAliasModule.ts` 的 `handleTranslateAllCommand` 方法中（约第314行）：

**修改前：**
```typescript
const results = await this.translateUseCase!.translateFiles(allFiles, {
    enableLearning: true,
    batchSize: 15,
    forceRefresh: false
});
```

**修改后：**
```typescript
// 🆕 读取并发配置
const config = vscode.workspace.getConfiguration('aiExplorer');
const maxConcurrency = config.get<number>('batch.maxConcurrency', 6);
const retryTimes = config.get<number>('batch.retryTimes', 1);

const results = await this.translateUseCase!.translateFiles(allFiles, {
    enableLearning: true,
    batchSize: 15,  // 已废弃，保留用于向后兼容
    forceRefresh: false,
    maxConcurrency,  // 🆕 并发控制
    retryTimes       // 🆕 重试机制
});
```

同样在 `handleTranslateSelected` 方法中（约第249行）也做类似修改。

---

## 性能对比

### 修改前（顺序处理）
- 100 个文件，每个耗时 1 秒
- 总耗时：100 秒

### 修改后（并发处理）
- 100 个文件，并发数 6
- 总耗时：100 / 6 ≈ 17 秒
- **性能提升：约 6 倍**

---

## 验证步骤

1. **编译项目**
   ```bash
   npm run compile
   ```

2. **重新加载 VS Code**
   - 按 F1，运行 "Developer: Reload Window"

3. **测试并发翻译**
   - 打开一个项目
   - 执行 "AI 资源管理器：翻译整个工作区"
   - 观察输出面板中的并发日志

4. **测试重试机制**
   - 故意触发 429 限流（快速翻译大量文件）
   - 检查日志中是否有 "翻译失败，第 N 次重试" 的消息

5. **验证配置生效**
   - 打开设置，搜索 "aiExplorer.batch"
   - 修改 `maxConcurrency` 为 3
   - 重新翻译，观察并发数是否变化

---

## 回滚方案

如果出现问题，可以回滚：

```bash
git checkout src/features/explorer-alias/app/usecases/EnhancedTranslateBatchUseCase.ts
git checkout src/features/explorer-alias/ExplorerAliasModule.ts
git checkout package.json
```

然后删除新增的工具类：
```bash
rm src/shared/utils/ConcurrencyPool.ts
rm src/shared/utils/RetryHelper.ts
```

---

## 后续优化建议

1. **动态并发控制**
   - 根据 API 响应时间自动调整并发数
   - 检测到 429 时自动降低并发数

2. **进度反馈增强**
   - 实时显示并发池状态（活跃/队列/已完成）
   - 显示当前正在翻译的文件列表

3. **批量优化**
   - 将相似的文件分组处理
   - 对已知简单文件（纯字母）跳过 AI 请求

4. **缓存预热**
   - 批量翻译前先检查缓存命中率
   - 缓存命中率高的文件优先处理

---

## 当前状态

- ✅ 并发池工具类已创建
- ✅ 重试助手工具类已创建
- ⏳ 等待应用配置修改
- ⏳ 等待更新调用处

**下一步：** 手动应用上述配置修改，或告诉我继续帮你完成剩余修改。
