# 翻译失败诊断指南

## 问题现象

```
ℹ️ 文件无需翻译：analyze_hierarchy_simple.cjs
```

文件名明明是英文，却显示"无需翻译"。

## 🔍 问题原因

这个提示**不是说文件不需要翻译**，而是说**翻译后的结果和原文件名相同**。

### 代码逻辑

```typescript
// AIExplorerProvider.ts 第 424-428 行
if (result.translated !== result.original) {
    vscode.window.showInformationMessage(
        `✅ 已翻译：${fileName} → ${result.translated}（来源：${sourceName}）`
    );
} else {
    vscode.window.showInformationMessage(
        `ℹ️ 文件无需翻译：${fileName}`  // ← 这里
    );
}
```

当 `result.translated === result.original` 时（翻译结果=原文件名），就会显示"文件无需翻译"。

### 为什么会这样？

翻译链路：**缓存 → 词典 → 规则 → AI → Fallback**

```typescript
// EnhancedTranslateBatchUseCase.ts 第 207-216 行
} else {
    // AI 翻译失败，使用原名
    const result: TranslationResult = {
        original: file.name,
        translated: file.name,  // ← 翻译结果=原文件名
        confidence: 0.0,
        source: 'fallback',    // ← 来源是 fallback
        timestamp: Date.now()
    };
    
    results.set(file, result);
}
```

**当 AI 翻译失败时，系统会返回一个 `fallback` 结果，翻译内容就是原文件名**。

## 🛠️ 诊断步骤

### 步骤 1: 检查 AI 配置

```
1. Ctrl+Shift+P
2. 运行命令：AI 资源管理器：检查AI状态
3. 查看输出
```

**预期输出**：
```
✅ AI 服务状态
OpenAI: ✅ 可用
腾讯混元: ✅ 可用
主提供商: OpenAI
```

**如果显示**：
```
❌ OpenAI: 不可用
❌ 腾讯混元: 不可用
```

→ **原因**: AI 服务未配置

**解决方法**：
```
1. Ctrl+Shift+P
2. 运行：AI 资源管理器：设置 OpenAI API Key
3. 输入你的 API Key
4. 重新尝试翻译
```

### 步骤 2: 查看输出日志

```
1. 打开 VS Code 输出面板
   - 菜单：视图 → 输出
   - 或快捷键：Ctrl+Shift+U

2. 在右上角下拉框选择 "AI Explorer"

3. 查看日志
```

**查找关键信息**：

```
// 好的日志
[INFO] 开始 AI 翻译 1 个文件
[INFO] AI 翻译成功: analyze_hierarchy_simple.cjs -> 分析层级简化脚本

// 坏的日志
[ERROR] 批量翻译失败 (batch 1): AI 服务不可用
[WARN] 单个翻译失败: analyze_hierarchy_simple.cjs
```

### 步骤 3: 测试 AI 翻译

```
1. Ctrl+Shift+P
2. 运行：AI 资源管理器：测试AI翻译
3. 输入测试文本，如：UserService
4. 查看翻译结果
```

**预期输出**：
```
✅ AI 翻译测试成功
原文: UserService
译文: 用户服务
来源: AI
```

**如果失败**：
```
❌ AI 翻译失败: 未配置 API Key
❌ AI 翻译失败: 网络连接超时
❌ AI 翻译失败: API Key 无效
```

### 步骤 4: 强制重新翻译（清除缓存）

如果缓存中保存了错误的结果：

```
1. 在 AI Explorer 视图中
2. 右键点击文件
3. 选择 "清除节点缓存"
4. 再次右键 → "翻译此文件"
```

### 步骤 5: 检查网络连接

```powershell
# 测试 OpenAI 连通性
Test-NetConnection api.openai.com -Port 443

# 测试腾讯混元连通性
Test-NetConnection hunyuan.cloud.tencent.com -Port 443
```

## 📊 常见原因对照表

| 症状 | 原因 | 解决方案 |
|------|------|---------|
| **ℹ️ 文件无需翻译** | AI 翻译返回空/失败 | 检查 AI 配置和日志 |
| **来源：fallback** | AI 服务不可用 | 设置 API Key |
| **来源：error** | AI 调用异常 | 查看错误日志 |
| **来源：缓存** | 使用了之前的错误缓存 | 清除缓存后重试 |
| **速度很慢** | 网络问题 | 检查网络连接 |

## 🔧 解决方案

### 方案 1: 配置 OpenAI

```
1. 获取 API Key: https://platform.openai.com/api-keys
2. Ctrl+Shift+P → "设置 OpenAI API Key"
3. 粘贴 API Key
4. 测试翻译
```

### 方案 2: 配置腾讯混元

```
1. 获取 API Key: https://cloud.tencent.com/product/hunyuan
2. Ctrl+Shift+P → "设置腾讯混元 API Key"
3. 粘贴 SecretId 和 SecretKey
4. 选择主提供商为 "腾讯混元"
```

### 方案 3: 检查代理设置

如果你在国内，访问 OpenAI 可能需要代理：

```json
// VS Code settings.json
{
  "http.proxy": "http://127.0.0.1:7890",
  "http.proxyStrictSSL": false
}
```

### 方案 4: 手动添加到词典

如果 AI 无法使用，可以手动添加翻译：

```
1. 找到词典文件（项目根目录）
2. 编辑 dictionary.json
3. 添加条目：
   {
     "analyze_hierarchy_simple.cjs": "分析层级简化脚本"
   }
4. 刷新 AI Explorer
```

## 🧪 完整诊断流程

```
┌─ 1. 运行 "检查AI状态"
│  └─ ❌ AI 不可用
│     └─ 设置 API Key
│        └─ 重新检查
│
├─ 2. 查看输出日志
│  └─ 找到错误信息
│     └─ 根据错误类型解决
│
├─ 3. 测试 AI 翻译
│  └─ ✅ 翻译成功
│     └─ 问题可能是缓存
│        └─ 清除缓存重试
│
└─ 4. 右键翻译文件
   └─ 查看提示信息
      ├─ "来源：AI" → ✅ 成功
      ├─ "来源：fallback" → ❌ AI 失败
      └─ "来源：error" → ❌ 严重错误
```

## 💡 改进建议

### 改进提示信息

当前的提示信息有误导性。建议修改为：

```typescript
// 修改前
vscode.window.showInformationMessage(`ℹ️ 文件无需翻译：${fileName}`);

// 修改后
vscode.window.showInformationMessage(
    `⚠️ 翻译失败或无变化：${fileName}（来源：${sourceName}）\n` +
    `提示：如果来源是 "fallback" 或 "error"，请检查 AI 服务配置`
);
```

### 添加更详细的日志

```typescript
if (result.translated !== result.original) {
    // 成功
} else {
    this.logger.warn(`翻译结果与原文相同: ${fileName}, 来源: ${result.source}`);
    
    if (result.source === 'fallback' || result.source === 'error') {
        vscode.window.showWarningMessage(
            `⚠️ ${fileName} 翻译失败，请检查 AI 服务配置`,
            '检查AI状态',
            '设置API Key'
        ).then(action => {
            if (action === '检查AI状态') {
                vscode.commands.executeCommand('aiExplorer.checkAIStatus');
            } else if (action === '设置API Key') {
                vscode.commands.executeCommand('aiExplorer.setOpenAIKey');
            }
        });
    }
}
```

## 📚 相关文档

- [AI 配置指南](./AI诊断和测试指南.md)
- [翻译功能说明](./右键单独翻译文件-使用指南.md)
- [故障排查](./troubleshooting.md)
