# å³é”®å•ç‹¬ç¿»è¯‘æ–‡ä»¶ - æ¶æ„è®¾è®¡ä¸å®ç°

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

å®ç°åœ¨ AI èµ„æºç®¡ç†å™¨å’Œ VS Code åŸç”Ÿèµ„æºç®¡ç†å™¨ä¸­å³é”®ç‚¹å‡»æ–‡ä»¶ï¼Œåªç¿»è¯‘è¯¥å•ä¸ªæ–‡ä»¶ï¼ˆä¸é€’å½’ç›®å½•ï¼‰ã€‚

## ğŸ“ æ¶æ„è®¾è®¡

### 1. ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UI Layer (è§†å›¾å±‚)                      â”‚
â”‚  - package.json (èœå•é…ç½®)                                â”‚
â”‚  - AIExplorerProvider.translateThisFile()                â”‚
â”‚  - å¤„ç†å‚æ•°è§£æ(èŠ‚ç‚¹/Uri/æ´»åŠ¨ç¼–è¾‘å™¨)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ è°ƒç”¨
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Application Layer (åº”ç”¨å±‚)                   â”‚
â”‚  - EnhancedTranslateBatchUseCase.translateSingle()       â”‚
â”‚  - TranslateBatchUseCase.translateSingleFile()           â”‚
â”‚  - æ‰§è¡Œç¿»è¯‘é€»è¾‘ï¼Œç®¡ç†ç¼“å­˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ ä¾èµ–
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Infrastructure Layer (åŸºç¡€å±‚)                â”‚
â”‚  - MultiProviderAIClient (AI è°ƒç”¨)                       â”‚
â”‚  - KVCache (ç¼“å­˜ç®¡ç†)                                     â”‚
â”‚  - DictionaryManager (è¯å…¸ç®¡ç†)                           â”‚
â”‚  - PromptProfiles (æç¤ºè¯é…ç½®)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµ

```
ç”¨æˆ·å³é”®ç‚¹å‡»æ–‡ä»¶
    â†“
VS Code è§¦å‘å‘½ä»¤ (aiExplorer.translateThisFile)
    â†“
AIExplorerProvider.translateThisFile(arg)
    â†“
è§£æå‚æ•° â†’ æ–‡ä»¶ Uri
    â†“
è°ƒç”¨ EnhancedTranslateBatchUseCase.translateSingle(fileName)
    â†“
æ‰§è¡Œç¿»è¯‘é“¾è·¯:
  1. æ£€æŸ¥ç¼“å­˜ (Cache Hit â†’ è¿”å›)
  2. æŸ¥è¯¢è¯å…¸ (Dictionary Hit â†’ è¿”å›)
  3. åº”ç”¨è§„åˆ™ (Rule Match â†’ è¿”å›)
  4. è°ƒç”¨ AI (MultiProviderAIClient)
  5. ä¿å­˜ç»“æœåˆ°ç¼“å­˜
    â†“
æ›´æ–°æ ‘è§†å›¾ (updateAlias + refresh)
    â†“
æ˜¾ç¤ºç»“æœæç¤º
```

### 3. å‚æ•°è§£æé€»è¾‘

`translateThisFile` éœ€è¦å…¼å®¹å¤šç§æ¥æºçš„å‚æ•°ï¼š

```typescript
// 1. æ¥è‡ª AI Explorer è§†å›¾çš„èŠ‚ç‚¹
{ node: FileNode, uri: vscode.Uri, ... }

// 2. æ¥è‡ªåŸç”Ÿèµ„æºç®¡ç†å™¨çš„ Uri
vscode.Uri (ç›´æ¥ä¼ å…¥)

// 3. æ¥è‡ªå‘½ä»¤é¢æ¿ (æ— å‚æ•°)
undefined â†’ ä½¿ç”¨æ´»åŠ¨ç¼–è¾‘å™¨æ–‡ä»¶

// 4. å…¶ä»–å¯èƒ½çš„æ ¼å¼
{ resourceUri: vscode.Uri }
{ path: string }
```

## ğŸ”§ å®ç°æ­¥éª¤

### Step 1: package.json é…ç½®

```json
{
  "contributes": {
    "commands": [
      {
        "command": "aiExplorer.translateThisFile",
        "title": "AI èµ„æºç®¡ç†å™¨ï¼šç¿»è¯‘æ­¤æ–‡ä»¶ï¼ˆä»…æ­¤æ–‡ä»¶ï¼‰",
        "icon": "$(symbol-text)"
      }
    ],
    "menus": {
      "view/item/context": [
        {
          "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias)",
          "command": "aiExplorer.translateThisFile",
          "group": "navigation@15"
        }
      ],
      "explorer/context": [
        {
          "when": "resourceScheme == file",
          "command": "aiExplorer.translateThisFile",
          "group": "navigation@915"
        }
      ]
    }
  }
}
```

### Step 2: AIExplorerProvider å®ç°

```typescript
async translateThisFile(input?: any): Promise<void> {
    // 1. å‚æ•°è§£æ
    const uri = await this.resolveToFileUri(input);
    if (!uri) {
        vscode.window.showWarningMessage("è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æ‰§è¡Œç¿»è¯‘");
        return;
    }

    // 2. éªŒè¯æ˜¯æ–‡ä»¶ï¼ˆéç›®å½•ï¼‰
    const stat = await vscode.workspace.fs.stat(uri).catch(() => undefined);
    if (!stat || stat.type !== vscode.FileType.File) {
        vscode.window.showWarningMessage("å½“å‰é€‰æ‹©çš„ä¸æ˜¯æ–‡ä»¶");
        return;
    }

    // 3. è·å–æ–‡ä»¶ä¿¡æ¯
    const fsPath = uri.fsPath;
    const fileName = path.basename(fsPath);

    // 4. æ‰§è¡Œç¿»è¯‘ï¼ˆè°ƒç”¨ UseCaseï¼‰
    try {
        const result = await this.translateUseCase!.translateSingle(fileName, {
            forceRefresh: false,
            enableLearning: true
        });

        // 5. æ›´æ–°æ ‘è§†å›¾
        const node = this.findNodeByPath(fsPath);
        if (node) {
            this.updateAlias(node, result.translated);
        }

        // 6. æ˜¾ç¤ºç»“æœ
        const sourceMap: Record<string, string> = {
            'dictionary': 'è¯å…¸',
            'rule': 'è§„åˆ™',
            'ai': 'AI',
            'cache': 'ç¼“å­˜',
            'fallback': 'å›é€€'
        };
        
        vscode.window.showInformationMessage(
            `å·²ç¿»è¯‘ï¼š${fileName} â†’ ${result.translated}ï¼ˆæ¥æºï¼š${sourceMap[result.source || 'unknown'] || result.source}ï¼‰`
        );

    } catch (error) {
        this.logger.error('ç¿»è¯‘å¤±è´¥', error);
        vscode.window.showErrorMessage(
            `ç¿»è¯‘å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`
        );
    }
}

// å‚æ•°è§£æè¾…åŠ©æ–¹æ³•
private async resolveToFileUri(input?: any): Promise<vscode.Uri | undefined> {
    if (!input) {
        // æ— å‚æ•° â†’ ä½¿ç”¨æ´»åŠ¨ç¼–è¾‘å™¨
        return vscode.window.activeTextEditor?.document?.uri;
    }
    if (input instanceof vscode.Uri) return input;
    if (typeof input === "string") return vscode.Uri.file(input);
    if (input.resourceUri instanceof vscode.Uri) return input.resourceUri;
    if (input.uri instanceof vscode.Uri) return input.uri;
    if (input.node && input.node.path) return vscode.Uri.file(input.node.path);
    if (input.path && typeof input.path === "string") return vscode.Uri.file(input.path);
    return undefined;
}
```

### Step 3: ExplorerAliasModule æ³¨å†Œå‘½ä»¤

```typescript
private registerCommands(context: vscode.ExtensionContext): void {
    // ... å…¶ä»–å‘½ä»¤ ...

    // å•æ–‡ä»¶ç¿»è¯‘å‘½ä»¤
    this.registerCommand(context, 'aiExplorer.translateThisFile', async (item) => {
        await this.treeProvider?.translateThisFile(item);
    });
}
```

## ğŸ” ä¸æ‰¹é‡ç¿»è¯‘çš„åŒºåˆ«

| ç‰¹æ€§ | å•æ–‡ä»¶ç¿»è¯‘ | æ‰¹é‡ç¿»è¯‘ |
|------|-----------|---------|
| **è§¦å‘æ–¹å¼** | å³é”®å•ä¸ªæ–‡ä»¶ | å·¥å…·æ /å‘½ä»¤é¢æ¿ |
| **å¤„ç†èŒƒå›´** | ä»…å½“å‰æ–‡ä»¶ | é€’å½’ç›®å½• |
| **æ€§èƒ½å½±å“** | æœ€å° | å¯èƒ½è¾ƒå¤§ |
| **ç»“æœåé¦ˆ** | å³æ—¶æç¤ºï¼ˆå«æ¥æºï¼‰ | è¿›åº¦æ¡+ç»Ÿè®¡ |
| **ç¼“å­˜ç­–ç•¥** | ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ | æ‰¹é‡æŸ¥è¯¢+æ‰¹é‡å†™å…¥ |
| **AI è°ƒç”¨** | å•æ¬¡è¯·æ±‚ | æ‰¹å¤„ç†ï¼ˆ3-10ä¸ª/æ‰¹ï¼‰ |

## ğŸ¨ ç”¨æˆ·ä½“éªŒè®¾è®¡

### 1. èœå•æ˜¾ç¤ºæ¡ä»¶

```typescript
// AI Explorer è§†å›¾ä¸­
when: "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias)"

// åŸç”Ÿèµ„æºç®¡ç†å™¨ä¸­
when: "resourceScheme == file"
```

### 2. ç»“æœæç¤ºæ ¼å¼

```
âœ… æˆåŠŸæ¡ˆä¾‹
å·²ç¿»è¯‘ï¼špackage.json â†’ åŒ…é…ç½®æ–‡ä»¶ï¼ˆæ¥æºï¼šè¯å…¸ï¼‰
å·²ç¿»è¯‘ï¼šUserService.ts â†’ ç”¨æˆ·æœåŠ¡ï¼ˆæ¥æºï¼šAIï¼‰

âš ï¸ è­¦å‘Šæ¡ˆä¾‹
æ­¤æ–‡ä»¶å·²æœ‰åˆ«åï¼Œæ— éœ€é‡å¤ç¿»è¯‘
å½“å‰é€‰æ‹©çš„ä¸æ˜¯æ–‡ä»¶

âŒ é”™è¯¯æ¡ˆä¾‹
ç¿»è¯‘å¤±è´¥: AI æœåŠ¡ä¸å¯ç”¨
ç¿»è¯‘å¤±è´¥: ç½‘ç»œè¶…æ—¶
```

### 3. å›¾æ ‡é€‰æ‹©

```json
{
  "icon": "$(symbol-text)"  // æ–‡æœ¬ç¬¦å·ï¼Œè¡¨ç¤ºç¿»è¯‘
}
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: AI Explorer è§†å›¾å³é”®

1. åœ¨ AI Explorer ä¸­å±•å¼€æ–‡ä»¶å¤¹
2. å³é”®ç‚¹å‡»æ–‡ä»¶ `index.ts`
3. é€‰æ‹© "ç¿»è¯‘æ­¤æ–‡ä»¶ï¼ˆä»…æ­¤æ–‡ä»¶ï¼‰"
4. éªŒè¯ï¼š
   - ä»…è¯¥æ–‡ä»¶è¢«ç¿»è¯‘
   - æ ‘è§†å›¾æ›´æ–°æ˜¾ç¤ºåˆ«å
   - æç¤ºæ¡†æ˜¾ç¤ºç¿»è¯‘ç»“æœå’Œæ¥æº

### åœºæ™¯ 2: åŸç”Ÿèµ„æºç®¡ç†å™¨å³é”®

1. åœ¨ VS Code å·¦ä¾§èµ„æºç®¡ç†å™¨ä¸­
2. å³é”®ç‚¹å‡»æ–‡ä»¶
3. é€‰æ‹© "AI èµ„æºç®¡ç†å™¨ï¼šç¿»è¯‘æ­¤æ–‡ä»¶ï¼ˆä»…æ­¤æ–‡ä»¶ï¼‰"
4. éªŒè¯ï¼š
   - ç¿»è¯‘æˆåŠŸ
   - AI Explorer è§†å›¾åŒæ­¥æ›´æ–°ï¼ˆå¦‚æœå·²å±•å¼€ï¼‰

### åœºæ™¯ 3: å‘½ä»¤é¢æ¿è°ƒç”¨

1. æ‰“å¼€æ–‡ä»¶ `config.json`
2. `Ctrl+Shift+P` æ‰“å¼€å‘½ä»¤é¢æ¿
3. è¾“å…¥ "ç¿»è¯‘æ­¤æ–‡ä»¶"
4. éªŒè¯ï¼š
   - å½“å‰ç¼–è¾‘å™¨æ–‡ä»¶è¢«ç¿»è¯‘

### åœºæ™¯ 4: ç¼“å­˜å‘½ä¸­

1. ç¿»è¯‘è¿‡çš„æ–‡ä»¶å†æ¬¡å³é”®ç¿»è¯‘
2. éªŒè¯ï¼š
   - ç¬é—´è¿”å›ï¼ˆæ—  AI è°ƒç”¨ï¼‰
   - æç¤ºæ˜¾ç¤º "æ¥æºï¼šç¼“å­˜"

### åœºæ™¯ 5: è¯å…¸å‘½ä¸­

1. å³é”®ç¿»è¯‘ `README.md`
2. éªŒè¯ï¼š
   - ä½¿ç”¨è¯å…¸é¢„å®šä¹‰ç¿»è¯‘
   - æç¤ºæ˜¾ç¤º "æ¥æºï¼šè¯å…¸"

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ä¼˜å…ˆç­–ç•¥

```typescript
async translateSingle(fileName: string): Promise<TranslationResult> {
    // 1. æ£€æŸ¥ç¼“å­˜ (< 1ms)
    const cached = await this.getCachedTranslation(fileName);
    if (cached) return cached;

    // 2. æŸ¥è¯¢è¯å…¸ (< 5ms)
    const dictResult = this.dictionary.translate(fileName);
    if (dictResult) return { ...dictResult, source: 'dictionary' };

    // 3. åº”ç”¨è§„åˆ™ (< 10ms)
    const ruleResult = this.applyRules(fileName);
    if (ruleResult) return { ...ruleResult, source: 'rule' };

    // 4. è°ƒç”¨ AI (100-2000ms)
    return await this.callAI(fileName);
}
```

### 2. å¹¶å‘æ§åˆ¶

- å•æ–‡ä»¶ç¿»è¯‘ï¼šæ— éœ€å¹¶å‘æ§åˆ¶
- æ‰¹é‡ç¿»è¯‘ï¼šä½¿ç”¨æ‰¹å¤„ç†ï¼ˆbatchSize: 3-10ï¼‰

### 3. ç¼“å­˜ç­–ç•¥

```typescript
// ç¼“å­˜é”®æ ¼å¼
const cacheKey = `enhanced-translation:${fileName}`;

// ç¼“å­˜æœ‰æ•ˆæœŸ
const CACHE_TTL = 7 * 24 * 60 * 60 * 1000; // 7å¤©

// ç¼“å­˜æ•°æ®ç»“æ„
{
    original: "index.ts",
    translated: "å…¥å£æ–‡ä»¶",
    source: "ai",
    confidence: 0.95,
    timestamp: 1697234567890
}
```

## ğŸ”’ é”™è¯¯å¤„ç†

```typescript
try {
    const result = await this.translateSingle(fileName);
    // æˆåŠŸå¤„ç†...
} catch (error) {
    if (error instanceof AIServiceError) {
        vscode.window.showErrorMessage('AI æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥é…ç½®');
    } else if (error instanceof NetworkError) {
        vscode.window.showErrorMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    } else {
        vscode.window.showErrorMessage(`ç¿»è¯‘å¤±è´¥: ${error.message}`);
    }
    this.logger.error('ç¿»è¯‘å¤±è´¥', error);
}
```

## ğŸ“ æ—¥å¿—è®°å½•

```typescript
// æˆåŠŸæ—¥å¿—
this.logger.info(`ç¿»è¯‘æˆåŠŸ: ${fileName} -> ${result.translated} (æ¥æº: ${result.source})`);

// ç¼“å­˜å‘½ä¸­æ—¥å¿—
this.logger.debug(`ç¼“å­˜å‘½ä¸­: ${fileName} -> ${cachedResult.translated}`);

// é”™è¯¯æ—¥å¿—
this.logger.error(`ç¿»è¯‘å¤±è´¥: ${fileName}`, error);

// æ€§èƒ½æ—¥å¿—
this.logger.perf(`ç¿»è¯‘è€—æ—¶: ${fileName} - ${duration}ms`);
```

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

1. **å³é”®èœå•å¢å¼º**
   - æ·»åŠ  "å¼ºåˆ¶é‡æ–°ç¿»è¯‘" é€‰é¡¹ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
   - æ·»åŠ  "æ·»åŠ åˆ°è¯å…¸" é€‰é¡¹ï¼ˆä¿å­˜è‡ªå®šä¹‰ç¿»è¯‘ï¼‰

2. **ç¿»è¯‘è´¨é‡æå‡**
   - æ”¯æŒä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼ˆæ ¹æ®æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼‰
   - æ”¯æŒæ–‡ä»¶ç±»å‹ç‰¹å®šè§„åˆ™

3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - ç¿»è¯‘è¿›åº¦æŒ‡ç¤ºï¼ˆå¯¹äºå¤§æ–‡ä»¶ï¼‰
   - ç¿»è¯‘å†å²è®°å½•æŸ¥çœ‹
   - å¿«æ·é”®æ”¯æŒ

4. **æ™ºèƒ½æ¨è**
   - æ£€æµ‹åˆ°è‹±æ–‡æ–‡ä»¶æ—¶è‡ªåŠ¨æç¤ºç¿»è¯‘
   - æ‰¹é‡ç¿»è¯‘åæ˜¾ç¤ºç»Ÿè®¡æŠ¥å‘Š

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç¿»è¯‘æ¨¡å—è®¾è®¡](./ç¬¬3æ­¥.md)
- [AI æä¾›å•†é…ç½®](./ai-providers.md)
- [ç¼“å­˜ç­–ç•¥è¯´æ˜](./cache-strategy.md)
- [è¯å…¸ç®¡ç†æŒ‡å—](./dictionary-management.md)
