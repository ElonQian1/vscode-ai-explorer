# 修复：文件夹右键菜单缺失翻译选项

## 问题描述

用户反馈：**"文件夹现在右键的选项跟文件不一样。"**

## 问题分析

### 当前右键菜单行为

在 **AI Explorer 视图**中：

```json
// ❌ 修复前：只在文件上显示
{
  "command": "aiExplorer.translateThisFile",
  "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias)",
  "group": "navigation@15"
},
{
  "command": "aiExplorer.forceAITranslate",
  "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias)",
  "group": "navigation@16"
}
```

**问题：**
- 文件右键有 **"翻译此文件（仅此文件）"** 和 **"强制用 AI 翻译此文件"**
- 文件夹右键**没有**这两个选项 ❌

### 原因分析

#### 1. `contextValue` 定义

在 `ExplorerTreeItem.ts` 中，文件和文件夹的 `contextValue` 不同：

```typescript
this.contextValue = this.node.type === 'file'
    ? (hasAlias ? 'fileHasAlias' : 'file')
    : (hasAlias ? 'folderHasAlias' : 'folder');  // ← 文件夹是 'folder'
```

**可能的值：**
- 文件：`file` 或 `fileHasAlias`
- 文件夹：`folder` 或 `folderHasAlias`

#### 2. 菜单配置不完整

在 `package.json` 中，菜单配置只匹配了文件的 `contextValue`：

```json
"when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias)"
//                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
//                               只匹配文件，不匹配文件夹
```

### 对比其他菜单

其他菜单已经正确支持文件夹：

```json
// ✅ "翻译为中文" 命令 - 支持文件和文件夹
{
  "command": "aiExplorer.translate",
  "when": "view == aiExplorer && (viewItem == file || viewItem == folder)",
  //                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  "group": "navigation@10"
}

// ✅ "重命名为别名" 命令 - 支持文件和文件夹
{
  "command": "aiExplorer.renameToAlias",
  "when": "view == aiExplorer && (viewItem == fileHasAlias || viewItem == folderHasAlias)",
  "group": "inline@10"
}
```

## 解决方案

### 修复菜单配置

修改 `package.json` 中的菜单配置，添加文件夹的 `contextValue`：

```json
// ✅ 修复后：支持文件和文件夹
{
  "command": "aiExplorer.translateThisFile",
  "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias || viewItem == folder || viewItem == folderHasAlias)",
  //                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  "group": "navigation@15"
},
{
  "command": "aiExplorer.forceAITranslate",
  "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias || viewItem == folder || viewItem == folderHasAlias)",
  //                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  "group": "navigation@16"
}
```

**修复内容：**
- 添加 `viewItem == folder`（文件夹，无别名）
- 添加 `viewItem == folderHasAlias`（文件夹，有别名）

## 修复效果

### 修复前

**文件右键菜单：**
- ✅ 翻译为中文
- ✅ 翻译此文件（仅此文件）
- ✅ 强制用 AI 翻译此文件
- ✅ 复制别名（如果有别名）
- ✅ 重命名为别名（如果有别名）

**文件夹右键菜单：**
- ✅ 翻译为中文
- ❌ 翻译此文件（仅此文件）  ← **缺失**
- ❌ 强制用 AI 翻译此文件  ← **缺失**
- ✅ 复制别名（如果有别名）
- ✅ 重命名为别名（如果有别名）

### 修复后

**文件夹右键菜单：**
- ✅ 翻译为中文
- ✅ 翻译此文件（仅此文件）  ← **新增**
- ✅ 强制用 AI 翻译此文件  ← **新增**
- ✅ 复制别名（如果有别名）
- ✅ 重命名为别名（如果有别名）

**现在文件和文件夹的右键菜单完全一致！** ✅

## 完整的菜单配置

修复后的 `view/item/context` 配置：

```json
"view/item/context": [
  {
    "command": "aiExplorer.translate",
    "when": "view == aiExplorer && (viewItem == file || viewItem == folder)",
    "group": "navigation@10"
  },
  {
    "command": "aiExplorer.translateThisFile",
    "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias || viewItem == folder || viewItem == folderHasAlias)",
    "group": "navigation@15"
  },
  {
    "command": "aiExplorer.forceAITranslate",
    "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias || viewItem == folder || viewItem == folderHasAlias)",
    "group": "navigation@16"
  },
  {
    "command": "aiExplorer.renameToAlias",
    "when": "view == aiExplorer && (viewItem == fileHasAlias || viewItem == folderHasAlias)",
    "group": "inline@10"
  },
  {
    "command": "aiExplorer.copyAlias",
    "when": "view == aiExplorer && (viewItem == fileHasAlias || viewItem == folderHasAlias)",
    "group": "navigation@20"
  },
  {
    "command": "aiExplorer.clearCacheForNode",
    "when": "view == aiExplorer",
    "group": "z_cleanup@99"
  }
]
```

## 测试验证

### 测试步骤

1. **重新加载 VS Code**
   - 按 `Ctrl+Shift+P`
   - 输入 `Reload Window`
   - 回车

2. **测试文件夹右键菜单**
   - 在 AI Explorer 视图中
   - 右键点击任意文件夹
   - 应该看到：
     * "翻译为中文"
     * "翻译此文件（仅此文件）" ✅
     * "强制用 AI 翻译此文件" ✅

3. **测试翻译功能**
   - 右键文件夹 → "翻译此文件（仅此文件）"
   - 应该看到：`正在翻译文件夹: xxx`
   - 翻译结果：保留所有分隔符

### 示例

```
文件夹名：contact-button-structure
右键 → "翻译此文件（仅此文件）"
结果：接触-按钮-结构 ✅
```

## 为什么需要4个 viewItem

VS Code 的菜单系统需要明确指定所有可能的 `contextValue`：

```typescript
// 文件的 contextValue
'file'         // 文件，无别名
'fileHasAlias' // 文件，有别名

// 文件夹的 contextValue
'folder'         // 文件夹，无别名
'folderHasAlias' // 文件夹，有别名
```

**菜单配置必须匹配所有情况：**

```json
"when": "view == aiExplorer && (
    viewItem == file ||          // 文件，无别名
    viewItem == fileHasAlias ||  // 文件，有别名
    viewItem == folder ||        // 文件夹，无别名
    viewItem == folderHasAlias   // 文件夹，有别名
)"
```

## 代码变更

### package.json

```diff
 {
   "command": "aiExplorer.translateThisFile",
-  "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias)",
+  "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias || viewItem == folder || viewItem == folderHasAlias)",
   "group": "navigation@15"
 },
 {
   "command": "aiExplorer.forceAITranslate",
-  "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias)",
+  "when": "view == aiExplorer && (viewItem == file || viewItem == fileHasAlias || viewItem == folder || viewItem == folderHasAlias)",
   "group": "navigation@16"
 }
```

## 总结

这次修复解决了文件夹右键菜单缺失翻译选项的问题：

1. **根本原因**：菜单配置只匹配了文件的 `contextValue`，未匹配文件夹
2. **解决方案**：添加 `folder` 和 `folderHasAlias` 到菜单条件中
3. **修复效果**：文件和文件夹右键菜单完全一致
4. **向后兼容**：✅ 不影响现有功能，只是增加了菜单选项

---

**修复日期**：2025-10-15  
**影响范围**：AI Explorer 视图中的文件夹右键菜单  
**向后兼容**：✅ 完全兼容，只是增加菜单选项
