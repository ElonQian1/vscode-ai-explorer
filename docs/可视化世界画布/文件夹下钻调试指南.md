# 文件夹下钻功能调试指南

## 🎯 预期行为

1. **双击子文件夹** → 在同一面板内刷新，显示该文件夹的内容
2. **双击根节点** → 返回上一级文件夹

## 🔍 调试步骤

### Step 1: 重新加载 VS Code
```
F1 → Developer: Reload Window
```

### Step 2: 打开开发者工具
打开**两个**调试窗口：

#### A. Webview 开发者工具（前端）
```
F1 → Developer: Open Webview Developer Tools
→ 切换到 Console 标签
```

#### B. 扩展主机开发者工具（后端）
```
F1 → Developer: Toggle Developer Tools  
→ 切换到 Console 标签
```

### Step 3: 打开蓝图
1. 在 AI 资源管理器中右键任意文件夹
2. 选择"在此打开蓝图"

### Step 4: 测试双击
1. **双击一个子文件夹**（不是根节点）
2. 观察两个控制台的输出

---

## 📊 预期日志输出

### ✅ 前端（Webview Console）应该看到：
```
[双击] 子文件夹，发送 drill: d:\your-project\subfolder
```

或者（如果双击根节点）：
```
[双击] 根节点，发送 drill-up: d:\your-project
```

### ✅ 后端（Extension Host Console）应该看到：
```
[INFO] [handleDrill] 收到下钻请求, payload: { path: 'd:\\your-project\\subfolder' }
[INFO] [handleDrill] 提取的 folderPath: d:\your-project\subfolder
[INFO] 下钻到: d:\your-project\subfolder
[INFO] 开始浅层扫描: d:\your-project\subfolder
[INFO] 浅层扫描完成: X 个文件夹, Y 个文件
[INFO] 显示蓝图: subfolder (Z 个节点)
[INFO] 已刷新到子目录: d:\your-project\subfolder
```

---

## 🐛 常见问题排查

### 问题 1: 双击没有任何反应

#### 检查点 A: 前端是否发送了消息？
**查看 Webview Console**，双击时应该有日志：
- ❌ 如果没有日志 → 双击事件没有绑定

**可能原因**：
1. `n.type` 不是 `"folder"`
2. `n.data?.path` 为空
3. `graph?.metadata?.graphType` 不是 `"filetree"`

**解决方案**：
在 Webview Console 中检查节点数据：
```javascript
// 打开 Webview DevTools，在 Console 中执行：
console.log('graph:', graph);
console.log('nodes:', graph.nodes);
```

查看输出中的节点：
```javascript
{
  id: "...",
  label: "folder-name",
  type: "folder",  // ✅ 必须是 "folder"
  position: {x: 100, y: 200},
  data: {
    path: "d:\\project\\folder",  // ✅ 必须有绝对路径
    isRoot: false  // 子文件夹应该是 false
  }
}
```

**同时检查 metadata**：
```javascript
{
  metadata: {
    graphType: "filetree",  // ✅ 必须是 "filetree"
    ...
  }
}
```

#### 检查点 B: 双击是否被拖拽事件拦截？

如果你拖动了节点，`dblclick` 事件可能被拦截。

**测试方法**：
1. 双击时**不要移动鼠标**
2. 快速连续点击两次

如果仍然不行，可能是拖拽事件拦截。让我检查 `makeDraggable` 函数。

---

### 问题 2: 前端发送了消息，但后端没有反应

**查看 Extension Host Console**：
- ❌ 如果没有看到 `[handleDrill]` 日志

**可能原因**：
1. 消息类型不匹配
2. `handleMessage` 的 switch-case 没有匹配到

**解决方案**：
在后端添加临时日志，查看收到的原始消息：

```typescript
// 在 handleMessage 函数开头
private async handleMessage(message: any): Promise<void> {
    console.log('[handleMessage] 收到消息:', message);  // 添加这行
    this.logger.debug(`收到 Webview 消息: ${message.type}`);
    ...
}
```

---

### 问题 3: 后端收到了消息，但扫描失败

**查看 Extension Host Console**：
```
[ERROR] 下钻失败: ...
```

**可能原因**：
1. `folderPath` 不是有效的绝对路径
2. 路径不存在
3. 没有读取权限

**解决方案**：
检查路径格式：
```
✅ 正确: d:\rust\active-projects\ai-explorer\src
❌ 错误: src (相对路径)
❌ 错误: /src (POSIX 路径)
```

---

### 问题 4: 扫描成功，但面板没有刷新

**查看后端日志**：
```
[INFO] 已刷新到子目录: ...
```

**可能原因**：
1. `showGraph` 函数有问题
2. Webview 没有接收到 `init-graph` 消息

**解决方案**：
在 Webview Console 中检查是否收到消息：
```javascript
// 在 handleMessage 函数中应该有日志
if (msg?.type === 'init-graph') {
    console.log('[收到] init-graph 消息:', msg.payload);
    graph = msg.payload;
    ...
}
```

---

## 🔬 深度调试

### 检查节点的 data 属性

在 Webview Console 中执行：
```javascript
// 打印所有文件夹节点
graph.nodes.filter(n => n.type === 'folder').forEach(n => {
    console.log('文件夹节点:', {
        label: n.label,
        path: n.data?.path,
        isRoot: n.data?.isRoot,
        type: n.type
    });
});
```

**预期输出**：
```javascript
文件夹节点: {
  label: "root-folder",
  path: "d:\\project\\root",
  isRoot: true,
  type: "folder"
}
文件夹节点: {
  label: "subfolder",
  path: "d:\\project\\root\\subfolder",
  isRoot: false,  // ✅ 子文件夹必须是 false
  type: "folder"
}
```

### 检查双击事件绑定

在 Webview Console 中执行：
```javascript
// 检查节点元素
const folderNodes = document.querySelectorAll('.node');
folderNodes.forEach((el, i) => {
    const id = el.dataset.id;
    const node = graph.nodes.find(n => n.id === id);
    if (node?.type === 'folder') {
        console.log(`节点 ${i}: ${node.label}`, {
            type: node.type,
            hasPath: !!node.data?.path,
            isRoot: node.data?.isRoot,
            hasListener: el.ondblclick !== null  // 检查是否绑定了事件
        });
    }
});
```

---

## 📝 自检清单

测试前请确认：

- [ ] 重新加载了 VS Code 窗口
- [ ] 打开了 **两个** 开发者工具（Webview + Extension Host）
- [ ] 打开了蓝图面板
- [ ] 能看到多个文件夹节点（至少一个根节点 + 一个子文件夹）
- [ ] 双击时**不移动鼠标**（避免触发拖拽）
- [ ] 双击的是**文件夹**节点（不是文件）

---

## 🎯 快速检测脚本

在 Webview Console 中执行以下脚本，一键检查所有条件：

```javascript
console.log('=== 下钻功能诊断 ===');
console.log('1. Graph Type:', graph?.metadata?.graphType);  // 应该是 "filetree"
console.log('2. 节点总数:', graph?.nodes?.length);

const folders = graph.nodes.filter(n => n.type === 'folder');
console.log('3. 文件夹节点数:', folders.length);

folders.forEach((n, i) => {
    console.log(`   文件夹 ${i}:`, {
        label: n.label,
        hasPath: !!n.data?.path,
        path: n.data?.path,
        isRoot: n.data?.isRoot,
        canDrill: !n.data?.isRoot && !!n.data?.path  // 可下钻条件
    });
});

console.log('4. 测试方法: 双击上面 canDrill=true 的文件夹');
console.log('===================');
```

**预期输出**：
```
=== 下钻功能诊断 ===
1. Graph Type: filetree
2. 节点总数: 15
3. 文件夹节点数: 3
   文件夹 0: {label: 'root', hasPath: true, path: 'd:\\...', isRoot: true, canDrill: false}
   文件夹 1: {label: 'src', hasPath: true, path: 'd:\\...\\src', isRoot: false, canDrill: true}  ← 可以双击
   文件夹 2: {label: 'docs', hasPath: true, path: 'd:\\...\\docs', isRoot: false, canDrill: true}  ← 可以双击
4. 测试方法: 双击上面 canDrill=true 的文件夹
===================
```

---

## 💡 最可能的问题

根据经验，最常见的问题是：

### 1. **拖拽事件拦截了双击**
- **现象**: 双击节点会轻微移动位置，但不下钻
- **原因**: `makeDraggable` 函数的 `pointermove` 事件拦截了 `dblclick`
- **解决**: 双击时完全不要移动鼠标

### 2. **路径格式错误**
- **现象**: 前端发送消息，后端报错
- **原因**: `n.data.path` 不是绝对路径
- **解决**: 检查 FileTreeScanner 生成的路径

### 3. **graphType 不匹配**
- **现象**: 双击完全没反应
- **原因**: `graph.metadata.graphType !== "filetree"`
- **解决**: 检查 scanPathShallow 是否设置了正确的 metadata

---

## 📚 相关代码位置

- **前端事件绑定**: `media/filetree-blueprint/graphView.js` 行 208-230
- **后端消息处理**: `src/features/filetree-blueprint/panel/BlueprintPanel.ts` 行 123-127
- **下钻实现**: `src/features/filetree-blueprint/panel/BlueprintPanel.ts` 行 203-242
- **节点数据生成**: `src/features/filetree-blueprint/domain/FileTreeScanner.ts` 行 153-197

---

## 🚀 下一步

1. 按照上面的步骤操作
2. 收集两个控制台的完整日志
3. 在 Webview Console 中运行诊断脚本
4. 如果还有问题，把日志和诊断结果发给我

祝调试顺利！🎉
