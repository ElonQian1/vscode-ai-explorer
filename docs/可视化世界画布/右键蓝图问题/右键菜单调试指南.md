# 右键菜单调试指南

## 🎯 预期行为
在 **AI 资源管理器** 中右键文件夹 → 选择"在此打开蓝图" → **直接打开该文件夹的蓝图**，不应弹出文件选择对话框。

---

## ✅ 已修复的内容

### 1. ExplorerTreeItem.ts
```typescript
// 已添加 resourceUri 属性
this.resourceUri = vscode.Uri.file(this.node.path);
```

### 2. package.json
```jsonc
// 已优化菜单条件，只在文件夹上显示
{
  "command": "filetreeBlueprint.openFromPath",
  "when": "view == aiExplorer && (viewItem == folder || viewItem == folderHasAlias)",
  "group": "navigation@17"
}
```

### 3. resolveTarget.ts
```typescript
// 已优化参数提取逻辑并添加调试日志
// 优先检查 resourceUri（TreeItem 对象）
if ((raw as any)?.resourceUri instanceof vscode.Uri) {
    uri = (raw as any).resourceUri as vscode.Uri;
    console.log('[resolveTargetToFileUri] 从 resourceUri 提取:', uri.toString());
}
```

---

## 🔍 调试步骤

### Step 1: 重新加载 VS Code
1. 按 `F1` 或 `Ctrl+Shift+P`
2. 输入并执行: `Developer: Reload Window`

### Step 2: 打开开发者工具
1. 按 `F1` 或 `Ctrl+Shift+P`
2. 输入并执行: `Developer: Toggle Developer Tools`
3. 切换到 **Console** 标签

### Step 3: 测试右键菜单
1. 在 **AI 资源管理器** 视图中找到任意文件夹
2. **右键点击** 文件夹
3. 选择 "**在此打开蓝图**"
4. 观察控制台输出

---

## 📊 预期的控制台日志

### ✅ 成功情况（应该看到）
```
[resolveTargetToFileUri] 接收参数类型: object
[resolveTargetToFileUri] 参数详情: {path: 'd:\\your-project\\some-folder', name: 'folder', type: 'directory', ...}
[resolveTargetToFileUri] path 属性: d:\your-project\some-folder
[resolveTargetToFileUri] 从 FileNode.path 提取: file:///d:/your-project/some-folder
已解析目标: /some-folder (d:\your-project\some-folder)
```

或者（如果传递的是 TreeItem）:
```
[resolveTargetToFileUri] 接收参数类型: object
[resolveTargetToFileUri] 参数详情: ExplorerTreeItem {...}
[resolveTargetToFileUri] resourceUri: file:///D:/your-project/some-folder
[resolveTargetToFileUri] 从 resourceUri 提取: file:///D:/your-project/some-folder
已解析目标: /some-folder (D:\your-project\some-folder)
```

### ❌ 失败情况（不应该看到）
```
[resolveTargetToFileUri] 接收参数类型: undefined
[resolveTargetToFileUri] 未检测到任何 URI，准备弹出选择框
未检测到文件上下文，请选择要生成蓝图的文件或文件夹
```

---

## 🐛 常见问题排查

### 问题 1: 仍然弹出文件选择对话框

**可能原因 A**: 既没有 resourceUri 也没有 path 属性
```bash
# 检查方法：查看控制台日志
# 如果看到 "未检测到任何 URI"，说明参数格式不对
```

**可能原因 B**: path 不是字符串或不是绝对路径
```bash
# 检查 FileNode 的 path 属性是否是完整的绝对路径
# 例如: "d:\\rust\\active-projects\\project\\folder"
```

**可能原因 C**: 菜单条件没有命中
```bash
# 检查方法：
1. F1 → "Developer: Inspect Context Keys"
2. 在 AI 资源管理器中点击文件夹
3. 查看：
   - view = "aiExplorer" ✅
   - viewItem = "folder" 或 "folderHasAlias" ✅
```

**可能原因 C**: 参数传递失败
```bash
# 查看控制台日志中的"接收参数类型"和"参数详情"
# 如果是 undefined，说明命令没有接收到 TreeItem
```

### 问题 2: 打开了错误的文件夹

**检查 resolveTargetToFileUri 的日志**:
- 提取的 URI 路径是否正确？
- focusPath 计算是否正确？

### 问题 3: 菜单项根本不显示

**检查 package.json 中的 when 条件**:
```jsonc
"when": "view == aiExplorer && (viewItem == folder || viewItem == folderHasAlias)"
```

**检查 ExplorerTreeItem.ts 中的 contextValue**:
```typescript
this.contextValue = this.node.type === 'file'
    ? (hasAlias ? 'fileHasAlias' : 'file')
    : (hasAlias ? 'folderHasAlias' : 'folder');
```

---

## 📝 自检清单

- [ ] 重新加载了 VS Code 窗口
- [ ] 打开了开发者工具控制台
- [ ] 右键点击文件夹时能看到"在此打开蓝图"菜单项
- [ ] 控制台显示正确的 resourceUri 日志
- [ ] 没有弹出文件选择对话框
- [ ] 蓝图面板打开的是正确的文件夹
- [ ] 面板标题显示正确的文件夹名

---

## 🎓 技术原理

### VS Code 右键菜单参数传递机制

VS Code 在调用命令时可能传递两种不同的参数：

**方式 1: 传递 TreeItem 对象**
```typescript
// TreeItem 提供 resourceUri
this.resourceUri = vscode.Uri.file(this.node.path);

// VS Code 调用命令
vscode.commands.executeCommand('command', treeItem);

// 命令处理器提取
const uri = (raw as any)?.resourceUri;
```

**方式 2: 传递原始 Element (FileNode)**
```typescript
// VS Code 有时会传递 TreeDataProvider 的 element
// 而不是 getTreeItem() 返回的 TreeItem

// FileNode 对象
{
  path: 'd:\\project\\folder',
  name: 'folder',
  type: 'directory',
  children: [...]
}

// 命令处理器需要提取 path 属性
if ((raw as any)?.path && typeof (raw as any).path === 'string') {
    const uri = vscode.Uri.file((raw as any).path);
}
```

**为什么会有两种方式？**

VS Code 的 TreeView 在不同场景下传递不同的参数：
- 通过 `command` 属性触发 → 通常传递 TreeItem
- 通过 `menus.view/item/context` 触发 → **可能传递原始 element**
- 通过代码调用 → 取决于传递的参数

**解决方案**：同时支持两种格式
```typescript
// 1. 优先检查 FileNode.path（AI 资源管理器）
if ((raw as any)?.path && (raw as any)?.type) {
    uri = vscode.Uri.file((raw as any).path);
}
// 2. 检查 TreeItem.resourceUri（标准方式）
else if ((raw as any)?.resourceUri instanceof vscode.Uri) {
    uri = (raw as any).resourceUri;
}
// 3. 检查直接传递的 Uri
else if (raw instanceof vscode.Uri) {
    uri = raw;
}
```

### 为什么需要 viewItem 条件？

如果没有 `viewItem` 限制，菜单会在所有节点上显示，包括：
- ❌ 文件节点（无法生成蓝图）
- ❌ 空白区域（没有上下文）
- ✅ 文件夹节点（正确）

添加条件后：
```jsonc
"when": "view == aiExplorer && (viewItem == folder || viewItem == folderHasAlias)"
```
菜单只在文件夹节点上显示，确保传递的是有效的文件夹 URI。

---

## 📚 相关文档

- [右键打开画面.md](./右键打开画面.md) - 原始问题描述与解决方案
- [文件夹下钻问题2.md](./文件夹下钻问题2.md) - 文件夹导航逻辑
- [VS Code TreeView API](https://code.visualstudio.com/api/extension-guides/tree-view)

---

## 🔄 如果问题仍然存在

请收集以下信息并提交问题：

1. **控制台完整日志** (从 Developer Tools)
2. **你右键的文件夹路径** (例如: `D:\project\src\features`)
3. **是否弹出了选择框** (是/否)
4. **VS Code 版本** (Help → About)
5. **扩展版本** (从 package.json 中的 version 字段)

然后在项目中创建 Issue 或在开发者工具中继续调试。
