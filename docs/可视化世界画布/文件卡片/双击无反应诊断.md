# ğŸ” åŒå‡»æ— ååº”é—®é¢˜è¯Šæ–­

**é—®é¢˜**: åŒå‡»æ–‡ä»¶å¤¹å’Œæ–‡ä»¶éƒ½æ²¡æœ‰ååº”  
**æ—¶é—´**: 2025-10-17  
**æ¶‰åŠæäº¤**: be16472 (Phase 7 - ä¿®å¤æ¶ˆæ¯ç›‘å¬å†²çª)

---

## é—®é¢˜åˆ†æ

### å†å²å›é¡¾

æ ¹æ® Git å†å²ï¼ŒåŒå‡»åŠŸèƒ½åœ¨ä»¥ä¸‹æäº¤ä¸­å®ç°/ä¿®å¤ï¼š

1. **1685bfb** - æ·»åŠ  `graphType` å…ƒæ•°æ®ï¼Œä¿®å¤åŒå‡»ä¸‹é’»
2. **02bf308** - ä¿®å¤åŒå‡»æ–‡ä»¶ï¼Œå®ç°ä¹è§‚ UI

### åŒå‡»äº‹ä»¶ç»‘å®šæµç¨‹

```
1. graphView.js åŠ è½½ â†’ init()
2. init() â†’ notifyReady()
3. notifyReady() â†’ å‘é€ 'webview-ready'
4. Extension æ”¶åˆ° â†’ å‘é€ 'init-graph'
5. handleMessage() æ”¶åˆ° 'init-graph'
6. â†’ renderNodesOnce() â†’ ç»‘å®šåŒå‡»äº‹ä»¶
```

### å…³é”®ä»£ç 

**åŒå‡»æ–‡ä»¶å¤¹ï¼ˆgraphView.js 270-295 è¡Œï¼‰**ï¼š
```javascript
if (n.type === "folder" && n.data?.path && graph?.metadata?.graphType === "filetree") {
    if (n.data?.isRoot) {
        el.addEventListener("dblclick", () => {
            console.log('[åŒå‡»] æ ¹èŠ‚ç‚¹ï¼Œå‘é€ drill-up:', n.data.path);
            vscode.postMessage({ type: "drill-up", payload: { path: n.data.path } });
        });
    } else {
        el.addEventListener("dblclick", () => {
            console.log('[åŒå‡»] å­æ–‡ä»¶å¤¹ï¼Œå‘é€ drill:', n.data.path);
            vscode.postMessage({ type: "drill", payload: { path: n.data.path } });
        });
    }
}
```

**åŒå‡»æ–‡ä»¶ï¼ˆgraphView.js 313-335 è¡Œï¼‰**ï¼š
```javascript
if (n.type === "file" && n.data?.path && graph?.metadata?.graphType === "filetree") {
    el.addEventListener("dblclick", (e) => {
        e.stopPropagation();
        const filePath = n.data.absPath || n.data.path;
        console.log('[åŒå‡»] æ–‡ä»¶ï¼Œè¯·æ±‚åˆ†æ:', filePath);
        vscode.postMessage({
            type: "analyze-file",
            payload: { path: filePath, nodeId: n.id, position: n.position }
        });
    });
}
```

---

## å¯èƒ½çš„æ ¹å› 

### 1. `renderNodesOnce()` æœªè¢«è°ƒç”¨

**æ£€æŸ¥ç‚¹**ï¼š
- `init-graph` æ¶ˆæ¯æ˜¯å¦å‘é€ï¼Ÿ
- `handleMessage()` æ˜¯å¦æ”¶åˆ°ï¼Ÿ

### 2. `graph` å¯¹è±¡ä¸ºç©ºæˆ–ç¼ºå°‘ `metadata.graphType`

**æ£€æŸ¥ç‚¹**ï¼š
- `graph?.metadata?.graphType === "filetree"` æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Ÿ

### 3. èŠ‚ç‚¹æ•°æ®ç¼ºå¤±

**æ£€æŸ¥ç‚¹**ï¼š
- `n.data?.path` æ˜¯å¦å­˜åœ¨ï¼Ÿ
- `n.type` æ˜¯å¦æ­£ç¡®ï¼ˆ"file" æˆ– "folder"ï¼‰ï¼Ÿ

### 4. äº‹ä»¶ç›‘å¬å™¨è¢«ç§»é™¤æˆ–è¦†ç›–

**æ£€æŸ¥ç‚¹**ï¼š
- DOM èŠ‚ç‚¹æ˜¯å¦è¢«é‡æ–°åˆ›å»ºï¼Ÿ
- æ˜¯å¦æœ‰å…¶ä»–ä»£ç ç§»é™¤äº†ç›‘å¬å™¨ï¼Ÿ

---

## ğŸ§ª è¯Šæ–­æ­¥éª¤

### Step 1: æ‰“å¼€ Webview å¼€å‘è€…å·¥å…·

```
Ctrl+Shift+P â†’ "Open Webview Developer Tools"
```

### Step 2: æ£€æŸ¥åˆå§‹åŒ–æ—¥å¿—

**é¢„æœŸæ—¥å¿—**ï¼š
```javascript
[graphView] ğŸ‰ Webview å·²å°±ç»ªï¼Œå‘é€ ready ä¿¡å·
[æ¨¡å—] AnalysisCardManager å·²åŠ è½½
Rendering graph: <å·¥ä½œåŒºåç§°> { nodes: [...], edges: [...], metadata: {...} }
```

**ğŸ”´ å¦‚æœæ²¡æœ‰ "Rendering graph" æ—¥å¿—**ï¼š
- â†’ `init-graph` æ¶ˆæ¯æœªæ”¶åˆ°
- â†’ æ£€æŸ¥æ‰©å±•ç«¯æ˜¯å¦å‘é€äº†æ¶ˆæ¯

### Step 3: æ£€æŸ¥ graph å¯¹è±¡

**åœ¨ Console è¾“å…¥**ï¼š
```javascript
graph
```

**é¢„æœŸè¾“å‡º**ï¼š
```javascript
{
  nodes: [...],
  edges: [...],
  metadata: {
    graphType: "filetree",  // âœ… å¿…é¡»å­˜åœ¨
    workspaceRoot: "...",
    scanMode: "shallow" | "deep"
  }
}
```

**ğŸ”´ å¦‚æœ `metadata.graphType` ä¸æ˜¯ "filetree"**ï¼š
- â†’ åŒå‡»äº‹ä»¶ä¸ä¼šç»‘å®š
- â†’ æ£€æŸ¥ FileTreeScanner.ts æ˜¯å¦è®¾ç½®äº† graphType

### Step 4: æ£€æŸ¥èŠ‚ç‚¹ç»‘å®šæƒ…å†µ

**åœ¨ Console è¾“å…¥**ï¼š
```javascript
// æ£€æŸ¥æ–‡ä»¶èŠ‚ç‚¹
document.querySelectorAll('.node[data-type="file"]').forEach(el => {
    const listeners = getEventListeners(el);
    console.log(el.textContent, 'dblclick ç›‘å¬å™¨æ•°é‡:', listeners.dblclick?.length || 0);
});

// æ£€æŸ¥æ–‡ä»¶å¤¹èŠ‚ç‚¹
document.querySelectorAll('.node[data-type="folder"]').forEach(el => {
    const listeners = getEventListeners(el);
    console.log(el.textContent, 'dblclick ç›‘å¬å™¨æ•°é‡:', listeners.dblclick?.length || 0);
});
```

**é¢„æœŸè¾“å‡º**ï¼š
```
main.tsx dblclick ç›‘å¬å™¨æ•°é‡: 1
src dblclick ç›‘å¬å™¨æ•°é‡: 1
components dblclick ç›‘å¬å™¨æ•°é‡: 1
...
```

**ğŸ”´ å¦‚æœç›‘å¬å™¨æ•°é‡ä¸º 0**ï¼š
- â†’ `renderNodesOnce()` æœªæ‰§è¡Œ
- â†’ æˆ–ç»‘å®šæ¡ä»¶ä¸æ»¡è¶³

### Step 5: æ‰‹åŠ¨æµ‹è¯•åŒå‡»

**åœ¨ Console è¾“å…¥**ï¼š
```javascript
// æ‰‹åŠ¨è§¦å‘åŒå‡»äº‹ä»¶
const fileNode = document.querySelector('.node[data-type="file"]');
fileNode.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
```

**é¢„æœŸç»“æœ**ï¼š
- Webview æ§åˆ¶å°åº”æ‰“å°ï¼š`[åŒå‡»] æ–‡ä»¶ï¼Œè¯·æ±‚åˆ†æ: ...`
- æˆ–ï¼š`[åŒå‡»] å­æ–‡ä»¶å¤¹ï¼Œå‘é€ drill: ...`

**ğŸ”´ å¦‚æœæ²¡æœ‰æ—¥å¿—**ï¼š
- â†’ ç›‘å¬å™¨ç¡®å®æœªç»‘å®š

### Step 6: æ£€æŸ¥è¯Šæ–­æ—¥å¿—

**æœç´¢ Console ä¸­çš„**ï¼š
```
[è¯Šæ–­] æ–‡ä»¶èŠ‚ç‚¹
[ç»‘å®š] ä¸ºæ–‡ä»¶
```

**é¢„æœŸè¾“å‡º**ï¼š
```javascript
[è¯Šæ–­] æ–‡ä»¶èŠ‚ç‚¹ "main.tsx": {
  nodeType: "file",
  hasPath: true,
  graphType: "filetree",
  expectedGraphType: "filetree",
  graphTypeMatch: true,
  willBindDoubleClick: true
}
[ç»‘å®š] ä¸ºæ–‡ä»¶ "main.tsx" ç»‘å®šåŒå‡»äº‹ä»¶
```

**ğŸ”´ å¦‚æœ `willBindDoubleClick: false`**ï¼š
- â†’ æŸ¥çœ‹å“ªä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼ˆnodeType, hasPath, graphTypeMatchï¼‰

---

## ğŸ”§ å¯èƒ½çš„ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: ç¡®ä¿ `init-graph` æ¶ˆæ¯å‘é€

**æ£€æŸ¥ BlueprintPanel.ts**ï¼š
```typescript
case 'webview-ready':
    await this.handleWebviewReady();
    // âœ… åº”è¯¥åœ¨è¿™é‡Œå‘é€ init-graph
    if (this.currentGraph) {
        await this.safePostMessage({
            type: 'init-graph',
            payload: this.currentGraph
        });
    }
    break;
```

### ä¿®å¤ 2: ç¡®ä¿ graphType å­˜åœ¨

**æ£€æŸ¥ FileTreeScanner.ts**ï¼š
```typescript
return {
    id: `filetree-${Date.now()}`,
    title: workspaceName,
    nodes,
    edges,
    metadata: {
        graphType: 'filetree',  // âœ… å¿…é¡»è®¾ç½®
        workspaceRoot: targetPath,
        scanMode: 'shallow'
    }
};
```

### ä¿®å¤ 3: æ·»åŠ  DOMContentLoaded æ£€æŸ¥

**graphView.js**ï¼š
```javascript
function init() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            notifyReady();
        });
    } else {
        setupEventListeners();
        notifyReady();
    }
}
```

### ä¿®å¤ 4: æ‰‹åŠ¨é‡æ–°ç»‘å®šäº‹ä»¶

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**ï¼ˆåœ¨ Console è¿è¡Œï¼‰ï¼š
```javascript
// å¼ºåˆ¶é‡æ–°æ¸²æŸ“å’Œç»‘å®š
if (graph && graph.metadata?.graphType === 'filetree') {
    console.log('æ‰‹åŠ¨é‡æ–°ç»‘å®šåŒå‡»äº‹ä»¶...');
    
    document.querySelectorAll('.node').forEach(el => {
        const nodeId = el.getAttribute('data-node-id');
        const node = graph.nodes.find(n => n.id === nodeId);
        
        if (!node) return;
        
        // ç§»é™¤æ—§ç›‘å¬å™¨
        const newEl = el.cloneNode(true);
        el.parentNode.replaceChild(newEl, el);
        
        // é‡æ–°ç»‘å®š
        if (node.type === 'file' && node.data?.path) {
            newEl.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                const filePath = node.data.absPath || node.data.path;
                console.log('[åŒå‡»] æ–‡ä»¶ï¼Œè¯·æ±‚åˆ†æ:', filePath);
                vscode.postMessage({
                    type: 'analyze-file',
                    payload: { path: filePath }
                });
            });
            console.log('âœ… å·²ç»‘å®šæ–‡ä»¶:', node.label);
        } else if (node.type === 'folder' && node.data?.path) {
            newEl.addEventListener('dblclick', () => {
                const msgType = node.data.isRoot ? 'drill-up' : 'drill';
                console.log(`[åŒå‡»] ${node.data.isRoot ? 'æ ¹' : 'å­'}æ–‡ä»¶å¤¹ï¼Œå‘é€ ${msgType}:`, node.data.path);
                vscode.postMessage({
                    type: msgType,
                    payload: { path: node.data.path }
                });
            });
            console.log('âœ… å·²ç»‘å®šæ–‡ä»¶å¤¹:', node.label);
        }
    });
    
    console.log('âœ… æ‰‹åŠ¨ç»‘å®šå®Œæˆï¼è¯·å°è¯•åŒå‡»èŠ‚ç‚¹ã€‚');
} else {
    console.error('âŒ graph å¯¹è±¡æ— æ•ˆæˆ– graphType ä¸æ­£ç¡®:', graph?.metadata);
}
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹æ£€æŸ¥ï¼Œæ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼š

- [ ] Webview æ§åˆ¶å°æœ‰ "Rendering graph" æ—¥å¿—
- [ ] `graph` å¯¹è±¡å­˜åœ¨ä¸” `metadata.graphType === "filetree"`
- [ ] èŠ‚ç‚¹æœ‰ `dblclick` ç›‘å¬å™¨ï¼ˆé€šè¿‡ `getEventListeners()` æ£€æŸ¥ï¼‰
- [ ] è¯Šæ–­æ—¥å¿—æ˜¾ç¤º `willBindDoubleClick: true`
- [ ] æ‰‹åŠ¨è§¦å‘ `dblclick` äº‹ä»¶æœ‰ååº”
- [ ] æ‰©å±•ç«¯æ”¶åˆ°äº† `webview-ready` æ¶ˆæ¯
- [ ] æ‰©å±•ç«¯å‘é€äº† `init-graph` æ¶ˆæ¯

---

## ğŸ¯ æœ€å¯èƒ½çš„åŸå› 

æ ¹æ® Phase 7 çš„ä¿®æ”¹ï¼ˆåˆ é™¤ entry.jsï¼‰ï¼Œæœ€å¯èƒ½çš„åŸå› æ˜¯ï¼š

### **`init-graph` æ¶ˆæ¯æœªå‘é€æˆ–æœªæ”¶åˆ°**

**ä¸ºä»€ä¹ˆ**ï¼š
1. Phase 7 åˆ é™¤äº† entry.js
2. ä¿®æ”¹äº† `handleWebviewReady()` çš„å®ç°
3. å¯èƒ½ `this.currentGraph` åœ¨ ready æ—¶ä¸º undefined

**éªŒè¯æ–¹æ³•**ï¼š
1. åœ¨ Webview æ§åˆ¶å°æœç´¢ "Rendering graph"
2. å¦‚æœæ²¡æœ‰ â†’ `init-graph` æœªæ”¶åˆ°
3. æ£€æŸ¥æ‰©å±•ç«¯æ—¥å¿—æ˜¯å¦æœ‰ "æ˜¾ç¤ºè“å›¾" æˆ– "postMessage: init-graph"

**ä¿®å¤æ–¹æ³•**ï¼š
- ç¡®ä¿ `handleWebviewReady()` åœ¨æ”¶åˆ° ready åé‡æ–°å‘é€ `init-graph`
- æˆ–åœ¨ `showGraph()` æ—¶æ£€æŸ¥ `webviewReady` çŠ¶æ€

---

**ä¸‹ä¸€æ­¥**: æŒ‰ç…§è¯Šæ–­æ­¥éª¤æ‰§è¡Œï¼Œæ‰¾å‡ºå…·ä½“æ˜¯å“ªä¸ªç¯èŠ‚å‡ºäº†é—®é¢˜ã€‚
