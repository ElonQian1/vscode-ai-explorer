# 🔍 双击文件显示卡片 - 完整自检指南

**目的**: 验证 Phase 7 修复是否成功  
**测试时间**: < 5 分钟

---

## 🚀 准备工作

1. **确保扩展已编译**
   ```bash
   npm run compile
   ```
   ✅ 应该没有错误

2. **F5 重启扩展**
   - 按 F5 启动调试
   - 等待新的 VS Code 窗口打开

---

## ✅ 测试检查清单

### Step 1: 打开蓝图视图

**操作**：
- Ctrl+Shift+P → 输入 "文件树蓝图"
- 或使用命令：`文件树蓝图: 显示当前文件夹`

**预期结果**：
- ✅ 看到文件树可视化
- ✅ 节点按类型显示（文件夹/文件）
- ✅ 边显示依赖关系

---

### Step 2: 打开 Webview 开发者工具

**操作**：
- Ctrl+Shift+P → 输入 "Open Webview Developer Tools"
- 或右键蓝图面板 → "打开开发者工具"

**预期日志（Console 标签）**：
```
[模块] AnalysisCardManager 已加载
[graphView] 🎉 Webview 已就绪，发送 ready 信号
Rendering graph: <工作区名称> ...
```

**🔴 如果看不到这些日志**：
- 检查是否打开了正确的开发者工具（应该是 Webview 的，不是扩展的）
- 刷新 Webview（Ctrl+R 或 Cmd+R）

---

### Step 3: 查看扩展端日志

**操作**：
- 在原始 VS Code 窗口（不是调试窗口）
- 打开 "调试控制台"（Debug Console）
- 或 "输出"（Output）面板，选择 "扩展主机"

**预期日志**：
```
[INFO] [UI] 🎉 Webview 已就绪，开始发送排队消息: 0 条
[INFO] 显示蓝图: <工作区名称> (X 个节点)
```

**🔴 如果看不到 "Webview 已就绪"**：
- graphView.js 可能没有正确加载
- 检查 HTML 脚本注入顺序

---

### Step 4: 双击文件节点（关键测试！）

**操作**：
- 在蓝图视图中找一个 `.ts` 或 `.tsx` 文件
- **双击**该节点

**预期结果**：

#### A. Webview 控制台（< 100ms）
```
[graphView] 📨 收到 show-analysis-card: /src/main.tsx { hasContent: true, loading: true, hasCardManager: true }
[AnalysisCardManager] 显示卡片: /src/main.tsx
[AnalysisCardManager] 卡片已添加到 DOM
[graphView] ✅ 卡片渲染成功，发送 ACK
```

#### B. 扩展端日志（< 100ms）
```
[DEBUG] 收到 Webview 消息: analyze-file
[INFO] [分析文件] 收到请求, path=/src/main.tsx
[INFO] [FileAnalysisService] 静态分析: /src/main.tsx
[DEBUG] [UI] postMessage: show-analysis-card ✅ (有payload)
[INFO] [UI] 已发送静态分析卡片: /src/main.tsx
[INFO] [ACK] Webview 已显示卡片: /src/main.tsx
```

#### C. 屏幕显示（< 100ms）
- ✅ 看到白底卡片从右上角滑入
- ✅ 卡片有阴影和圆角
- ✅ 卡片显示文件路径和概览信息
- ✅ 有 "loading..." 或加载动画

**🔴 如果看不到卡片**：
- 检查 Webview 控制台是否有错误
- 检查是否有 `[graphView] ❌` 开头的错误日志
- 检查 `window.cardManager` 是否已初始化：在 Console 输入 `window.cardManager`

---

### Step 5: 等待 AI 增强（2-5 秒）

**预期结果**：

#### A. Webview 控制台
```
[graphView] 📨 收到 update-analysis-card: /src/main.tsx { hasAI: true }
[AnalysisCardManager] 更新卡片: /src/main.tsx
[AnalysisCardManager] 更新内容区域
[graphView] ✅ 卡片更新成功
```

#### B. 扩展端日志
```
[INFO] [AI] 开始后台AI分析: /src/main.tsx
[INFO] [FileAnalysisService] AI增强分析: /src/main.tsx
[INFO] [LLMAnalyzer] 开始AI分析: /src/main.tsx
[INFO] [LLMAnalyzer] AI分析完成: /src/main.tsx (耗时: 2.3s)
[DEBUG] [UI] postMessage: update-analysis-card ✅ (有payload)
[INFO] [UI] 已发送AI增强结果: /src/main.tsx
```

#### C. 屏幕显示
- ✅ 卡片内容自动更新（无闪烁）
- ✅ 显示 AI 生成的摘要
- ✅ "loading..." 消失
- ✅ 显示更多细节（依赖、导出等）

---

### Step 6: 交互测试

#### A. 点击遮罩关闭卡片
**操作**：点击卡片外的灰色遮罩  
**预期**：卡片平滑关闭，遮罩消失

#### B. 拖拽卡片
**操作**：按住卡片标题栏拖动  
**预期**：卡片跟随鼠标移动（如果已实现）

#### C. 双击另一个文件
**操作**：关闭当前卡片，双击另一个文件  
**预期**：
- 旧卡片关闭
- 新卡片显示
- 流程同 Step 4-5

---

## 🐛 常见问题排查

### 问题 1: 看不到 "Webview 已就绪" 日志

**可能原因**：
- graphView.js 未加载
- 脚本执行出错

**排查步骤**：
1. Webview 开发者工具 → Console 标签
2. 看是否有红色错误
3. 检查 Sources 标签，graphView.js 是否存在
4. 刷新 Webview（Ctrl+R）

---

### 问题 2: 双击后无任何反应

**可能原因**：
- 双击事件未绑定
- `analyze-file` 消息未发送

**排查步骤**：
1. Webview 控制台输入：
   ```javascript
   vscode.postMessage({ type: 'analyze-file', payload: { path: '/src/main.tsx' }})
   ```
2. 看扩展端是否收到消息
3. 如果收到 → 双击监听问题
4. 如果未收到 → `vscode` 对象未初始化

---

### 问题 3: 双击后扩展端有日志，但无卡片

**可能原因**：
- `window.cardManager` 未初始化
- analysisCard.js 未加载
- 消息被 entry.js 拦截（应该已删除）

**排查步骤**：
1. Webview 控制台输入 `window.cardManager`
2. 如果是 `undefined` → analysisCard.js 未加载
3. 检查 HTML 是否注入了 analysisCard.js
4. 检查 Console 是否有 `[模块] AnalysisCardManager 已加载`

---

### 问题 4: 卡片显示但看不见（只有遮罩）

**可能原因**：
- CSS 层级问题
- 卡片透明度为 0
- 卡片位置在屏幕外

**排查步骤**：
1. Webview 开发者工具 → Elements 标签
2. 找到 `.analysis-card` 元素
3. 检查样式：
   - `z-index` 应该 > 遮罩
   - `opacity` 应该是 1
   - `display` 不应该是 `none`
4. 手动修改样式测试

---

### 问题 5: AI 分析一直 loading

**可能原因**：
- API Key 未配置
- 网络问题
- AI 服务超时

**排查步骤**：
1. 检查扩展端日志是否有 AI 错误
2. 配置 API Key：Ctrl+Shift+P → "设置 API Key"
3. 查看是否有网络错误
4. 等待超时（30s），应该显示降级的静态结果

---

## ✅ 成功标准

**全部通过以下检查**：

- [ ] Webview 开发者工具显示 "Webview 已就绪"
- [ ] 扩展端日志显示 "Webview 已就绪，开始发送排队消息"
- [ ] 双击文件后 < 100ms 看到白底卡片
- [ ] Webview 控制台有 "收到 show-analysis-card" 日志
- [ ] 扩展端收到 "[ACK] Webview 已显示卡片" 确认
- [ ] 2-5 秒后卡片自动更新（显示 AI 内容）
- [ ] 点击遮罩可以关闭卡片
- [ ] 双击多个文件都能正常显示卡片
- [ ] 无红色错误日志

---

## 🎯 如果全部通过

**恭喜！Phase 7 修复成功！** 🎉

现在你可以：
1. **正常使用**文件分析功能
2. **继续开发**其他功能（如批量分析）
3. **优化体验**（动画、样式等）

---

## 📞 如果仍有问题

请收集以下信息：

1. **Webview 控制台截图**（完整日志）
2. **扩展端日志**（从打开蓝图到双击的全部日志）
3. **复现步骤**
4. **VS Code 版本**
5. **操作系统**

然后重新分析问题根因。

---

**祝测试顺利！** 🚀
