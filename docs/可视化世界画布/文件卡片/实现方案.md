# æ–‡ä»¶åˆ†æå¡ç‰‡è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

1. **åŒå‡»æ–‡ä»¶èŠ‚ç‚¹** â†’ å±•å¼€ä¸ºåˆ†æå¡ç‰‡ï¼ˆTabå¼ï¼‰
2. **ç¼“å­˜åˆ†æç»“æœ** â†’ ä¸º MCP é¢„çƒ­ï¼Œå‡å°‘é‡å¤åˆ†æ
3. **å¯è¿½æº¯è¯æ®** â†’ æ¯æ¡ç»“è®ºéƒ½æœ‰æºç é”šç‚¹
4. **å¯æŠ˜å åˆ‡æ¢** â†’ ç®€çº¦æ ·å¼ â†” è¯¦ç»†å¡ç‰‡

---

## ğŸ“‹ FileCapsule æ•°æ®ç»“æ„

```typescript
interface FileCapsule {
    version: "1.0";
    file: string;              // ç»å¯¹è·¯å¾„
    lang: string;              // ts/js/rs/py
    contentHash: string;       // sha256
    
    // æ¦‚è§ˆ
    summary: {
        zh: string;            // ä¸€å¥è¯è¯´æ˜
        en: string;
    };
    
    // APIï¼ˆå¯¼å‡ºç¬¦å·ï¼‰
    api: Array<{
        name: string;
        kind: 'function' | 'class' | 'type' | 'const' | 'interface';
        signature: string;
        evidence: string[];    // è¯æ®ID
    }>;
    
    // ä¾èµ–
    deps: {
        out: Array<{           // å‡ºä¾èµ–ï¼ˆå®ƒimportäº†è°ï¼‰
            module: string;
            count: number;
            evidence: string[];
        }>;
        inSample?: Array<{     // å…¥ä¾èµ–æ ·æœ¬ï¼ˆè°å¼•ç”¨äº†å®ƒï¼‰
            file: string;
            line: number;
            evidence: string[];
        }>;
    };
    
    // äº‹å®ï¼ˆå¯è¯ï¼‰
    facts: Array<{
        id: string;
        text: string;
        evidence: string[];
    }>;
    
    // æ¨æ–­ï¼ˆLLMï¼‰
    inferences: Array<{
        id: string;
        text: string;
        confidence: number;    // 0-1
        evidence: string[];
    }>;
    
    // å»ºè®®ï¼ˆæ”¹è¿›ï¼‰
    recommendations?: Array<{
        id: string;
        text: string;
        reason: string;
        evidence: string[];
    }>;
    
    // è¯æ®åº“
    evidence: {
        [id: string]: {
            file: string;
            lines: [number, number];
            sha256: string;
        };
    };
    
    // å…ƒä¿¡æ¯
    stale: boolean;
    lastVerifiedAt: string;   // ISO 8601
    tooling?: {
        tsc?: string;
        tsserver?: string;
    };
}
```

---

## ğŸ¨ UI è®¾è®¡

### å¡ç‰‡å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ user.ts                    [ğŸ“‚][â†»][âœ•] â”‚ â† æ ‡é¢˜æ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [æ¦‚è§ˆ] [API] [ä¾èµ–] [è¯æ®] [é£é™©]        â”‚ â† Tabæ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Tab å†…å®¹åŒºåŸŸ                             â”‚
â”‚                                          â”‚
â”‚  - æ”¯æŒæ»šåŠ¨                               â”‚
â”‚  - è¯æ®é”šç‚¹å¯ç‚¹å‡»è·³è½¬                      â”‚
â”‚  - ä»£ç ç‰‡æ®µé«˜äº®æ˜¾ç¤º                        â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tab å†…å®¹

#### 1. æ¦‚è§ˆ Tab
- **ä¸€å¥è¯è¯´æ˜**ï¼ˆä¸­è‹±æ–‡ï¼‰
- **ä¸»è¦èŒè´£**ï¼ˆ3-6æ¡ï¼‰
- **æ¨¡å—è§’è‰²**ï¼ˆController/Service/Repository ç­‰ï¼‰
- **ç½®ä¿¡åº¦** & **æœ€åéªŒè¯æ—¶é—´**

#### 2. API Tab
- **å¯¼å‡ºåˆ—è¡¨**ï¼ˆå‡½æ•°ã€ç±»ã€ç±»å‹ï¼‰
- æ¯é¡¹å¸¦ç­¾å + è¯æ®é”šç‚¹
- æŒ‰ç±»å‹åˆ†ç»„

#### 3. ä¾èµ– Tab
- **å‡ºä¾èµ–**ï¼ˆTop 10ï¼ŒæŒ‰å¼•ç”¨æ¬¡æ•°æ’åºï¼‰
- **å…¥ä¾èµ–**ï¼ˆæ ·æœ¬5æ¡ + "æ›´å¤š..."ï¼‰
- ä¾èµ–å›¾ï¼ˆå¯é€‰ï¼‰

#### 4. è¯æ® Tab
- æ‰€æœ‰è¯æ®ç´¢å¼•
- ç‚¹å‡»å±•å¼€ä»£ç ç‰‡æ®µ
- è·³è½¬åˆ°æºæ–‡ä»¶

#### 5. é£é™© Tabï¼ˆå¯é€‰ï¼‰
- TODO/FIXME
- æœªä½¿ç”¨å¯¼å‡º
- é«˜å¤æ‚åº¦
- å¾ªç¯ä¾èµ–

---

## ğŸ”§ å®ç°è·¯å¾„

### é˜¶æ®µ 1ï¼šå‰ç«¯äº¤äº’ï¼ˆæœ¬å‘¨ï¼‰

**æ–‡ä»¶**ï¼š`media/filetree-blueprint/graphView.js`

1. ç»™æ–‡ä»¶èŠ‚ç‚¹ç»‘å®šåŒå‡»äº‹ä»¶
2. å‘é€ `analyze-file` æ¶ˆæ¯
3. æ¥æ”¶ `show-analysis-card` æ¶ˆæ¯
4. æ¸²æŸ“å¡ç‰‡ï¼ˆTabåˆ‡æ¢ã€è¯æ®è·³è½¬ï¼‰
5. æŠ˜å /å±•å¼€åˆ‡æ¢

### é˜¶æ®µ 2ï¼šé™æ€åˆ†ææœåŠ¡ï¼ˆæœ¬å‘¨ï¼‰

**æ–‡ä»¶**ï¼š`src/features/file-analysis/StaticAnalyzer.ts`ï¼ˆæ–°å»ºï¼‰

åŠŸèƒ½ï¼š
- è§£æ TypeScript/JavaScriptï¼ˆä½¿ç”¨ ts-morphï¼‰
- æå–å¯¼å‡ºç¬¦å·ï¼ˆå‡½æ•°ã€ç±»ã€ç±»å‹ï¼‰
- åˆ†æä¾èµ–å…³ç³»ï¼ˆimport/exportï¼‰
- ç”Ÿæˆè¯æ®åæ ‡

### é˜¶æ®µ 3ï¼šLLM å¢å¼ºæœåŠ¡ï¼ˆä¸‹å‘¨ï¼‰

**æ–‡ä»¶**ï¼š`src/features/file-analysis/LLMAnalyzer.ts`ï¼ˆæ–°å»ºï¼‰

åŠŸèƒ½ï¼š
- è°ƒç”¨ OpenAI API ç”Ÿæˆæ‘˜è¦
- æ¨æ–­æ¨¡å—è§’è‰²
- ç”Ÿæˆæ”¹è¿›å»ºè®®
- å¸¦ confidence è¯„åˆ†

### é˜¶æ®µ 4ï¼šç¼“å­˜å±‚ï¼ˆä¸‹å‘¨ï¼‰

**æ–‡ä»¶**ï¼š`src/features/file-analysis/CapsuleCache.ts`ï¼ˆæ–°å»ºï¼‰

åŠŸèƒ½ï¼š
- åŸºäº contentHash çš„ç¼“å­˜é”®
- å¤±æ•ˆæ£€æµ‹ï¼ˆæ–‡ä»¶æ”¹åŠ¨ï¼‰
- LRU æ·˜æ±°ç­–ç•¥
- SQLite å­˜å‚¨ï¼ˆå¯é€‰ï¼‰

### é˜¶æ®µ 5ï¼šMCP é›†æˆï¼ˆåç»­ï¼‰

**æ–‡ä»¶**ï¼š`src/mcp/FileCapsuleServer.ts`ï¼ˆæ–°å»ºï¼‰

æš´éœ²å·¥å…·ï¼š
- `get_capsule(file)` â†’ è¿”å› FileCapsule
- `list_capsules(query)` â†’ æœç´¢æ ‡é¢˜å¡
- `find_evidence(locators)` â†’ è¿”å›ä»£ç ç‰‡æ®µ
- `verify_facts(file)` â†’ åˆ·æ–°åˆ†æ

---

## ğŸ“ æ–‡ä»¶ç»“æ„ï¼ˆæ–°å¢ï¼‰

```
src/
  features/
    file-analysis/           # æ–°å»ºæ¨¡å—
      FileAnalysisModule.ts  # æ¨¡å—å…¥å£
      StaticAnalyzer.ts      # é™æ€åˆ†æ
      LLMAnalyzer.ts         # LLMå¢å¼º
      CapsuleCache.ts        # ç¼“å­˜ç®¡ç†
      types.ts               # FileCapsule ç­‰ç±»å‹å®šä¹‰
      
media/
  filetree-blueprint/
    graphView.js             # ä¿®æ”¹ï¼šæ·»åŠ æ–‡ä»¶åŒå‡»
    analysisCard.css         # æ–°å»ºï¼šå¡ç‰‡æ ·å¼
    
docs/
  å¯è§†åŒ–ä¸–ç•Œç”»å¸ƒ/
    æ–‡ä»¶å¡ç‰‡/
      å®ç°æ–¹æ¡ˆ.md            # æœ¬æ–‡æ¡£
```

---

## ğŸ¬ ç¬¬ä¸€æ­¥ï¼šå‰ç«¯ç»‘å®š

ç«‹å³å¼€å§‹å®ç°æ–‡ä»¶åŒå‡» â†’ è¯·æ±‚åˆ†æ â†’ æ˜¾ç¤ºå¡ç‰‡
