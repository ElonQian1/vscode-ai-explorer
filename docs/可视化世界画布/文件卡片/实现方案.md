# 文件分析卡片设计方案

## 🎯 核心目标

1. **双击文件节点** → 展开为分析卡片（Tab式）
2. **缓存分析结果** → 为 MCP 预热，减少重复分析
3. **可追溯证据** → 每条结论都有源码锚点
4. **可折叠切换** → 简约样式 ↔ 详细卡片

---

## 📋 FileCapsule 数据结构

```typescript
interface FileCapsule {
    version: "1.0";
    file: string;              // 绝对路径
    lang: string;              // ts/js/rs/py
    contentHash: string;       // sha256
    
    // 概览
    summary: {
        zh: string;            // 一句话说明
        en: string;
    };
    
    // API（导出符号）
    api: Array<{
        name: string;
        kind: 'function' | 'class' | 'type' | 'const' | 'interface';
        signature: string;
        evidence: string[];    // 证据ID
    }>;
    
    // 依赖
    deps: {
        out: Array<{           // 出依赖（它import了谁）
            module: string;
            count: number;
            evidence: string[];
        }>;
        inSample?: Array<{     // 入依赖样本（谁引用了它）
            file: string;
            line: number;
            evidence: string[];
        }>;
    };
    
    // 事实（可证）
    facts: Array<{
        id: string;
        text: string;
        evidence: string[];
    }>;
    
    // 推断（LLM）
    inferences: Array<{
        id: string;
        text: string;
        confidence: number;    // 0-1
        evidence: string[];
    }>;
    
    // 建议（改进）
    recommendations?: Array<{
        id: string;
        text: string;
        reason: string;
        evidence: string[];
    }>;
    
    // 证据库
    evidence: {
        [id: string]: {
            file: string;
            lines: [number, number];
            sha256: string;
        };
    };
    
    // 元信息
    stale: boolean;
    lastVerifiedAt: string;   // ISO 8601
    tooling?: {
        tsc?: string;
        tsserver?: string;
    };
}
```

---

## 🎨 UI 设计

### 卡片布局

```
┌─────────────────────────────────────────┐
│ 📄 user.ts                    [📂][↻][✕] │ ← 标题栏
├─────────────────────────────────────────┤
│ [概览] [API] [依赖] [证据] [风险]        │ ← Tab栏
├─────────────────────────────────────────┤
│                                          │
│  Tab 内容区域                             │
│                                          │
│  - 支持滚动                               │
│  - 证据锚点可点击跳转                      │
│  - 代码片段高亮显示                        │
│                                          │
└─────────────────────────────────────────┘
```

### Tab 内容

#### 1. 概览 Tab
- **一句话说明**（中英文）
- **主要职责**（3-6条）
- **模块角色**（Controller/Service/Repository 等）
- **置信度** & **最后验证时间**

#### 2. API Tab
- **导出列表**（函数、类、类型）
- 每项带签名 + 证据锚点
- 按类型分组

#### 3. 依赖 Tab
- **出依赖**（Top 10，按引用次数排序）
- **入依赖**（样本5条 + "更多..."）
- 依赖图（可选）

#### 4. 证据 Tab
- 所有证据索引
- 点击展开代码片段
- 跳转到源文件

#### 5. 风险 Tab（可选）
- TODO/FIXME
- 未使用导出
- 高复杂度
- 循环依赖

---

## 🔧 实现路径

### 阶段 1：前端交互（本周）

**文件**：`media/filetree-blueprint/graphView.js`

1. 给文件节点绑定双击事件
2. 发送 `analyze-file` 消息
3. 接收 `show-analysis-card` 消息
4. 渲染卡片（Tab切换、证据跳转）
5. 折叠/展开切换

### 阶段 2：静态分析服务（本周）

**文件**：`src/features/file-analysis/StaticAnalyzer.ts`（新建）

功能：
- 解析 TypeScript/JavaScript（使用 ts-morph）
- 提取导出符号（函数、类、类型）
- 分析依赖关系（import/export）
- 生成证据坐标

### 阶段 3：LLM 增强服务（下周）

**文件**：`src/features/file-analysis/LLMAnalyzer.ts`（新建）

功能：
- 调用 OpenAI API 生成摘要
- 推断模块角色
- 生成改进建议
- 带 confidence 评分

### 阶段 4：缓存层（下周）

**文件**：`src/features/file-analysis/CapsuleCache.ts`（新建）

功能：
- 基于 contentHash 的缓存键
- 失效检测（文件改动）
- LRU 淘汰策略
- SQLite 存储（可选）

### 阶段 5：MCP 集成（后续）

**文件**：`src/mcp/FileCapsuleServer.ts`（新建）

暴露工具：
- `get_capsule(file)` → 返回 FileCapsule
- `list_capsules(query)` → 搜索标题卡
- `find_evidence(locators)` → 返回代码片段
- `verify_facts(file)` → 刷新分析

---

## 📁 文件结构（新增）

```
src/
  features/
    file-analysis/           # 新建模块
      FileAnalysisModule.ts  # 模块入口
      StaticAnalyzer.ts      # 静态分析
      LLMAnalyzer.ts         # LLM增强
      CapsuleCache.ts        # 缓存管理
      types.ts               # FileCapsule 等类型定义
      
media/
  filetree-blueprint/
    graphView.js             # 修改：添加文件双击
    analysisCard.css         # 新建：卡片样式
    
docs/
  可视化世界画布/
    文件卡片/
      实现方案.md            # 本文档
```

---

## 🎬 第一步：前端绑定

立即开始实现文件双击 → 请求分析 → 显示卡片
