# 🔍 双击功能诊断工具使用指南

## 📦 工具清单

1. **debug-dblclick.js** - 自动化诊断脚本（在 Webview Console 运行）
2. **Ctrl+Shift+D 探针** - 实时事件路径追踪（内置在 graphView.js）
3. **扩展端日志** - BlueprintPanel 日志输出

---

## 🎯 测试流程（5 分钟完成）

### 第 1 步：重启扩展
```
按 F5 启动调试会话
```

### 第 2 步：打开蓝图视图
1. 在 VS Code 中，执行命令：`FileTree Blueprint: Show Blueprint`
2. 等待蓝图面板加载完成

### 第 3 步：打开 Webview 开发者工具
1. 在蓝图面板中，按 `Ctrl+Shift+I`（或右键 → "检查元素"）
2. 切换到 **Console** 标签页

### 第 4 步：运行自动化诊断
1. 打开文件：`media/filetree-blueprint/debug-dblclick.js`
2. **复制全部内容**（85 行）
3. 粘贴到 Webview Console 中
4. 按 **Enter** 运行

**预期输出：**
```
🔍 ===== 双击功能诊断报告 =====

✅ Step 1: graph 对象存在
   graphType = 'filetree' (正确)

✅ Step 2: 找到 15 个节点 DOM
   示例节点: <div class="node node-folder">...</div>

✅ Step 3: 找到 8 个双击监听器
   - 5 个文件夹节点绑定成功
   - 3 个文件节点绑定成功

✅ Step 4: CSS 层级正确
   edges: z-index 0, pointer-events none
   nodes: z-index 1
   .node: z-index 2

✅ 诊断完成：双击功能应该正常工作
```

### 第 5 步：启用实时探针
1. 在蓝图面板中，按 **Ctrl+Shift+D**
2. 控制台显示：`🔍 双击诊断探针: ON`
3. 现在双击任何节点，控制台会显示完整事件路径

**示例输出：**
```
🔍 [探针] 捕获双击事件
  目标: <div class="node node-file">src/index.ts</div>
  路径: div.node → #nodes → #canvas → #canvasWrap → body → html
  graphType: filetree ✅
  发送消息: analyze-file
```

### 第 6 步：测试双击功能
1. **双击文件夹** → 应该下钻到子目录
2. **双击文件** → 应该显示分析卡片
3. **双击根节点** → 应该返回上一级

---

## ⚠️ 常见问题排查

### 问题 1：诊断脚本显示 "graph 不存在"
**原因：** Webview 未正确初始化

**解决：**
1. 查看扩展端日志（调试控制台）
2. 搜索 `[UI] 🔄 检测到已有图表数据，重新发送 init-graph`
3. 如果没有此日志，检查 `BlueprintPanel.handleWebviewReady()`

### 问题 2：诊断脚本显示 "graphType 不匹配"
**原因：** FileTreeScanner 未正确设置元数据

**解决：**
```typescript
// 检查 FileTreeScanner.ts
metadata: {
    graphType: 'filetree',  // ✅ 必须存在
    workspaceRoot: targetPath,
    scanMode: 'shallow'
}
```

### 问题 3：诊断脚本显示 "未找到双击监听器"
**原因：** renderNodesOnce() 未执行或绑定条件不满足

**解决：**
1. 在 Webview Console 中运行：
   ```javascript
   console.log('renderNodesOnce 是否调用？', window.graph);
   ```
2. 检查 graphView.js 的绑定条件：
   ```javascript
   if (n.type === "file" && n.data?.path && graph?.metadata?.graphType === "filetree") {
       // 这里应该绑定事件
   }
   ```

### 问题 4：探针显示事件路径，但没有发送消息
**原因：** 事件被遮罩或容器拦截

**解决：**
1. 查看探针输出的事件路径
2. 检查路径中是否有意外的元素（如 overlay、mask）
3. 检查 CSS 中的 `pointer-events` 设置

### 问题 5：扩展端收不到消息
**原因：** vscode.postMessage() 失败或消息处理错误

**解决：**
1. 在 Webview Console 中测试：
   ```javascript
   vscode.postMessage({ type: 'test', payload: {} });
   ```
2. 查看扩展端日志，搜索 `[UI] 📬 收到消息`
3. 检查 `BlueprintPanel.handleWebviewMessage()`

---

## 📊 诊断结果解读

### ✅ 完全正常的输出
```
✅ Step 1-6 全部通过
✅ 诊断完成：双击功能应该正常工作
```
**行动：** 直接测试双击功能，应该可以正常使用

---

### ⚠️ 部分异常的输出

#### 场景 A：graph 不存在
```
❌ Step 1: graph 未定义
```
**根因：** init-graph 消息未送达或处理失败

**修复步骤：**
1. 检查扩展端日志：是否发送了 init-graph？
2. 检查 Webview 消息监听器：是否正确处理了 init-graph？
3. 尝试手动重新发送：
   ```typescript
   // BlueprintPanel.ts
   if (this.currentGraph) {
       await this.safePostMessage({ type: 'init-graph', payload: this.currentGraph });
   }
   ```

#### 场景 B：graphType 不匹配
```
❌ Step 1: graphType = 'other' (期望: 'filetree')
```
**根因：** FileTreeScanner 设置错误或被覆盖

**修复步骤：**
1. 检查 `FileTreeScanner.scanPath()` 和 `scanShallow()`
2. 确保返回的 Graph 对象包含：
   ```typescript
   metadata: { graphType: 'filetree', ... }
   ```
3. 检查中间处理环节是否修改了 metadata

#### 场景 C：没有双击监听器
```
✅ Step 1-2: graph 正常，节点 DOM 存在
❌ Step 3: 未找到任何双击监听器
```
**根因：** renderNodesOnce() 中的绑定条件不满足

**修复步骤：**
1. 在 graphView.js 中添加诊断日志（已存在）：
   ```javascript
   console.log(`[诊断] 文件节点 "${n.label}":`, {
       nodeType: n.type,
       hasPath: !!n.data?.path,
       graphType: graph?.metadata?.graphType,
       willBindDoubleClick: shouldBind
   });
   ```
2. 检查输出，找出哪个条件不满足
3. 修复相应的数据或逻辑

#### 场景 D：CSS 层级错误
```
✅ Step 1-3: graph、DOM、监听器正常
❌ Step 4: edges z-index = 5 (应该 ≤ 0)
```
**根因：** CSS 层级设置错误，导致连线遮挡节点

**修复步骤：**
1. 检查 `index.css` 中的 z-index 设置
2. 确保：
   ```css
   svg.edges { z-index: 0; pointer-events: none; }
   #nodes { z-index: 1; }
   .node { z-index: 2; }
   ```

---

## 🛠️ 高级调试技巧

### 技巧 1：手动触发双击
在 Webview Console 中：
```javascript
const fileNode = document.querySelector('.node-file');
fileNode.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
```

### 技巧 2：检查事件监听器
```javascript
const node = document.querySelector('.node');
getEventListeners(node); // Chrome DevTools 专用
```

### 技巧 3：拦截 postMessage
```javascript
const originalPost = vscode.postMessage;
vscode.postMessage = function(msg) {
    console.log('📤 发送消息:', msg);
    return originalPost(msg);
};
```

### 技巧 4：实时监控 graph 变化
```javascript
let _graph = window.graph;
Object.defineProperty(window, 'graph', {
    get() { return _graph; },
    set(val) {
        console.log('🔄 graph 更新:', val?.metadata);
        _graph = val;
    }
});
```

---

## 📝 报告模板

如果双击功能仍然不工作，请提供以下信息：

```markdown
### 环境信息
- VS Code 版本: 
- 扩展版本: 
- 操作系统: 

### 诊断结果
**debug-dblclick.js 输出：**
```
（粘贴完整输出）
```

**Ctrl+Shift+D 探针输出：**
```
（粘贴双击时的输出）
```

**扩展端日志：**
```
（搜索 "init-graph"、"drill"、"analyze-file" 的相关日志）
```

### 操作步骤
1. 我执行了什么操作？
2. 预期结果？
3. 实际结果？

### 附加信息
- 是否所有文件都不工作，还是特定文件？
- 是否所有文件夹都不工作，还是特定文件夹？
- 重启扩展后问题是否依然存在？
```

---

## ✅ 成功标准

双击功能完全正常的标志：

1. **✅ 诊断脚本全部通过**
   - graph 对象存在且 graphType = 'filetree'
   - 节点 DOM 数量与 graph.nodes 一致
   - 找到对应数量的双击监听器
   - CSS 层级正确

2. **✅ 探针显示正确路径**
   - 事件路径：`div.node → #nodes → #canvas → ...`
   - 发送正确消息：drill / analyze-file

3. **✅ 扩展端正确处理**
   - BlueprintPanel 收到消息
   - 执行相应逻辑（下钻/分析）
   - Webview 更新成功

4. **✅ 用户体验流畅**
   - 双击文件夹 → 立即下钻
   - 双击文件 → 卡片显示
   - 双击根节点 → 返回上级

---

**Happy Debugging! 🎉**
