没问题！我们把“**双击文件 → 分析卡片**”整条链路**复盘 + 重梳职责**，给你一套能落地的分工、事件流、消息契约与最小骨架。按这套走，代码就不会互相踩来踩去。

---

# 复盘目标

- 双击 **文件节点** ⇒ **立刻**弹出“分析卡片（可折叠/可拖动/多 Tab）”
- 先显示**静态分析**（快）→ 背景完成 **AI 增强** 后 **增量更新**
- 每条结论**有证据锚点**；结果**写缓存**（为 MCP 复用）
- 事件链路**单向明确**，并有 **ACK**（可观测性）

---

# 模块分工（Single Responsibility）

| 层/模块                                   | 职责                 | 只做这些                                                                                                        | 不做这些                      |
| ----------------------------------------- | -------------------- | --------------------------------------------------------------------------------------------------------------- | ----------------------------- |
| **Webview/UI** `media/filetree-blueprint` | 画布与交互           | 渲染节点/卡片、拖拽、Tab 切换、证据跳转、**只发消息**                                                           | 不读文件、不跑 AI、不扫描项目 |
| **消息契约** `src/shared/messages.ts`     | **唯一**消息结构定义 | 定义 `analyze-file / show-analysis-card / update-analysis-card / analysis-error / analysis-card-shown`          | 不实现逻辑                    |
| **面板控制器** `BlueprintPanel.ts`        | **消息编排**         | 收到 UI 的 `analyze-file` → 调用分析服务 → 分别 post `show-analysis-card`（静态）+ `update-analysis-card`（AI） | 不做 UI、不做静态细节         |
| **分析服务** `AnalysisService.ts`         | 事实与 AI            | 读文件 → 静态事实（API/依赖/锚点）→（可选）AI 摘要 → 生成 FileCapsule→ 缓存                                     | 不发消息、不操作 UI           |
| **静态分析器** `StaticAnalyzer.ts`        | 提取事实             | exports/use/import/语言特征 + 证据行号/哈希                                                                     | 不发消息、不涉及 UI           |

> 关键：**谁发起，就谁不渲染**；**谁渲染，就谁不分析**。

---

# 事件流（自上而下）

1. **Webview**：双击文件节点
   → `postMessage({type: 'analyze-file', payload:{ path: '/src/foo.ts' }})`
2. **Panel** 收到
   → 调 `analyzeStatic` 得到 `capsuleStatic`
   → `postMessage({type:'show-analysis-card', payload: {...capsuleStatic, loading:true}})`
3. **Webview** 收到并**真正渲染**后
   → `postMessage({type:'analysis-card-shown', payload:{file:'/src/foo.ts'}})`
4. **Panel**（后台）跑 `analyzeWithLLM`
   → `postMessage({type:'update-analysis-card', payload: capsuleFull})`
5. **Webview** 更新卡片（保留位置/状态）
6. **失败分支**：任意一步报错
   → `postMessage({type:'analysis-error', payload:{file, message}})` + toast

---

# 消息契约（统一类型）

```ts
// 文件名: src/shared/messages.ts
// 作用: Webview <-> Extension 的唯一消息定义（TS）

export type WebviewToExt =
  | { type: "analyze-file"; payload: { path: string } }
  | {
      type: "open-source";
      payload: { file: string; line?: number; endLine?: number };
    }
  | { type: "analysis-card-shown"; payload: { file: string } };

export type ExtToWebview =
  | { type: "init-graph"; payload: any }
  | { type: "show-analysis-card"; payload: FileCapsule & { loading?: boolean } }
  | { type: "update-analysis-card"; payload: FileCapsule }
  | { type: "analysis-error"; payload: { file: string; message: string } };

export interface FileCapsule {
  version: "1.0";
  file: string; // 必须是工作区相对、POSIX路径：/src/foo.ts
  lang: string; // ts | rust | js ...
  contentHash: string; // sha256 of file content
  summary?: { zh?: string; en?: string };
  api?: Array<{ name: string; signature?: string; evidence?: string[] }>;
  deps?: {
    out?: Array<{ module: string; count: number; evidence?: string[] }>;
    inSample?: Array<{ file: string; line: number; evidence?: string[] }>;
  };
  facts?: Array<{ id: string; text: string; evidence?: string[] }>;
  inferences?: Array<{
    id: string;
    text: string;
    confidence: number;
    evidence?: string[];
  }>;
  recommendations?: Array<{
    id: string;
    text: string;
    reason?: string;
    evidence?: string[];
  }>;
  evidence?: Record<
    string,
    { file: string; lines: [number, number]; sha256: string }
  >;
  stale?: boolean;
  lastVerifiedAt?: string;
  tooling?: Record<string, string>;
}
```

> **只有这一处**能改消息结构，其他模块**只引用**它，避免“字段名对不上”。

---

# 最小骨架（关键片段）

```ts
// 文件名: src/features/filetree-blueprint/panel/BlueprintPanel.ts
// 作用: 编排 analyze-file → show（静态）→ update（AI）；只在“卡片可见后”打印 ACK

import * as vscode from "vscode";
import { analyzeStatic, analyzeWithLLM } from "../../analysis/AnalysisService";
import {
  ExtToWebview,
  WebviewToExt,
  FileCapsule,
} from "../../../shared/messages";

export function wireBlueprintPanel(
  panel: vscode.WebviewPanel,
  workspaceRoot: vscode.Uri
) {
  panel.webview.onDidReceiveMessage(async (msg: WebviewToExt) => {
    if (msg.type === "analyze-file") {
      const rel = toPosix(msg.payload.path);
      const fileUri = vscode.Uri.joinPath(workspaceRoot, rel);
      try {
        console.log("[分析文件]", fileUri.fsPath, "force=false");
        const staticCap = await analyzeStatic(fileUri);
        (staticCap as any).loading = true;
        panel.webview.postMessage(<ExtToWebview>{
          type: "show-analysis-card",
          payload: staticCap,
        });
        console.log("[UI] 已发送静态分析卡片:", fileUri.fsPath);

        // 后台AI增强
        analyzeWithLLM(fileUri, staticCap)
          .then((full) => {
            panel.webview.postMessage(<ExtToWebview>{
              type: "update-analysis-card",
              payload: full,
            });
            console.log("[UI] 已发送AI增强结果:", fileUri.fsPath);
          })
          .catch((err) => {
            panel.webview.postMessage(<ExtToWebview>{
              type: "analysis-error",
              payload: {
                file: staticCap.file,
                message: String(err?.message || err),
              },
            });
          });
      } catch (e: any) {
        panel.webview.postMessage(<ExtToWebview>{
          type: "analysis-error",
          payload: { file: rel, message: String(e?.message || e) },
        });
      }
      return;
    }
    if (msg.type === "analysis-card-shown") {
      console.log("[ACK] Webview 已显示卡片:", msg.payload.file);
      return;
    }
    if (msg.type === "open-source") {
      // 打开源码 & 高亮行号（略）
      return;
    }
  });
}

function toPosix(p: string) {
  return p.replace(/\\/g, "/").replace(/^[a-zA-Z]:\//, "/");
}
```

```js
// 文件名: media/filetree-blueprint/entry.js
// 作用: Webview 入口；监听消息，调 UI 模块；只在“可见后”回 ACK

(() => {
  const vscode = acquireVsCodeApi();
  window.addEventListener("message", (e) => {
    const msg = e.data;
    if (!msg?.type) return;

    if (msg.type === "init-graph") {
      window.Blueprint?.setGraph?.(msg.payload);
      return;
    }
    if (msg.type === "show-analysis-card") {
      ensureUI();
      const ok = window.showAnalysisCard?.(
        normalizeFile(msg.payload),
        suggestAnchor(msg.payload.file)
      );
      if (ok)
        vscode.postMessage({
          type: "analysis-card-shown",
          payload: { file: normalizeFile(msg.payload).file },
        });
      return;
    }
    if (msg.type === "update-analysis-card") {
      ensureUI();
      window.updateAnalysisCard?.(normalizeFile(msg.payload));
      return;
    }
    if (msg.type === "analysis-error") {
      window.showToast?.(`分析失败: ${msg.payload?.message || "未知错误"}`);
      return;
    }
  });

  function normalizeFile(c) {
    c.file = String(c.file || "").replace(/\\/g, "/");
    return c;
  }
  function ensureUI() {
    /* 确保 analysisCard.js/css 已注入 */
  }
  function suggestAnchor(file) {
    /* 根据节点计算默认卡片位置，略 */
  }
})();
```

```js
// 文件名: media/filetree-blueprint/analysisCard.js
// 作用: 只做“卡片UI”——显示/更新/折叠；遮罩点击延迟300ms避免双击秒关

(() => {
  const vscode = acquireVsCodeApi();
  let cardEl = null,
    backdropEl = null,
    openedAt = 0;

  window.showAnalysisCard = function (capsule, anchor = { x: 160, y: 120 }) {
    ensureHost();
    collapseAnalysisCard();
    backdropEl = document.createElement("div");
    backdropEl.className = "analysis-backdrop";
    backdropEl.addEventListener("click", (ev) => {
      if (performance.now() - openedAt < 300) {
        ev.stopPropagation();
        return;
      }
      collapseAnalysisCard();
    });
    cardEl = document.createElement("div");
    cardEl.className = "analysis-card";
    cardEl.style.left = Math.round(anchor.x) + "px";
    cardEl.style.top = Math.round(anchor.y) + "px";
    cardEl.setAttribute("data-file", capsule.file);
    cardEl.innerHTML = renderCardHtml(capsule); // 你的渲染函数

    const host = document.getElementById("analysis-host");
    host.appendChild(backdropEl);
    host.appendChild(cardEl);

    requestAnimationFrame(() => {
      openedAt = performance.now();
      cardEl.classList.add("show");
    });
    return true;
  };

  window.updateAnalysisCard = function (cap) {
    if (!cardEl) return window.showAnalysisCard(cap);
    cardEl.querySelector('[data-pane="overview"]').innerHTML =
      renderOverview(cap);
    cardEl.querySelector('[data-pane="api"]').innerHTML = renderApi(cap);
    cardEl.querySelector('[data-pane="deps"]').innerHTML = renderDeps(cap);
    // 证据按钮重绑（略）
  };

  window.collapseAnalysisCard = function () {
    cardEl?.remove();
    cardEl = null;
    backdropEl?.remove();
    backdropEl = null;
  };

  function ensureHost() {
    if (!document.getElementById("analysis-host")) {
      const host = document.createElement("div");
      host.id = "analysis-host";
      document.getElementById("canvas").appendChild(host);
    }
  }
})();
```

```css
/* 文件名: media/filetree-blueprint/analysisCard.css */
/* 作用: z-index/可见性安全网，卡片永远盖住遮罩 */

#analysis-host {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 10000;
}
#analysis-host .analysis-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.05);
  pointer-events: auto;
  z-index: 1;
}
#analysis-host .analysis-card {
  position: absolute;
  min-width: 520px;
  max-width: 740px;
  max-height: 70%;
  background: #fff;
  color: #222;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  pointer-events: auto;
  z-index: 2;
  opacity: 1;
  transform: translateY(0);
  transition: opacity 0.12s ease, transform 0.12s ease;
}
#analysis-host .analysis-card:not(.show) {
  opacity: 0.999;
  transform: translateY(6px);
}
```

---

# 一小时重构计划（强烈建议按顺序做）

1. **落地 `src/shared/messages.ts`**（消息唯一来源）
2. **检查 Panel 消息编排**：严格 `show`（静态）→ `update`（AI）→ `error`；ACK 只有在 UI 真显示后再打
3. **切分 Webview**：`entry.js`（消息） / `analysisCard.js`（卡片 UI） / `index.css + analysisCard.css`（样式）
4. **引入顺序**：HTML 中 `<script>` 顺序：`entry` **放最后**；CSS 2 个都用 `asWebviewUri`，CSP 允许
5. **路径统一**：Capsule 的 `file` 一律 `/…` POSIX 相对路径
6. **双击保护**：遮罩点击 300ms 开窗；卡片 `z-index:2`，宿主 `z-index:10000`
7. **缓存写入**：静态+AI 合并后的 Capsule 写到 `.ai-explorer-cache/filecapsules/sha.json`

---

# 验收标准（日志预期）

- 扩展端：

  ```
  [分析文件] …/src/application/index.ts
  [UI] 已发送静态分析卡片: …
  [ACK] Webview 已显示卡片: /src/application/index.ts
  [UI] 已发送AI增强结果: …
  ```

- Webview：

  ```
  [webview] recv: show-analysis-card
  [分析卡片] 已添加 show 类，卡片应该可见
  [webview] recv: update-analysis-card
  [分析卡片] AI更新完成
  ```

- 视觉：灰色遮罩下**必有白底卡片**；双击不会“秒关”。

---

# 常见坑对照

- **只有遮罩没卡片**：看 `.analysis-card` 是否 `z-index:2`、`opacity:1`、背景 `#fff`
- **双击后立即关闭**：遮罩点击窗口保护没加；或 `show` 之后又触发了 `collapse`
- **卡片离奇位置**：锚点节点找不到；统一 `file` 为相对 POSIX 路径再匹配
- **ACK 太早**：务必**在 `showAnalysisCard` 返回 true 后**再发 ACK

---

> 你现在“功能已跑通，但看不到卡片”的根本原因已经在这套分工+补丁里兜住；按“一小时重构计划”把职责理顺，后面继续迭代（入依赖样本、命名建议、保存为胶囊、MCP 对接）就顺了。需要我根据你仓库的 HTML（CSP + 资源引入）再帮你对齐一下 `<script>` 注入顺序吗？
