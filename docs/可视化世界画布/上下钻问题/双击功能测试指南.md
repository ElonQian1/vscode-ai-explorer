# 双击下钻功能测试指南

## 🎯 测试目标

验证文件夹双击下钻和根节点双击上钻功能是否正常工作。

---

## 📋 前置准备

### 1. 确保代码已编译

```powershell
npm run compile
```

### 2. 重载 VS Code 窗口

- 方法 1：按 `Ctrl+R`
- 方法 2：`F1` → `Developer: Reload Window`

### 3. 打开双控制台

**Webview 控制台**（查看前端日志）：
- `F1` → 输入 `Open Webview Developer Tools`
- 选择对应的 Webview
- 切换到 `Console` 标签

**Extension Host 控制台**（查看后端日志）：
- `F1` → 输入 `Toggle Developer Tools`
- 切换到 `Console` 标签

---

## 🧪 测试步骤

### 步骤 1：打开蓝图

1. 在资源管理器找一个有子文件夹的目录
2. 右键点击文件夹
3. 选择 **"从路径生成蓝图"**
4. 等待蓝图面板打开

✅ **预期**：面板显示文件树图表

### 步骤 2：启用诊断模式

1. 确保 Webview 控制台处于激活状态
2. 在蓝图面板上按 `Ctrl+Shift+D`
3. 观察控制台输出

✅ **预期输出**：
```
🔍 事件诊断: 开启
📊 当前图表状态: {
    graphType: 'filetree',
    nodeCount: X,
    folderNodes: Y,
    rootNode: {...}
}
📁 文件夹节点详情:
  - folder1: { hasPath: true, path: 'D:\\...', isRoot: false, ... }
  - folder2: { hasPath: true, path: 'D:\\...', isRoot: false, ... }
  - ...
💡 提示：双击文件夹节点查看事件路径
```

### 步骤 3：测试双击下钻

1. **识别子文件夹节点**（有 📁 图标且不是根节点）
2. **双击子文件夹节点**（注意：不要移动鼠标）
3. **观察 Webview 控制台**
4. **观察 Extension Host 控制台**
5. **观察面板变化**

✅ **预期行为**：

**Webview 控制台**：
```
🖱️ 双击事件路径: node node-folder > node-content > nodes > canvas > ...
🎯 目标元素: <div class="node-content">...</div>
[双击] 子文件夹，发送 drill: D:\rust\active-projects\...\subfolder
```

**Extension Host 控制台**：
```
[handleDrill] 收到下钻请求, payload: {path: 'D:\\rust\\active-projects\\...\\subfolder'}
[handleDrill] 提取的 folderPath: D:\rust\active-projects\...\subfolder
下钻到: D:\rust\active-projects\...\subfolder
开始浅层扫描: D:\rust\active-projects\...\subfolder
浅层扫描完成: X 个文件夹, Y 个文件
显示蓝图: 📁 subfolder (Z 个节点)
已刷新到子目录: D:\rust\active-projects\...\subfolder
显示蓝图: 📁 subfolder (Z 个节点)
```

**面板变化**：
- ✅ 标题变为：`蓝图: subfolder`
- ✅ 节点刷新为子文件夹的内容
- ✅ 根节点变为刚才双击的文件夹

### 步骤 4：测试双击上钻

1. **识别根节点**（标题中的文件夹名对应的节点）
2. **双击根节点**
3. **观察控制台和面板**

✅ **预期行为**：

**Webview 控制台**：
```
[双击] 根节点，发送 drill-up: D:\rust\active-projects\...\subfolder
```

**Extension Host 控制台**：
```
[handleDrillUp] 开始返回上一级
当前路径: D:\rust\active-projects\...\subfolder
父路径: D:\rust\active-projects\...
返回上一级: D:\rust\active-projects\...
显示蓝图: 📁 parent (X 个节点)
```

**面板变化**：
- ✅ 返回到父文件夹
- ✅ 标题恢复为父文件夹名
- ✅ 节点恢复为父文件夹内容

### 步骤 5：测试拖拽功能

1. **按住节点并移动**（移动超过 5 像素）
2. **观察控制台**

✅ **预期行为**：

**Webview 控制台**：
```
[拖拽] 开始拖拽节点: folder_name
[拖拽] 结束拖拽节点: folder_name
```

**节点行为**：
- ✅ 节点跟随鼠标移动
- ✅ 边线实时更新
- ✅ 释放后位置保持

### 步骤 6：测试拖拽不干扰双击

1. **双击节点，但手稍微抖动 1-2 像素**
2. **观察是否仍能下钻**

✅ **预期行为**：
- ✅ 仍然触发下钻（不会变成拖拽）
- ✅ Webview 控制台有 `[双击]` 日志
- ✅ 没有 `[拖拽]` 日志

---

## ❌ 问题排查

### 问题 1：双击没有任何反应

**症状**：
- Webview 控制台没有 `[双击]` 日志
- Extension 控制台没有任何输出
- 面板不刷新

**可能原因**：

#### 1.1 检查 graphType

```javascript
// 在 Webview 控制台运行：
console.log(graph?.metadata?.graphType);
```

✅ **应该输出**：`'filetree'`  
❌ **如果不是**：双击事件不会绑定

#### 1.2 检查节点数据

```javascript
// 在 Webview 控制台运行：
graph?.nodes?.filter(n => n.type === 'folder').forEach(n => {
    console.log(n.label, '→ path:', n.data?.path, '| isRoot:', n.data?.isRoot);
});
```

✅ **应该输出**：每个文件夹都有 `path` 属性  
❌ **如果没有**：双击不会发送消息

#### 1.3 检查事件是否被遮挡

```javascript
// 在 Webview 控制台运行：
document.addEventListener('dblclick', (e) => {
    console.log('原生双击事件触发:', e.target);
}, true);
```

然后双击节点，观察是否有日志。

✅ **有日志**：事件能到达，检查绑定逻辑  
❌ **没日志**：被 CSS 层遮挡

#### 1.4 检查 CSS

```javascript
// 在 Webview 控制台运行：
const svg = document.querySelector('svg.edges');
const help = document.querySelector('.help-overlay');
console.log('SVG pointer-events:', getComputedStyle(svg).pointerEvents);
console.log('Help pointer-events:', getComputedStyle(help).pointerEvents);
```

✅ **应该输出**：`'none'`, `'none'`  
❌ **如果是 'auto'**：这些层在拦截事件

---

### 问题 2：前端有日志，后端没反应

**症状**：
- Webview 控制台有 `[双击]` 日志
- Extension 控制台没有 `[handleDrill]` 日志

**可能原因**：

#### 2.1 消息未到达后端

检查 `BlueprintPanel.ts` 的 `onDidReceiveMessage` 是否正确绑定。

#### 2.2 消息类型不匹配

检查发送的消息类型是否为 `'drill'` 或 `'drill-up'`。

---

### 问题 3：后端有日志，但不刷新

**症状**：
- Extension 控制台有 `[handleDrill]` 日志
- 但面板不刷新

**可能原因**：

#### 3.1 FileTreeScanner 报错

查看控制台是否有错误日志。

#### 3.2 showGraph 未调用

检查 `handleDrill` 中是否正确调用了 `this.showGraph(graph)`。

---

### 问题 4：双击变成了拖拽

**症状**：
- 轻微移动鼠标就开始拖拽
- 控制台有 `[拖拽] 开始拖拽` 日志
- 没有 `[双击]` 日志

**原因**：
- 移动阈值未生效

**检查代码**：
```javascript
// 在 graphView.js 中查找：
const DRAG_THRESHOLD = 5;
```

确保这行代码存在且值为 5。

---

## 📊 正常工作的完整日志示例

### 完整测试流程日志

```
=== 启用诊断 ===
🔍 事件诊断: 开启
📊 当前图表状态: {graphType: 'filetree', nodeCount: 5, folderNodes: 2, rootNode: {…}}
📁 文件夹节点详情:
  - src: {hasPath: true, path: 'D:\\project\\src', isRoot: true, position: {…}}
  - utils: {hasPath: true, path: 'D:\\project\\src\\utils', isRoot: false, position: {…}}
💡 提示：双击文件夹节点查看事件路径

=== 双击子文件夹 'utils' ===
🖱️ 双击事件路径: node node-folder > node-content > nodes > canvas > canvasWrap > body > html > document
🎯 目标元素: div.node-content
📍 目标类名: node-content
[双击] 子文件夹，发送 drill: D:\project\src\utils

=== Extension Host 控制台 ===
[handleDrill] 收到下钻请求, payload: {path: 'D:\\project\\src\\utils'}
[handleDrill] 提取的 folderPath: D:\project\src\utils
下钻到: D:\project\src\utils
开始浅层扫描: D:\project\src\utils
浅层扫描完成: 2 个文件夹, 3 个文件
显示蓝图: 📁 utils (6 个节点)
已刷新到子目录: D:\project\src\utils

=== 双击根节点返回 ===
[双击] 根节点，发送 drill-up: D:\project\src\utils

=== Extension Host 控制台 ===
[handleDrillUp] 开始返回上一级
当前路径: D:\project\src\utils
父路径: D:\project\src
返回上一级: D:\project\src
显示蓝图: 📁 src (5 个节点)
```

---

## ✅ 测试通过标准

- [ ] Ctrl+Shift+D 能启用诊断模式
- [ ] 诊断信息显示 `graphType: 'filetree'`
- [ ] 所有文件夹节点都有 `path` 属性
- [ ] 双击子文件夹能下钻（日志 + 面板刷新）
- [ ] 双击根节点能上钻（日志 + 面板刷新）
- [ ] 拖拽节点仍正常工作
- [ ] 轻微抖动不影响双击（移动 < 5px）

---

## 📞 需要帮助？

如果测试失败，请提供：

1. **Webview 控制台的完整输出**（包括诊断信息）
2. **Extension Host 控制台的完整输出**
3. **具体哪一步失败了**
4. **截图**（如果可能）

将这些信息发给我，我会帮你定位问题！

---

*测试指南创建时间：2025-10-16*  
*适用版本：已修复拖拽干扰 + CSS优化 + 诊断工具*
