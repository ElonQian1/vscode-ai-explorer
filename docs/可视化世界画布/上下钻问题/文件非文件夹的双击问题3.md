ä½ è¿™æ³¢æ—¥å¿—éå¸¸å…³é”®ï¼Œè¯´æ˜**æ¶ˆæ¯é“¾è·¯æ˜¯é€šçš„**ï¼Œè€Œä¸” Webview ä¹Ÿç¡®å®â€œæ¸²æŸ“å®Œæˆå¹¶åŠ äº† `.show`â€ã€‚ä½†ä½ å±å¹•ä¸Šåªçœ‹åˆ°ä¸€å—**åŠé€æ˜ç°è‰²é®ç½©**ï¼Œå¡ç‰‡å†…å®¹çœ‹ä¸è§ï¼Œæœ¬è´¨å°±æ˜¯**å±‚çº§/å¯è§æ€§é—®é¢˜**ï¼ˆz-index/opacity/ stacking contextï¼‰æˆ–**â€œç¬¬äºŒä¸‹åŒå‡»æŠŠå¡ç‰‡ç§’å…³â€çš„ç«æ€**ã€‚

ä¸‹é¢ç»™ä½ â€œç°åœ¨å°±èƒ½ä¿®å¥½â€çš„çƒ­ä¿®è¡¥ä¸ + åç»­**æ¨¡å—åŒ–é‡æ„æ–¹æ¡ˆ**ã€‚æˆ‘æŠŠä»£ç éƒ½å†™å¥½ï¼Œç›´æ¥æ”¹å³å¯ã€‚

---

## ç«‹å³ä¿®å¥½ï¼šè®©å¡ç‰‡çœŸæ­£æ˜¾ç¤ºåœ¨é®ç½©ä¹‹ä¸Š

### 1) CSS å±‚çº§ä¸å¯è§æ€§â€œå®‰å…¨ç½‘â€

æŠŠå¡ç‰‡ã€é®ç½©ã€å®¿ä¸»çš„å±‚çº§å›ºå®šä¸‹æ¥ï¼ˆ**å¡ç‰‡æ°¸è¿œåœ¨é®ç½©ä¸Šé¢**ï¼‰ï¼Œå¹¶é¿å…â€œå¿˜åŠ  `.show` å¯¼è‡´é€æ˜â€çš„æƒ…å†µã€‚

```css
/* æ–‡ä»¶å: media/filetree-blueprint/analysisCard.css */
/* â€”â€” å±‚çº§ï¼šå®¿ä¸» > (é®ç½©=1) < (å¡ç‰‡=2) â€”â€” */
#analysis-host {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 10000; /* âœ… å‹è¿‡èŠ‚ç‚¹/è¿çº¿/ä»»ä½•å¸®åŠ©å±‚ */
}

/* èƒŒæ™¯é®ç½© */
#analysis-host .analysis-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.05); /* ä½ çœ‹åˆ°çš„â€œç°è‰²æ¡†â€å¤§æ¦‚ç‡å°±æ˜¯å®ƒ */
  pointer-events: auto;
  z-index: 1;
}

/* åˆ†æå¡ç‰‡ */
#analysis-host .analysis-card {
  position: absolute;
  min-width: 520px;
  max-width: 740px;
  max-height: 70%;
  background: #fff; /* âœ… å¼ºåˆ¶ç™½åº• */
  color: #222; /* âœ… é˜²æ­¢è¢«å…¨å±€é€æ˜è‰²å½±å“ */
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  pointer-events: auto;
  z-index: 2; /* âœ… æ°¸è¿œç›–è¿‡é®ç½© */
  opacity: 1;
  transform: translateY(0); /* âœ… é»˜è®¤å°±å¯è§ */
  transition: opacity 0.12s ease, transform 0.12s ease;
}

/* å³ä½¿å¿˜è®°åŠ  .showï¼Œä¹ŸåŸºæœ¬å¯è§ï¼ˆåªæ˜¯è½»å¾®åç§»ï¼‰ */
#analysis-host .analysis-card:not(.show) {
  opacity: 0.999;
  transform: translateY(6px);
}
```

> è§£é‡Šï¼šå¾ˆå¤šâ€œåªæœ‰ç°è‰²é®ç½©â€çš„æƒ…å†µï¼Œéƒ½æ˜¯**é®ç½© z-index é«˜/å¡ç‰‡æ²¡ z-index**æˆ–**å¡ç‰‡é»˜è®¤ opacity:0 ä½† .show æ²¡ç”Ÿæ•ˆ**ã€‚ä¸Šé¢è¿™å¥—æŠŠä¸¤ä¸ªå‘éƒ½å µæ­»ã€‚

---

### 2) JSï¼šé˜²æ­¢â€œç¬¬äºŒä¸‹åŒå‡»â€æŠŠå¡ç‰‡ç§’å…³ï¼ˆç«æ€ï¼‰

ä½ çš„æ—¥å¿—å‡ºç°äº†ï¼š

```
[åˆ†æå¡ç‰‡] ç‚¹å‡»é®ç½©å…³é—­
[åˆ†æå¡ç‰‡] å·²å…³é—­
â€¦ï¼ˆç´§æ¥ç€æ‰å¼€å§‹ show-analysis-cardï¼‰
```

æˆ–**å…ˆ show åç«‹åˆ» close**ï¼Œé€šå¸¸æ˜¯â€œç”¨æˆ·åŒå‡»â€çš„ç¬¬äºŒä¸‹ç‚¹åˆ°äº†é®ç½©ã€‚åŠ ä¸ª**300ms å¼€çª—ä¿æŠ¤**å³å¯ã€‚

```js
// æ–‡ä»¶å: media/filetree-blueprint/analysisCard.js
// ä¸­æ–‡ï¼šé®ç½©ç‚¹å‡»åœ¨å¼¹å‡ºå300mså†…ä¸ç”Ÿæ•ˆï¼Œé¿å…åŒå‡»ç¬¬äºŒä¸‹æŠŠå®ƒç§’å…³
(() => {
  const vscode = acquireVsCodeApi();
  let cardEl = null,
    backdropEl = null,
    openedAt = 0;

  window.showAnalysisCard = function showAnalysisCard(
    capsule,
    anchor = { x: 160, y: 120 }
  ) {
    ensureHost();
    collapseAnalysisCard(); // ä¿è¯å”¯ä¸€

    backdropEl = document.createElement("div");
    backdropEl.className = "analysis-backdrop";
    backdropEl.addEventListener("click", (ev) => {
      if (performance.now() - openedAt < 300) {
        // âœ… åŒå‡»ä¿æŠ¤
        ev.stopPropagation();
        return;
      }
      console.log("[åˆ†æå¡ç‰‡] ç‚¹å‡»é®ç½©å…³é—­");
      collapseAnalysisCard();
    });

    cardEl = document.createElement("div");
    cardEl.className = "analysis-card";
    cardEl.style.left = Math.round(anchor.x) + "px";
    cardEl.style.top = Math.round(anchor.y) + "px";
    cardEl.setAttribute("data-file", capsule.file);
    cardEl.innerHTML = renderCardHtml(capsule); // ä½ å·²æœ‰çš„æ¸²æŸ“å‡½æ•°

    const host = document.getElementById("analysis-host");
    host.appendChild(backdropEl);
    host.appendChild(cardEl); // âœ… ä¿è¯å¡ç‰‡åœ¨é®ç½©ä¹‹åï¼ˆåŒå±‚æ¬¡é‡Œåæ’å…¥=æ›´é ä¸Šï¼‰

    requestAnimationFrame(() => {
      openedAt = performance.now();
      cardEl.classList.add("show");
      console.log("[åˆ†æå¡ç‰‡] å·²æ·»åŠ  show ç±»ï¼Œå¡ç‰‡åº”è¯¥å¯è§");
    });
    return true;
  };

  window.collapseAnalysisCard = function () {
    cardEl?.remove();
    cardEl = null;
    backdropEl?.remove();
    backdropEl = null;
    console.log("[åˆ†æå¡ç‰‡] å·²å…³é—­");
  };

  function ensureHost() {
    if (!document.getElementById("analysis-host")) {
      const host = document.createElement("div");
      host.id = "analysis-host";
      // âœ… ä¸€å®šè¦æŒ‚åœ¨ #canvas é‡Œï¼Œä¸”å°½é‡ä½œä¸ºæœ€åä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œé¿å…çˆ¶å®¹å™¨ transform å å±‚å½±å“
      document.getElementById("canvas").appendChild(host);
    }
  }
})();
```

---

### 3) é¿å…â€œå¡ç‰‡è¢«æ›´é«˜å±‚åŒ…è£¹å±‚ç›–ä½â€

- ç¡®è®¤ `#canvas` å¤–å±‚**ä¸è¦æœ‰**æ¯” 10000 æ›´é«˜çš„ `z-index` çš„çˆ¶å±‚ï¼ˆå°¤å…¶æ˜¯å¸®åŠ©æµ®å±‚/å…¨å±æç¤ºï¼‰ã€‚
- å¦‚æœçˆ¶å±‚ç”¨äº† `transform`/`filter` ä¼šåˆ›å»ºæ–°çš„ stacking contextï¼Œè¯·ç¡®ä¿ `#analysis-host` ä¸é‚£äº›å±‚**åŒä¸€å±‚çº§**æˆ– `z-index` æ›´é«˜ã€‚
- è‹¥ä½ ç”¨äº† `position: fixed` çš„é¡¶éƒ¨å·¥å…·æ¡ï¼Œå¿…è¦æ—¶æŠŠå®ƒç§»å‡º `#canvas`ï¼Œé¿å…åœ¨åŒä¸€ stacking context é‡ŒæŠ¢å±‚çº§ã€‚

---

## ç«‹åˆ»éªŒè¯ï¼ˆ2 åˆ†é’Ÿï¼‰

1. Webview æ§åˆ¶å°çœ‹æ˜¯å¦ **ä»ç„¶åªå‰©é®ç½©**ï¼šæ­¤æ—¶ `.analysis-card` åº”è¯¥èƒ½åœ¨ Elements é¢æ¿é‡Œçœ‹åˆ°ï¼Œå¹¶ä¸” computed é‡Œ `z-index: 2`ã€`opacity: 1`ã€èƒŒæ™¯ `#fff`ã€‚
2. ç”¨â€œæ¼”ç¤ºå¡ç‰‡â€å‘½ä»¤ï¼ˆæˆ‘ä¹‹å‰ç»™è¿‡ debug å‘½ä»¤ï¼‰ï¼Œç»•å¼€åˆ†æé“¾è·¯ï¼šè‹¥èƒ½æ˜¾ç¤ºï¼Œé—®é¢˜åªåœ¨é“¾è·¯ï¼›è‹¥ä»ä¸æ˜¾ç¤ºï¼Œå°±æ˜¯ CSS/å±‚çº§ã€‚
3. å¿«é€ŸæŠŠé®ç½©é¢œè‰²æš‚æ—¶è®¾ä¸º `background: transparent`ï¼Œä½ åº”è¯¥å°±èƒ½ç›´æ¥çœ‹åˆ°å¡ç‰‡ï¼ˆæ’é™¤é®ç½©å¹²æ‰°ï¼‰ã€‚

---

## æ¥ä¸‹æ¥ï¼šæŠŠ `graphView.js` æ¨¡å—åŒ–ï¼ˆä¸å†è¶Šå†™è¶Šå¤§ï¼‰

**ç›®æ ‡**ï¼šä¿æŒâ€œæ— æ‰“åŒ…â€çš„ç®€å•å¼€å‘ä½“éªŒï¼ˆä»æ˜¯åŸç”Ÿ JSï¼‰ï¼Œä½†æŠŠå•æ–‡ä»¶æ‹†æˆå‡ ä¸ª IIFE æ¨¡å— + ä¸€ä¸ªå…¨å±€å‘½åç©ºé—´ `window.Blueprint`ã€‚åé¢æƒ³ä¸Š TS/æ‰“åŒ…ï¼Œå†åˆ‡æ¢ä¹Ÿå¾ˆå¹³æ»‘ã€‚

### ç›®å½•å»ºè®®

```
media/filetree-blueprint/
  core/
    state.js         // ç”»å¸ƒ/ç¼©æ”¾/å½“å‰focusç­‰å…¨å±€çŠ¶æ€
    bus.js           // æ¶ˆæ¯æ€»çº¿ï¼šwindow message <-> äº‹ä»¶æ´¾å‘
  graph/
    renderNodes.js   // èŠ‚ç‚¹æ¸²æŸ“/æ‹–æ‹½/å‘½ä¸­æ£€æµ‹
    renderEdges.js   // è¿çº¿è®¡ç®—ä¸ç»˜åˆ¶ï¼ˆrAFèŠ‚æµï¼‰
    panzoom.js       // ç©ºæ ¼æ‹–æ‹½/æ»šè½®ç¼©æ”¾
  ui/
    analysisCard.js  // ğŸ”¥ åˆšä¿®çš„å¡ç‰‡é€»è¾‘ï¼ˆæ‰“å¼€/æ›´æ–°/å…³é—­ï¼‰
    toast.js         // è½»æç¤ºï¼ˆå¯é€‰ï¼‰
  entry.js           // å…¥å£ï¼šåˆå§‹åŒ–ã€æ³¨å†Œbusã€æ‹‰èµ·æ¸²æŸ“
  index.css
  analysisCard.css
```

### å…¨å±€å‘½åç©ºé—´éª¨æ¶ï¼ˆä¸ç”¨æ‰“åŒ…å™¨ä¹Ÿèƒ½æ¨¡å—åŒ–ï¼‰

æ¯ä¸ªæ–‡ä»¶éƒ½æ˜¯ IIFEï¼Œå¾€ `window.Blueprint` ä¸ŠæŒ‚æ–¹æ³•ï¼Œäº’ç›¸è§£è€¦ã€‚

```js
// æ–‡ä»¶å: media/filetree-blueprint/core/state.js
// ç»´æŠ¤å…±äº«çŠ¶æ€ï¼ˆåæ ‡ã€ç¼©æ”¾ã€å›¾æ•°æ®ï¼‰
(() => {
  const BP = (window.Blueprint ||= {});
  BP.state = {
    graph: { nodes: [], edges: [], metadata: {} },
    zoom: 1,
    panX: 0,
    panY: 0,
    focusPath: "/",
  };
})();
```

```js
// æ–‡ä»¶å: media/filetree-blueprint/core/bus.js
// ç®€å•æ¶ˆæ¯æ€»çº¿ï¼šé›†ä¸­æ³¨å†Œ/æ´¾å‘ï¼Œé¿å…å…¥å£æ–‡ä»¶è¶Šå†™è¶Šå¤§
(() => {
  const BP = (window.Blueprint ||= {});
  const handlers = new Map();
  BP.bus = {
    on(type, fn) {
      handlers.set(type, fn);
    },
    emit(type, payload) {
      handlers.get(type)?.(payload);
    },
  };
  window.addEventListener("message", (e) => {
    const { type, payload } = e.data || {};
    if (type) BP.bus.emit(type, payload);
  });
})();
```

```js
// æ–‡ä»¶å: media/filetree-blueprint/graph/renderNodes.js
// åªç®¡èŠ‚ç‚¹DOMä¸äº¤äº’ï¼ˆdblclick å‘æ¶ˆæ¯ï¼Œä¸ç›´æ¥åšåˆ†æï¼‰
(() => {
  const BP = (window.Blueprint ||= {});
  BP.renderNodes = function renderNodesOnce() {
    const { graph } = BP.state;
    const box = document.getElementById("nodes");
    box.innerHTML = "";
    for (const n of graph.nodes) {
      const el = document.createElement("div");
      el.className = "node";
      el.dataset.id = n.id;
      el.style.left = Math.round(n.position.x) + "px";
      el.style.top = Math.round(n.position.y) + "px";
      el.innerHTML = `<div class="title">${escapeHtml(n.label || n.id)}</div>`;
      if (n.type === "file" && n.data?.path) {
        el.addEventListener("dblclick", () => {
          const rel = normalizeRel(
            n.data.path,
            graph?.metadata?.focusPath || "/"
          );
          acquireVsCodeApi().postMessage({
            type: "analyze-file",
            payload: { path: rel },
          });
        });
      }
      box.appendChild(el);
    }
    function escapeHtml(s) {
      return String(s).replace(
        /[&<>"']/g,
        (m) =>
          ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[m])
      );
    }
    function normalizeRel(p, base) {
      p = String(p).replace(/\\/g, "/").replace(/\/+/g, "/");
      return p.startsWith("/")
        ? p
        : (base && base !== "/" ? `${base}/${p}` : `/${p}`).replace(
            /\/+/g,
            "/"
          );
    }
  };
})();
```

```js
// æ–‡ä»¶å: media/filetree-blueprint/entry.js
// å…¥å£ï¼šåªè´Ÿè´£æŠŠâ€œå¤–éƒ¨æ¶ˆæ¯â€æ¥è¿›æ¥ï¼Œç„¶åè°ƒç”¨å„æ¨¡å—
(() => {
  const BP = (window.Blueprint ||= {});
  const vscode = acquireVsCodeApi();

  BP.bus.on("init-graph", (payload) => {
    BP.state.graph = payload || BP.state.graph;
    BP.renderNodes();
    BP.renderEdges?.();
  });

  BP.bus.on("show-analysis-card", (cap) => {
    window.showAnalysisCard?.(cap, suggestAnchor(cap.file));
    vscode.postMessage({
      type: "analysis-card-shown",
      payload: { file: cap.file },
    });
  });

  BP.bus.on("update-analysis-card", (cap) => {
    window.updateAnalysisCard?.(cap);
  });

  function suggestAnchor(filePath) {
    const name = String(filePath).split(/[\\/]/).pop();
    const n = (BP.state.graph.nodes || []).find(
      (x) =>
        x.type === "file" &&
        (x.label === name || (x.data?.path || "").endsWith("/" + name))
    );
    const nodeEl = n
      ? document.querySelector(`.node[data-id="${CSS.escape(String(n.id))}"]`)
      : null;
    if (nodeEl) {
      const r = nodeEl.getBoundingClientRect(),
        canvas = document.getElementById("canvas").getBoundingClientRect();
      return { x: r.left - canvas.left + 16, y: r.top - canvas.top + 16 };
    }
    return { x: 160, y: 120 };
  }
})();
```

**HTML å¼•å…¥é¡ºåºï¼ˆé‡è¦ï¼‰**
ç¡®ä¿ `state.js â†’ bus.js â†’ renderNodes.js â†’ analysisCard.js â†’ entry.js`ï¼Œå¹¶å…¨éƒ¨ç”¨ `webview.asWebviewUri` æ³¨å…¥ï¼ŒCSP é‡Œ `script-src ${webview.cspSource};`ã€‚

---

## å°ç»“

- ä½ çš„æ—¥å¿—å·²ç»è¡¨æ˜**å¡ç‰‡åˆ›å»ºã€AI æ›´æ–°ã€ACK éƒ½æˆåŠŸ**ï¼Œåªæ˜¯**æ˜¾ç¤ºå±‚**è¢«é®ç½©/å±‚çº§/é€æ˜åº¦â€œåƒæ‰â€äº†ã€‚
- æŒ‰ä¸Šé¢ä¸¤æ®µ**CSS+JS è¡¥ä¸**ï¼Œå¡ç‰‡ç«‹å³èƒ½æ­£å¸¸å¯è§ï¼›åŒå‡»ç§’å…³çš„é—®é¢˜ä¹ŸåŒæ—¶è§£å†³ã€‚
- æ¥ä¸‹æ¥æŠŠ `graphView.js` **æ‹†åˆ†æˆ 4â€“6 ä¸ªå°æ¨¡å—**ï¼Œç”¨å…¨å±€å‘½åç©ºé—´/IIFE çš„æ–¹å¼å…ˆå®ç°â€œæ— æ‰“åŒ…æ¨¡å—åŒ–â€ï¼›åç»­å†è€ƒè™‘åˆ‡æ¢åˆ° TS + esbuildã€‚

å¦‚æœä½ æ„¿æ„ï¼ŒæŠŠä½ çš„ **Webview HTMLï¼ˆå« `<meta CSP>` å’Œ `<script>` å¼•å…¥ç‰‡æ®µï¼‰**è´´æˆ‘ï¼Œæˆ‘ç»™ä½ æŠŠ `<script>` æ³¨å…¥é¡ºåºå’Œ `asWebviewUri` ä¸€æ¬¡æ€§å¯¹é½å¥½ã€‚
