你遇到的错误 `未知消息类型: node-moved` 说明 Webview 端的 `postMessage()` 发送了一个 `node-moved` 类型的消息，但扩展端并没有正确处理这种类型的消息。

### 问题原因：

1. **`node-moved` 消息没有在扩展端注册处理**。
2. 你正在尝试更新节点的位置信息（通过拖拽），但是扩展端没有对应的 `onDidReceiveMessage` 处理逻辑来响应这个类型的消息。

### 修复方案：

* **扩展端** 需要新增对 `node-moved` 消息类型的处理逻辑。
* **消息类型**：我们可以通过 `postMessage()` 向扩展端发送更新后的节点信息，然后扩展端根据这些信息更新数据（例如：重新计算图、更新节点位置等）。
* **确保下钻**功能也能正常工作。

---

## 1) 在扩展端处理 `node-moved` 消息

### 修改 `onDidReceiveMessage` 以处理 `node-moved` 消息

```ts
// 文件名: src/features/filetree-blueprint/presenters/OpenBlueprint.ts
// 说明：为 node-moved 增加一个处理器，接受位置信息并更新图。

panel.webview.onDidReceiveMessage(async (msg) => {
  if (msg?.type === 'drill') {
    const nextRel = normalizeFocus(msg.payload?.path as string, focusPath);
    const g2 = await buildShallowGraph(workspaceRoot, nextRel);
    panel.title = `文件树蓝图: ${nextRel === '/' ? path.basename(workspaceRoot.fsPath) : nextRel}`;
    panel.webview.postMessage({ type: 'init-graph', payload: g2 });
    focusPath = nextRel; // ✅ 更新当前层级
  } else if (msg?.type === 'drill-up') {
    const up = drillUp(focusPath);
    const g2 = await buildShallowGraph(workspaceRoot, up);
    panel.title = `文件树蓝图: ${up === '/' ? path.basename(workspaceRoot.fsPath) : up}`;
    panel.webview.postMessage({ type: 'init-graph', payload: g2 });
    focusPath = up; // ✅ 回到上层
  }

  // ✅ 新增：处理 node-moved 消息，更新节点位置信息
  else if (msg?.type === 'node-moved') {
    const { nodeId, position } = msg.payload;
    // 更新节点位置（例如更新节点图层的内存或进行其他必要操作）
    const node = graph.nodes.find((n) => n.id === nodeId);
    if (node) {
      node.position = position; // 更新该节点位置
    }
    // 重新绘制节点，确保 UI 更新
    panel.webview.postMessage({ type: 'init-graph', payload: graph });
  }
});
```

### 2) Webview 端发送 `node-moved` 消息

Webview 端会在拖拽节点时发送 `node-moved` 消息，更新节点位置后将其发送给扩展端。

```js
// 文件名: media/workflow/graphView.js
// 说明：在节点拖拽时，发送节点的新位置到扩展端

function makeDraggable(el, node) {
  let dragging = false; 
  let start = { x: 0, y: 0 }; 
  let nodeStart = { x: 0, y: 0 };

  el.addEventListener('pointerdown', (ev) => {
    if (ev.button !== 0) return;
    if (spacePressed) return; // 空格为平移模式
    dragging = true; 
    el.setPointerCapture(ev.pointerId);
    start = { x: ev.clientX, y: ev.clientY };
    nodeStart = { x: node.position.x, y: node.position.y };
    el.classList.add('dragging');
  });

  el.addEventListener('pointermove', (ev) => {
    if (!dragging) return;
    const dx = (ev.clientX - start.x) / scale;
    const dy = (ev.clientY - start.y) / scale;
    // 更新位置并取整
    node.position.x = Math.round(nodeStart.x + dx);
    node.position.y = Math.round(nodeStart.y + dy);
    el.style.left = node.position.x + 'px';
    el.style.top  = node.position.y + 'px';
    // 仅重画边，不重建节点
    scheduleDrawEdges();

    // ✅ 发送节点位置变化到扩展端
    vscode.postMessage({
      type: 'node-moved',
      payload: { nodeId: node.id, position: node.position }
    });
  });

  el.addEventListener('pointerup', (ev) => {
    if (!dragging) return;
    dragging = false; 
    el.releasePointerCapture(ev.pointerId);
    el.classList.remove('dragging');
  });
}
```

### 3) 修复下钻功能：确保路径和命令正确传递

看日志显示你遇到的下钻路径问题是 **`d:\rust\active-projects\小红书\employeeGUI\d:\rust\active-projects\小红书\employeeGUI\debug`**。
为了确保路径传递正确并避免重复根路径问题，可以在 Webview 中**始终传递相对路径**，并且扩展端**拼接**时统一用 `joinPath` 来避免重复。

### 修改 Webview 发送的路径

```js
// 文件名: media/workflow/graphView.js
// 修改：确保只发送相对路径

function sendDrill(path) {
  const workspaceRootPath = vscode.workspace.workspaceFolders[0]?.uri.fsPath;
  if (!workspaceRootPath) return;

  const relativePath = path.replace(workspaceRootPath, ''); // 生成相对路径
  vscode.postMessage({ type: 'drill', payload: { path: relativePath } });
}
```

### 扩展端接收后修复路径拼接

```ts
// 文件名: src/features/filetree-blueprint/presenters/OpenBlueprint.ts
// 修复：接收相对路径后拼接

panel.webview.onDidReceiveMessage(async (msg) => {
  if (msg?.type === 'drill') {
    const relativePath = msg.payload?.path;
    if (!relativePath) return;

    // 确保路径拼接正确，避免重复
    const focusUri = vscode.Uri.joinPath(workspaceRoot, relativePath);
    const g2 = await buildShallowGraph(workspaceRoot, relativePath);
    panel.title = `文件树蓝图: ${relativePath}`;
    panel.webview.postMessage({ type: 'init-graph', payload: g2 });
  }
});
```

---

## 4) 重新测试流程

1. **拖拽节点**：节点位置改变后，扩展端应该收到 `node-moved` 消息，图形也会更新。
2. **下钻**：确保双击文件夹时，传递的是相对路径，避免路径拼接问题。
3. **返回上一层**：点击“返回”按钮，确保返回到正确的上一级目录。

---

## 结论：

1. 你现在需要确保扩展端注册处理 `node-moved` 消息并更新节点位置。
2. 下钻路径的错误是由于路径拼接问题，已经提供了**路径处理修复**。
3. 重新测试下钻、节点拖拽与路径传递，应该就能正常工作了。

如果还有其他问题，随时告诉我！
