# 按功能筛选文件 - 快速测试指南

## ✅ 已完成的功能

### 1. 核心类型系统 (`FeatureContext.ts`)
- ✅ `FeaturePayload` - 输入契约(功能ID、种子文件、关键词、glob模式)
- ✅ `FileScore` - 相关性评分结果(分数、证据列表、文件类型)
- ✅ `FeatureSubGraph` - 功能子图(文件列表、边关系、缓存版本)
- ✅ `MCPFeatureOutput` - MCP代理输出格式

### 2. 相关性评分引擎 (`RelevanceScorer.ts`)
- ✅ 多维度评分:
  - **种子文件**(权重10) - 功能入口点
  - **import关系**(权重3) - 导入/被导入
  - **调用关系**(权重4) - 函数/组件调用
  - **路由关系**(权重4) - 同路由链
  - **关键词匹配**:
    - 文件名(权重2)
    - 符号名(权重1)
    - 代码文本(权重1)
  - **桥接节点**(权重2) - 连接多个高分文件
  - **网络API**(权重3) - API依赖关系

- ✅ 自动文件类型推断:
  - `component` - React组件
  - `service` - 服务/API层
  - `route` - 路由配置
  - `config` - 配置文件
  - `utility` - 工具/辅助函数
  - `types` - 类型定义
  - `hook` - React Hook
  - `test` - 测试文件

### 3. 功能渲染器 (`FeatureRenderer.ts`)
- ✅ VS Code命令: `aiExplorer.renderFeature`
- ✅ 交互式输入流程:
  1. 输入功能ID(如: `feat-user-login`)
  2. 选择种子文件(多选)
  3. 输入关键词(逗号分隔)
- ✅ 文件分析管道:
  - 收集工作区文件(支持include/exclude glob)
  - 分析文件结构(import/export/symbols)
  - 计算相关性得分
  - 阈值过滤(默认≥30分)
  - 计算跳数(BFS从种子出发)
  - 构建功能子图
- ✅ MCP代理支持(可返回图结构)

---

## 🧪 测试步骤

### 方法1: 命令面板测试

1. **打开命令面板**: `Ctrl+Shift+P` (Windows) 或 `Cmd+Shift+P` (Mac)

2. **输入命令**: `AI Explorer: Render Feature` (或直接搜索 `renderFeature`)

3. **跟随交互提示**:
   ```
   步骤1: 输入功能ID
   示例: feat-user-notes
   
   步骤2: 选择种子文件(按功能选择1-3个入口文件)
   示例: 
   - src/features/filetree-blueprint/types/UserNotes.ts
   - src/features/filetree-blueprint/cache/EnhancedCapsuleCache.ts
   
   步骤3: 输入关键词(逗号分隔)
   示例: notes, enhanced, user, comment, todo
   ```

4. **查看结果**:
   - 通知消息显示找到的相关文件数量
   - 控制台输出日志(查看分析过程)

### 方法2: 编程方式测试(调试模式)

在调试控制台执行:

```javascript
// 测试用户备注功能的文件筛选
vscode.commands.executeCommand('aiExplorer.renderFeature', {
  featureId: 'feat-enhanced-user-notes',
  featureName: '增强版用户备注系统',
  seeds: [
    'd:\\rust\\active-projects\\ai-explorer\\src\\features\\filetree-blueprint\\types\\UserNotes.ts',
    'd:\\rust\\active-projects\\ai-explorer\\media\\filetree-blueprint\\modules\\enhancedUserNotes.js'
  ],
  keywords: ['notes', 'enhanced', 'user', 'comment', 'todo', 'tag', 'rating'],
  includeGlobs: ['src/**', 'media/**'],
  excludeGlobs: ['**/node_modules/**', '**/*.test.*'],
  maxHops: 2,
  relevanceThreshold: 30,
  returnGraph: true
});
```

### 方法3: JSON文件驱动(MCP模式,待实现)

创建文件 `.ai-explorer/features/feat-user-notes.json`:

```json
{
  "featureId": "feat-enhanced-user-notes",
  "featureName": "增强版用户备注系统",
  "seeds": [
    "src/features/filetree-blueprint/types/UserNotes.ts",
    "media/filetree-blueprint/modules/enhancedUserNotes.js"
  ],
  "keywords": ["notes", "enhanced", "user", "comment", "todo"],
  "maxHops": 2,
  "relevanceThreshold": 30,
  "returnGraph": true
}
```

保存后自动触发渲染(需要实现文件监听)。

---

## 📊 预期输出

### 控制台日志示例

```
[FeatureRenderer] Rendering feature: feat-enhanced-user-notes
[FeatureRenderer] Collected 156 files
[FeatureRenderer] Analyzed 156 files
[FeatureRenderer] Found 23 relevant files (threshold: 30)
[FeatureRenderer] Rendering 23 files to webview
```

### 通知消息示例

```
Feature "增强版用户备注系统": Found 23 relevant files
```

### 返回的子图结构(如果returnGraph=true)

```typescript
{
  featureId: 'feat-enhanced-user-notes',
  featureName: '增强版用户备注系统',
  seeds: [...],
  keywords: [...],
  files: [
    {
      path: 'src/features/filetree-blueprint/types/UserNotes.ts',
      score: 100,
      kind: 'types',
      hops: 0,
      reasons: [
        { type: 'seed', detail: 'This is a seed file', weight: 10 },
        { type: 'keyword-name', detail: 'Filename contains: "notes"', weight: 2 }
      ]
    },
    {
      path: 'src/features/filetree-blueprint/cache/EnhancedCapsuleCache.ts',
      score: 76,
      kind: 'service',
      hops: 1,
      reasons: [
        { type: 'import', detail: 'Imported by seed: UserNotes.ts', weight: 3 },
        { type: 'keyword-text', detail: '12 occurrence(s) of: "notes"', weight: 1 },
        { type: 'keyword-symbol', detail: '2 symbol(s) match: "enhanced"', weight: 1 }
      ]
    },
    // ... 更多文件
  ],
  edges: {
    'UserNotes.ts': ['EnhancedCapsuleCache.ts', 'BlueprintPanel.ts'],
    'EnhancedCapsuleCache.ts': ['EnhancedAnalysisUseCase.ts'],
    // ... 更多边
  },
  edgeTypes: {
    'UserNotes.ts->EnhancedCapsuleCache.ts': 'import',
    // ... 更多边类型
  },
  timestamp: '2025-10-20T10:30:00.000Z',
  toolVersion: '1.0.0'
}
```

---

## 🔍 验证要点

### ✅ 基础功能
- [ ] 命令能成功注册并执行
- [ ] 交互式输入流程正常工作
- [ ] 文件收集符合glob模式
- [ ] 基础的import提取正常(正则版本)

### ✅ 评分系统
- [ ] 种子文件得分=100
- [ ] 被种子import的文件得分较高(≥60)
- [ ] 关键词匹配生效(文件名/代码文本)
- [ ] 阈值过滤有效(只显示≥30分的文件)

### ✅ 图构建
- [ ] edges记录了文件间的依赖关系
- [ ] hops正确表示距离种子的跳数
- [ ] 文件类型推断合理(component/service/types等)

### ⚠️ 已知限制(待改进)

1. **AST解析简化**: 
   - 当前使用正则提取import/export
   - 不支持动态import、别名路径解析
   - 建议: 用ts-morph或TypeScript Compiler API替换

2. **调用图缺失**:
   - 尚未实现函数/组件调用关系追踪
   - 建议: 集成AST分析提取调用链

3. **路由识别缺失**:
   - 尚未识别react-router/express路由配置
   - 建议: 添加路由配置文件解析

4. **Webview渲染占位**:
   - 当前只显示通知消息
   - 建议: 集成到现有BlueprintPanel渲染子图

---

## 🚀 下一步迭代方向

### Sprint 2: 完善图构建(3-5天)
- [ ] 用ts-morph实现真实的AST解析
- [ ] 提取函数/组件调用关系(callGraph)
- [ ] 识别路由配置(react-router等)
- [ ] 识别网络请求(axios/fetch)
- [ ] 别名路径解析(tsconfig paths)

### Sprint 3: UI集成(2-3天)
- [ ] 让FeatureRenderer调用BlueprintPanel.show()
- [ ] 在Overview Tab显示相关性证据(reasons列表)
- [ ] 添加过滤工具条(阈值滑杆/关键词chips/maxHops选择器)
- [ ] 点击证据徽章高亮对应的边

### Sprint 4: MCP适配(1-2天)
- [ ] 监听`.ai-explorer/features/*.json`自动渲染
- [ ] 把FeatureSubGraph写回`.ai-explorer-cache/graphs/`
- [ ] 一键导出Markdown报告

---

## 🐛 常见问题

### Q1: 命令找不到?
**A**: 确保已编译项目(`npm run compile`)并重启VS Code扩展宿主。

### Q2: 找到的文件太少?
**A**: 降低`relevanceThreshold`(默认30,可尝试20或10)。

### Q3: 种子文件选择错误?
**A**: 重新执行命令,确保选择的是功能的"入口点"文件(如页面组件、服务类、用例类)。

### Q4: 关键词不生效?
**A**: 检查关键词是否与文件名/代码内容匹配,关键词区分大小写(当前版本使用toLowerCase)。

### Q5: import关系不准确?
**A**: 这是正则提取的限制,Sprint 2会用AST解析器替换。

---

## 📝 测试反馈模板

请在测试后提供以下信息:

```markdown
## 测试环境
- VS Code版本: 
- 扩展版本: 
- 测试时间: 

## 测试用例
- 功能ID: 
- 种子文件: 
- 关键词: 
- 阈值: 

## 测试结果
- [ ] 命令执行成功
- [ ] 找到的文件数量: 
- [ ] 评分是否合理: 
- [ ] 是否有遗漏的相关文件: 
- [ ] 是否有误判的无关文件: 

## 问题/建议
(请详细描述)
```

---

## 💡 贡献指南

欢迎其他程序员一起完善这个功能!优先级任务:

1. **AST解析器集成** (高优先级) - 提高依赖图准确性
2. **BlueprintPanel集成** (高优先级) - 让结果可视化展示
3. **路由识别** (中优先级) - 完善前端项目分析
4. **MCP文件监听** (中优先级) - 支持外部代理驱动

联系方式: [你的联系方式]

---

**最后更新**: 2025-10-20  
**版本**: v1.0.0 (MVP)
