# 强制 AI 翻译功能说明

## 🎯 功能概述

**"强制用 AI 翻译此文件"** 是一个诊断和救火功能，用于：
1. **绕过缓存/词典/规则**，直接调用 AI 服务
2. **验证 AI 是否正常工作**
3. **强制重新翻译**某个文件

## 🆚 与普通翻译的区别

| 特性 | 普通翻译 | 强制 AI 翻译 |
|------|---------|-------------|
| **翻译链路** | 缓存 → 词典 → 规则 → AI | **直接 AI** |
| **缓存策略** | 优先使用缓存 | **清除缓存后调用** |
| **词典查询** | 会查询词典 | **跳过词典** |
| **规则匹配** | 会应用规则 | **跳过规则** |
| **适用场景** | 日常使用 | **诊断/强制刷新** |
| **AI 调用** | 可能不调用（有缓存时） | **必定尝试调用** |

## 📝 使用方法

### 方法 1: AI Explorer 视图右键

```
1. 打开 AI 资源管理器视图
2. 展开目录找到目标文件
3. 右键点击文件
4. 选择 "强制用 AI 翻译此文件" ✨
```

### 方法 2: 原生资源管理器右键

```
1. 在 VS Code 左侧资源管理器
2. 右键点击文件
3. 选择 "AI 资源管理器：强制用 AI 翻译此文件"
```

### 方法 3: 命令面板

```
1. 打开任意文件
2. Ctrl+Shift+P
3. 输入 "强制用 AI 翻译"
4. 选择命令
```

## 🔍 使用场景

### 场景 1: 诊断 AI 服务状态

**问题**：不确定 AI 是否在工作

**步骤**：
```
1. 右键任意英文文件
2. 选择 "强制用 AI 翻译此文件"
3. 观察结果
```

**结果判断**：
```
✅ AI 翻译成功：xxx → xxx
   → AI 服务正常工作

❌ AI 翻译失败（来源：fallback）
   → AI 服务未配置或不可用
   
❌ AI 翻译失败（来源：error）
   → AI 调用出错（网络/Key 问题）
```

### 场景 2: 翻译结果不满意

**问题**：`analyze_hierarchy_simple.cjs` 显示"无需翻译"

**原因**：词典/规则没命中，且 AI 未调用（或返回了原名）

**解决**：
```
1. 右键文件
2. 选择 "强制用 AI 翻译此文件"
3. AI 会重新翻译并保存到学习词典
4. 下次自动使用此翻译
```

### 场景 3: 清除错误缓存

**问题**：之前翻译错了，想重新翻译

**步骤**：
```
1. 右键 "强制用 AI 翻译此文件"
   （会自动清除缓存）
2. 获得新的翻译结果
3. 自动保存到学习词典
```

### 场景 4: 批量翻译后发现遗漏

**问题**：批量翻译时某些文件未翻译

**步骤**：
```
1. 找到未翻译的文件
2. 右键 "强制用 AI 翻译此文件"
3. 单独翻译这个文件
```

## 📊 执行流程

```
用户触发命令
    ↓
1. 解析参数（文件 Uri）
    ↓
2. 验证是文件类型
    ↓
3. 检查 AI 服务可用性
    ↓
4. 清除缓存
    ↓
5. 调用 translateSingle({ forceRefresh: true })
    ↓
6. 翻译链路：
   - ❌ 跳过缓存（已清除）
   - ✅ 可能命中词典（优先级最高）
   - ❌ 跳过规则
   - ✅ 调用 AI
    ↓
7. 更新树视图
    ↓
8. 保存到学习词典
    ↓
9. 显示结果提示
```

## ✅ 成功案例

### 案例 1: AI 翻译成功

```
输入: analyze_hierarchy_simple.cjs

执行: 强制用 AI 翻译此文件

输出:
✅ AI 翻译成功：analyze_hierarchy_simple.cjs → 分析层级简化脚本
已保存到学习词典，下次自动使用此翻译

日志:
[INFO] 执行强制 AI 翻译命令
[INFO] 清除缓存: enhanced-translation:analyze_hierarchy_simple.cjs
[INFO] 调用 AI 服务翻译: analyze_hierarchy_simple.cjs
[INFO] AI 返回: 分析层级简化脚本
[INFO] 保存到学习词典: analyze_hierarchy_simple.cjs -> 分析层级简化脚本
[INFO] 强制 AI 翻译成功: analyze_hierarchy_simple.cjs -> 分析层级简化脚本
```

### 案例 2: 词典命中（即使强制刷新）

```
输入: package.json

执行: 强制用 AI 翻译此文件

输出:
ℹ️ 翻译结果：package.json → 包配置文件（来源：词典）

说明: 词典优先级最高，即使强制刷新也会先查词典
```

## ❌ 失败案例

### 案例 1: AI 服务未配置

```
输入: UserService.ts

执行: 强制用 AI 翻译此文件

输出:
❌ AI 翻译失败（来源：fallback）
可能原因：
1. AI 服务未配置或 API Key 无效
2. 网络连接问题
3. AI 服务不可用

[检查AI状态] [设置API Key]

日志:
[WARN] 强制 AI 翻译失败: UserService.ts, 来源: fallback
[ERROR] AI 客户端未初始化或 API Key 未设置
```

**解决方法**：
```
1. 点击 [设置API Key]
2. 输入 OpenAI API Key
3. 重新执行强制翻译
```

### 案例 2: 网络连接失败

```
输入: config.ts

执行: 强制用 AI 翻译此文件

输出:
❌ AI 翻译失败（来源：error）
可能原因：
1. AI 服务未配置或 API Key 无效
2. 网络连接问题
3. AI 服务不可用

日志:
[ERROR] AI 批量翻译失败: Network request failed
[ERROR] 强制 AI 翻译失败: Error: Network request failed
```

**解决方法**：
```
1. 检查网络连接
2. 检查代理设置
3. 尝试切换到腾讯混元
```

## 🔧 与其他功能配合

### 配合 "检查AI状态"

```
流程:
1. 运行 "检查AI状态" → 发现 AI 不可用
2. 设置 API Key
3. 运行 "强制用 AI 翻译此文件" → 验证配置成功
```

### 配合 "测试AI翻译"

```
流程:
1. 运行 "测试AI翻译" → 测试单个词汇
2. 确认 AI 工作正常
3. 运行 "强制用 AI 翻译此文件" → 翻译实际文件
```

### 配合 "清除节点缓存"

```
不推荐: 先清除缓存，再强制翻译（重复操作）

推荐: 直接用"强制用 AI 翻译"（自动清除缓存）
```

## ⚠️ 注意事项

### 1. 会清除缓存

```
强制翻译会清除该文件的缓存
如果之前有手动调整的翻译，会被覆盖
```

### 2. 会消耗 API 额度

```
每次强制翻译都会调用 AI API
如果频繁使用，会消耗 API 额度
建议：只在需要时使用
```

### 3. 词典优先级最高

```
即使强制翻译，也会先查词典
如果词典有结果，会直接返回词典翻译
不会调用 AI
```

### 4. 保存到学习词典

```
AI 翻译成功后会自动保存到学习词典
下次翻译同名文件会直接使用学习词典结果
不会再调用 AI
```

## 📈 最佳实践

### 日常使用

```
✅ 推荐: 使用普通翻译（高效，利用缓存）
❌ 不推荐: 每次都用强制翻译（浪费 API 额度）
```

### 诊断问题

```
✅ 推荐: 用强制翻译验证 AI 是否工作
❌ 不推荐: 依赖猜测或多次尝试
```

### 批量+单个混合

```
策略:
1. 首次: 批量翻译整个项目
2. 遗漏: 用强制翻译补充个别文件
3. 不满意: 用强制翻译重新生成
```

### 团队协作

```
场景: 团队成员 A 翻译了一批文件
问题: 成员 B 不满意某个翻译
解决: B 用强制翻译重新生成，并分享学习词典
```

## 🧪 测试建议

### 测试 1: 验证 AI 配置

```
1. 创建测试文件: test_ai_service.txt
2. 右键 "强制用 AI 翻译此文件"
3. 查看结果:
   - 成功 → AI 配置正确
   - 失败 → 检查配置
```

### 测试 2: 对比翻译质量

```
1. 找一个英文文件（如 UserController.ts）
2. 记录普通翻译结果
3. 清除缓存
4. 使用强制 AI 翻译
5. 对比两次结果
```

### 测试 3: 学习词典验证

```
1. 强制翻译一个文件
2. 查看学习词典文件（.ai/.ai-glossary.learned.json）
3. 确认新增了条目
4. 再次翻译同名文件
5. 验证来源是"缓存"而非"AI"
```

## 📚 相关文档

- [翻译失败诊断指南](./翻译失败诊断指南.md)
- [AI 诊断工具](./AI诊断和测试指南.md)
- [右键翻译使用指南](./右键单独翻译文件-使用指南.md)
- [翻译架构说明](./右键单独翻译文件-架构说明.md)

## 🎯 总结

**强制 AI 翻译** 是一个强大的诊断和救火工具：

✅ **优点**：
- 绕过缓存，确保调用 AI
- 快速验证 AI 服务状态
- 强制重新翻译不满意的结果
- 自动保存到学习词典

⚠️ **注意**：
- 会清除原有缓存
- 消耗 API 额度
- 不适合日常频繁使用

💡 **建议**：
- 日常使用普通翻译
- 遇到问题时使用强制翻译
- 配合诊断工具一起使用
