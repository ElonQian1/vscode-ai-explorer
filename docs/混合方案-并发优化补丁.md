# æ··åˆæ–¹æ¡ˆ - å¹¶å‘ä¼˜åŒ–è¡¥ä¸

## æ¦‚è¿°

æœ¬è¡¥ä¸ä¸º `EnhancedTranslateBatchUseCase` æ·»åŠ å¹¶å‘æ§åˆ¶å’Œé‡è¯•æœºåˆ¶ï¼Œæ€§èƒ½æå‡çº¦ 6 å€ã€‚

## ä¿®æ”¹æ¸…å•

### 1. å·²å®Œæˆ âœ…

- [x] åˆ›å»º `src/shared/utils/ConcurrencyPool.ts`
- [x] åˆ›å»º `src/shared/utils/RetryHelper.ts`
- [x] æ·»åŠ å¯¼å…¥è¯­å¥

### 2. é…ç½®ä¿®æ”¹ï¼ˆpackage.jsonï¼‰

åœ¨ `package.json` çš„ `"contributes"."configuration"."properties"` ä¸­æ·»åŠ ï¼š

```json
{
  "contributes": {
    "configuration": {
      "properties": {
        "aiExplorer.batch.maxConcurrency": {
          "type": "number",
          "default": 6,
          "minimum": 1,
          "maximum": 16,
          "description": "æ‰¹é‡ç¿»è¯‘æœ€å¤§å¹¶å‘æ•°ï¼ˆé»˜è®¤ 6ï¼‰ã€‚æ›´é«˜çš„å¹¶å‘æ•°å¯ä»¥æå‡æ€§èƒ½ï¼Œä½†å¯èƒ½è§¦å‘ API é™æµ"
        },
        "aiExplorer.batch.retryTimes": {
          "type": "number",
          "default": 1,
          "minimum": 0,
          "maximum": 3,
          "description": "æ‰¹é‡ç¿»è¯‘å¤±è´¥é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 1ï¼‰ã€‚ç”¨äºå¤„ç†çŸ­æš‚é”™è¯¯ï¼ˆå¦‚ 429 é™æµã€ç½‘ç»œè¶…æ—¶ï¼‰"
        }
      }
    }
  }
}
```

### 3. è°ƒç”¨å¤„ä¿®æ”¹ï¼ˆExplorerAliasModule.tsï¼‰

åœ¨ `ExplorerAliasModule.ts` çš„ `handleTranslateAllCommand` æ–¹æ³•ä¸­ï¼ˆçº¦ç¬¬314è¡Œï¼‰ï¼š

**ä¿®æ”¹å‰ï¼š**
```typescript
const results = await this.translateUseCase!.translateFiles(allFiles, {
    enableLearning: true,
    batchSize: 15,
    forceRefresh: false
});
```

**ä¿®æ”¹åï¼š**
```typescript
// ğŸ†• è¯»å–å¹¶å‘é…ç½®
const config = vscode.workspace.getConfiguration('aiExplorer');
const maxConcurrency = config.get<number>('batch.maxConcurrency', 6);
const retryTimes = config.get<number>('batch.retryTimes', 1);

const results = await this.translateUseCase!.translateFiles(allFiles, {
    enableLearning: true,
    batchSize: 15,  // å·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹
    forceRefresh: false,
    maxConcurrency,  // ğŸ†• å¹¶å‘æ§åˆ¶
    retryTimes       // ğŸ†• é‡è¯•æœºåˆ¶
});
```

åŒæ ·åœ¨ `handleTranslateSelected` æ–¹æ³•ä¸­ï¼ˆçº¦ç¬¬249è¡Œï¼‰ä¹Ÿåšç±»ä¼¼ä¿®æ”¹ã€‚

---

## æ€§èƒ½å¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆé¡ºåºå¤„ç†ï¼‰
- 100 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªè€—æ—¶ 1 ç§’
- æ€»è€—æ—¶ï¼š100 ç§’

### ä¿®æ”¹åï¼ˆå¹¶å‘å¤„ç†ï¼‰
- 100 ä¸ªæ–‡ä»¶ï¼Œå¹¶å‘æ•° 6
- æ€»è€—æ—¶ï¼š100 / 6 â‰ˆ 17 ç§’
- **æ€§èƒ½æå‡ï¼šçº¦ 6 å€**

---

## éªŒè¯æ­¥éª¤

1. **ç¼–è¯‘é¡¹ç›®**
   ```bash
   npm run compile
   ```

2. **é‡æ–°åŠ è½½ VS Code**
   - æŒ‰ F1ï¼Œè¿è¡Œ "Developer: Reload Window"

3. **æµ‹è¯•å¹¶å‘ç¿»è¯‘**
   - æ‰“å¼€ä¸€ä¸ªé¡¹ç›®
   - æ‰§è¡Œ "AI èµ„æºç®¡ç†å™¨ï¼šç¿»è¯‘æ•´ä¸ªå·¥ä½œåŒº"
   - è§‚å¯Ÿè¾“å‡ºé¢æ¿ä¸­çš„å¹¶å‘æ—¥å¿—

4. **æµ‹è¯•é‡è¯•æœºåˆ¶**
   - æ•…æ„è§¦å‘ 429 é™æµï¼ˆå¿«é€Ÿç¿»è¯‘å¤§é‡æ–‡ä»¶ï¼‰
   - æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "ç¿»è¯‘å¤±è´¥ï¼Œç¬¬ N æ¬¡é‡è¯•" çš„æ¶ˆæ¯

5. **éªŒè¯é…ç½®ç”Ÿæ•ˆ**
   - æ‰“å¼€è®¾ç½®ï¼Œæœç´¢ "aiExplorer.batch"
   - ä¿®æ”¹ `maxConcurrency` ä¸º 3
   - é‡æ–°ç¿»è¯‘ï¼Œè§‚å¯Ÿå¹¶å‘æ•°æ˜¯å¦å˜åŒ–

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šï¼š

```bash
git checkout src/features/explorer-alias/app/usecases/EnhancedTranslateBatchUseCase.ts
git checkout src/features/explorer-alias/ExplorerAliasModule.ts
git checkout package.json
```

ç„¶ååˆ é™¤æ–°å¢çš„å·¥å…·ç±»ï¼š
```bash
rm src/shared/utils/ConcurrencyPool.ts
rm src/shared/utils/RetryHelper.ts
```

---

## åç»­ä¼˜åŒ–å»ºè®®

1. **åŠ¨æ€å¹¶å‘æ§åˆ¶**
   - æ ¹æ® API å“åº”æ—¶é—´è‡ªåŠ¨è°ƒæ•´å¹¶å‘æ•°
   - æ£€æµ‹åˆ° 429 æ—¶è‡ªåŠ¨é™ä½å¹¶å‘æ•°

2. **è¿›åº¦åé¦ˆå¢å¼º**
   - å®æ—¶æ˜¾ç¤ºå¹¶å‘æ± çŠ¶æ€ï¼ˆæ´»è·ƒ/é˜Ÿåˆ—/å·²å®Œæˆï¼‰
   - æ˜¾ç¤ºå½“å‰æ­£åœ¨ç¿»è¯‘çš„æ–‡ä»¶åˆ—è¡¨

3. **æ‰¹é‡ä¼˜åŒ–**
   - å°†ç›¸ä¼¼çš„æ–‡ä»¶åˆ†ç»„å¤„ç†
   - å¯¹å·²çŸ¥ç®€å•æ–‡ä»¶ï¼ˆçº¯å­—æ¯ï¼‰è·³è¿‡ AI è¯·æ±‚

4. **ç¼“å­˜é¢„çƒ­**
   - æ‰¹é‡ç¿»è¯‘å‰å…ˆæ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
   - ç¼“å­˜å‘½ä¸­ç‡é«˜çš„æ–‡ä»¶ä¼˜å…ˆå¤„ç†

---

## å½“å‰çŠ¶æ€

- âœ… å¹¶å‘æ± å·¥å…·ç±»å·²åˆ›å»º
- âœ… é‡è¯•åŠ©æ‰‹å·¥å…·ç±»å·²åˆ›å»º
- â³ ç­‰å¾…åº”ç”¨é…ç½®ä¿®æ”¹
- â³ ç­‰å¾…æ›´æ–°è°ƒç”¨å¤„

**ä¸‹ä¸€æ­¥ï¼š** æ‰‹åŠ¨åº”ç”¨ä¸Šè¿°é…ç½®ä¿®æ”¹ï¼Œæˆ–å‘Šè¯‰æˆ‘ç»§ç»­å¸®ä½ å®Œæˆå‰©ä½™ä¿®æ”¹ã€‚
