# æ··åˆæ–¹æ¡ˆå®æ–½æŒ‡å—

## å·²å®Œæˆçš„å·¥ä½œ âœ…

1. âœ… åˆ›å»ºå¹¶å‘æ± å·¥å…·ç±»ï¼š`src/shared/utils/ConcurrencyPool.ts`
2. âœ… åˆ›å»ºé‡è¯•åŠ©æ‰‹å·¥å…·ç±»ï¼š`src/shared/utils/RetryHelper.ts`
3. âœ… æ·»åŠ å¯¼å…¥è¯­å¥åˆ° `EnhancedTranslateBatchUseCase.ts`

## å¾…å®Œæˆçš„å·¥ä½œ â³

ç”±äºä»£ç ç»“æ„è¾ƒå¤æ‚ï¼Œæˆ‘å»ºè®®ä½ æ‰‹åŠ¨å®Œæˆä»¥ä¸‹ä¿®æ”¹ï¼Œè¿™æ ·æ›´å®‰å…¨ï¼š

### Step 1: ä¿®æ”¹ `translateFiles` æ–¹æ³•ç­¾å

åœ¨ `EnhancedTranslateBatchUseCase.ts` çš„ `translateFiles` æ–¹æ³•ä¸­ï¼ˆçº¦ç¬¬107è¡Œï¼‰ï¼š

**ä¿®æ”¹å‰ï¼š**
```typescript
async translateFiles(files: FileNode[], options?: {
    forceRefresh?: boolean;
    forceAI?: boolean;
    enableLearning?: boolean;
    batchSize?: number;
}): Promise<Map<FileNode, TranslationResult>> {
```

**ä¿®æ”¹åï¼š**
```typescript
async translateFiles(files: FileNode[], options?: {
    forceRefresh?: boolean;
    forceAI?: boolean;
    enableLearning?: boolean;
    batchSize?: number;  // å·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹
    maxConcurrency?: number;  // ğŸ†• å¹¶å‘æ§åˆ¶
    retryTimes?: number;      // ğŸ†• é‡è¯•æ¬¡æ•°
}): Promise<Map<FileNode, TranslationResult>> {
```

### Step 2: åœ¨æ–¹æ³•å¼€å§‹å¤„æ·»åŠ å¹¶å‘é…ç½®

åœ¨ `translateFiles` æ–¹æ³•çš„å¼€å§‹å¤„ï¼ˆ`const startTime = Date.now();` ä¹‹åï¼‰ï¼š

**æ·»åŠ ï¼š**
```typescript
const startTime = Date.now();
const maxConcurrency = options?.maxConcurrency || 6;  // ğŸ†•
const retryTimes = options?.retryTimes || 1;          // ğŸ†•

const stats: TranslationStats = {
    // ...ç°æœ‰ä»£ç 
};
```

### Step 3: æ›´æ–°æ—¥å¿—æ¶ˆæ¯

**ä¿®æ”¹å‰ï¼š**
```typescript
this.logger.info(`å¼€å§‹æ™ºèƒ½æ‰¹é‡ç¿»è¯‘ ${files.length} ä¸ªæ–‡ä»¶`);
```

**ä¿®æ”¹åï¼š**
```typescript
this.logger.info(`å¼€å§‹æ™ºèƒ½æ‰¹é‡ç¿»è¯‘ ${files.length} ä¸ªæ–‡ä»¶ï¼ˆå¹¶å‘æ•°ï¼š${maxConcurrency}ï¼‰`);
```

### Step 4: å°†æ•´ä¸ª `for (const file of files)` å¾ªç¯æ›¿æ¢ä¸ºå¹¶å‘å¤„ç†

æ‰¾åˆ°è¿™æ®µä»£ç ï¼ˆçº¦ç¬¬137è¡Œå¼€å§‹ï¼‰ï¼š

```typescript
// ç¬¬ä¸€é˜¶æ®µï¼šç¼“å­˜å’Œè¯å…¸æŸ¥æ‰¾ + ç›´è¯‘V2+AIå…œåº•
for (const file of files) {
    try {
        // ... å¾ˆé•¿çš„å¤„ç†é€»è¾‘ ...
    } catch (error) {
        this.logger.warn(`å¤„ç†æ–‡ä»¶å¤±è´¥: ${file.name}`, error);
        stats.failed++;
    }
}
```

**å®Œæ•´æ›¿æ¢ä¸ºï¼š**

```typescript
// ğŸ†• ç¬¬ä¸€é˜¶æ®µï¼šå¹¶å‘å¤„ç†ï¼ˆç¼“å­˜ â†’ è¯å…¸ â†’ è§„åˆ™/ç›´è¯‘V2+AIå…œåº•ï¼‰
const pool = new ConcurrencyPool(maxConcurrency);
const errors: Array<{ file: FileNode; error: any }> = [];

for (const file of files) {
    pool.run(async () => {
        try {
            // ğŸ†• å¸¦é‡è¯•çš„å•æ–‡ä»¶ç¿»è¯‘
            const result = await RetryHelper.withRetry(
                () => this.translateSingleFile(file, options, stats),
                {
                    retryTimes,
                    backoffMs: 300,
                    onRetry: (error, attempt) => {
                        this.logger.warn(
                            `ç¿»è¯‘å¤±è´¥ï¼Œç¬¬ ${attempt} æ¬¡é‡è¯•: ${file.name}`,
                            error
                        );
                    }
                }
            );
            
            // ç¿»è¯‘æˆåŠŸï¼ˆtranslateSingleFile å·²å¤„ç†ç»Ÿè®¡ï¼‰
        } catch (error) {
            // é‡è¯•åä»å¤±è´¥
            this.logger.error(`ç¿»è¯‘å¤±è´¥ï¼ˆå·²é‡è¯• ${retryTimes} æ¬¡ï¼‰: ${file.name}`, error);
            errors.push({ file, error });
            stats.failed++;
        }
    });
}

// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
await pool.drain();

// å¦‚æœæœ‰å¤±è´¥çš„æ–‡ä»¶ï¼Œè®°å½•æ±‡æ€»
if (errors.length > 0) {
    this.logger.warn(`æ‰¹é‡ç¿»è¯‘å®Œæˆï¼Œ${errors.length} ä¸ªæ–‡ä»¶å¤±è´¥:`, 
        errors.map(e => e.file.name).join(', '));
}
```

### Step 5: æå– `translateSingleFile` æ–¹æ³•

åœ¨ `translateFiles` æ–¹æ³•ä¹‹åï¼Œæ·»åŠ æ–°çš„ç§æœ‰æ–¹æ³•ã€‚å°†åŸæ¥ `for` å¾ªç¯ä¸­çš„é€»è¾‘æå–åˆ°è¿™é‡Œï¼š

```typescript
/**
 * ğŸ†• ç¿»è¯‘å•ä¸ªæ–‡ä»¶ï¼ˆæå–çš„æ ¸å¿ƒé€»è¾‘ï¼‰
 * æµç¨‹ï¼šç¼“å­˜ â†’ è¯å…¸ â†’ è§„åˆ™/ç›´è¯‘V2+AIå…œåº•
 */
private async translateSingleFile(
    file: FileNode,
    options: any,
    stats: TranslationStats
): Promise<void> {
    // 1. æ£€æŸ¥ç¼“å­˜ï¼ˆé™¤éå¼ºåˆ¶åˆ·æ–°ï¼‰
    if (!options?.forceRefresh) {
        const cached = await this.getCachedTranslation(file.name);
        if (cached) {
            stats.cached++;
            return; // æ³¨æ„ï¼šä¸éœ€è¦è¿”å› resultï¼Œç›´æ¥è¿”å›å³å¯
        }
    }

    // 2. è¯å…¸æŸ¥æ‰¾ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    const dictionaryResult = this.dictionary.translate(file.name);
    if (dictionaryResult) {
        const result: TranslationResult = {
            original: file.name,
            translated: dictionaryResult,
            confidence: 1.0,
            source: 'dictionary',
            timestamp: Date.now()
        };
        
        await this.cacheTranslation(file.name, result);
        stats.dictionaryHits++;
        return;
    }

    // 3. æ™ºèƒ½è§„åˆ™å¼•æ“æˆ–ç›´è¯‘ï¼ˆæ ¹æ®é…ç½®é€‰æ‹©é£æ ¼ï¼‰
    const config = vscode.workspace.getConfiguration('aiExplorer');
    const style = config.get<'natural' | 'literal'>('alias.style', 'natural');
    
    if (style === 'literal') {
        // ç›´è¯‘é£æ ¼ï¼šV2ç‰ˆæœ¬ï¼ˆä¿ç•™åˆ†éš”ç¬¦ï¼‰ + AIå…œåº•
        await this.handleLiteralStyle(file, options, stats);
    } else {
        // è‡ªç„¶ä¸­æ–‡é£æ ¼ï¼šä¼˜å…ˆå°è¯•æ™ºèƒ½è§„åˆ™å¼•æ“
        await this.handleNaturalStyle(file, options, stats);
    }
}

/**
 * ğŸ†• å¤„ç† literal é£æ ¼ç¿»è¯‘
 */
private async handleLiteralStyle(
    file: FileNode,
    options: any,
    stats: TranslationStats
): Promise<void> {
    // å°†åŸæ¥ literal é£æ ¼çš„å¤„ç†é€»è¾‘å¤åˆ¶åˆ°è¿™é‡Œ
    // ...
}

/**
 * ğŸ†• å¤„ç† natural é£æ ¼ç¿»è¯‘
 */
private async handleNaturalStyle(
    file: FileNode,
    options: any,
    stats: TranslationStats
): Promise<void> {
    // å°†åŸæ¥ natural é£æ ¼çš„å¤„ç†é€»è¾‘å¤åˆ¶åˆ°è¿™é‡Œ
    // ...
}
```

---

## ç®€åŒ–ç‰ˆæœ¬ï¼ˆæ¨èï¼‰

å¦‚æœä½ è§‰å¾—ä¸Šé¢çš„ä¿®æ”¹å¤ªå¤æ‚ï¼Œå¯ä»¥é‡‡ç”¨**æœ€å°æ”¹åŠ¨ç‰ˆæœ¬**ï¼š

åªéœ€åœ¨åŸæœ‰ `for` å¾ªç¯å¤–åŒ…è£¹å¹¶å‘æ± å³å¯ï¼Œä¸æå– `translateSingleFile`ï¼š

```typescript
// ğŸ†• å¹¶å‘å¤„ç†
const pool = new ConcurrencyPool(maxConcurrency);

for (const file of files) {
    pool.run(async () => {
        try {
            // åŸæœ‰çš„æ‰€æœ‰å¤„ç†é€»è¾‘ï¼ˆç¼“å­˜ â†’ è¯å…¸ â†’ è§„åˆ™...ï¼‰
            // å®Œå…¨ä¸å˜ï¼Œåªæ˜¯åŒ…åœ¨ pool.run() é‡Œ
            
            // 1. æ£€æŸ¥ç¼“å­˜
            if (!options?.forceRefresh) {
                const cached = await this.getCachedTranslation(file.name);
                if (cached) {
                    stats.cached++;
                    return;
                }
            }
            
            // ... å…¶ä½™é€»è¾‘å®Œå…¨ä¸å˜ ...
            
        } catch (error) {
            this.logger.warn(`å¤„ç†æ–‡ä»¶å¤±è´¥: ${file.name}`, error);
            stats.failed++;
        }
    });
}

// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
await pool.drain();
```

è¿™ä¸ªç‰ˆæœ¬**æœ€ç®€å•**ï¼Œåªéœ€è¦ï¼š
1. åˆ›å»ºå¹¶å‘æ± 
2. å°†åŸ `for` å¾ªç¯ä½“åŒ…åœ¨ `pool.run(async () => { ... })` é‡Œ
3. æ·»åŠ  `await pool.drain()`

---

## ä¸‹ä¸€æ­¥

è¯·é€‰æ‹©ä»¥ä¸‹æ–¹æ¡ˆä¹‹ä¸€ï¼š

1. **æ–¹æ¡ˆAï¼ˆå®Œæ•´ç‰ˆï¼‰**ï¼šæŒ‰ç…§ Step 1-5 å®Œæ•´å®æ–½ï¼Œè·å¾—æœ€ä½³æ¨¡å—åŒ–
2. **æ–¹æ¡ˆBï¼ˆç®€åŒ–ç‰ˆï¼‰**ï¼šä½¿ç”¨ä¸Šé¢çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œæœ€å°æ”¹åŠ¨
3. **æ–¹æ¡ˆCï¼ˆè®©æˆ‘å¸®å¿™ï¼‰**ï¼šå‘Šè¯‰æˆ‘é€‰æ‹©å“ªä¸ªæ–¹æ¡ˆï¼Œæˆ‘æ¥å®Œæˆä»£ç ä¿®æ”¹

ç”±äºå¹¶å‘å¤„ç†ä¸­ `results` å˜é‡çš„ç®¡ç†æ¯”è¾ƒå¤æ‚ï¼ˆéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼‰ï¼Œæˆ‘å»ºè®®ä½ å…ˆé€‰æ‹©æ–¹æ¡ˆï¼Œæˆ‘å†å¸®ä½ å®Œæˆè¯¦ç»†çš„ä»£ç ä¿®æ”¹ã€‚
