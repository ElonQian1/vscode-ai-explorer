# AI Explorer - å®‰å…¨æ‰«æ
name: Security

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8:00 UTC è¿è¡Œ
    - cron: '0 8 * * 1'
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "ğŸ” NPM å®‰å…¨å®¡è®¡..."
          npm audit --audit-level=moderate || echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥"

      - name: OSV Scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: |-
            -r
            --skip-git
            .

  csp-validation:
    name: CSP Policy Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run compile

      - name: Validate CSP policies
        run: |
          echo "ğŸ›¡ï¸ éªŒè¯ CSP å®‰å…¨ç­–ç•¥..."
          
          # æ£€æŸ¥ webview HTML æ–‡ä»¶ä¸­çš„ CSP
          find webview -name "*.html" -exec echo "æ£€æŸ¥æ–‡ä»¶: {}" \;
          find webview -name "*.html" -exec grep -l "Content-Security-Policy" {} \; || echo "âš ï¸ æœªæ‰¾åˆ° CSP ç­–ç•¥"
          
          # æ£€æŸ¥å†…è”è„šæœ¬å’Œæ ·å¼
          echo "ğŸ” æ£€æŸ¥å†…è”è„šæœ¬..."
          if find webview -name "*.html" -exec grep -l "script.*>" {} \; 2>/dev/null; then
            echo "âš ï¸ å‘ç°å†…è”è„šæœ¬ï¼Œå¯èƒ½è¿å CSP"
          else
            echo "âœ… æœªå‘ç°å†…è”è„šæœ¬"
          fi
          
          echo "ğŸ” æ£€æŸ¥å†…è”æ ·å¼..."
          if find webview -name "*.html" -exec grep -l "style.*>" {} \; 2>/dev/null; then
            echo "âš ï¸ å‘ç°å†…è”æ ·å¼ï¼Œå¯èƒ½è¿å CSP" 
          else
            echo "âœ… æœªå‘ç°å†…è”æ ·å¼"
          fi

  code-quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: ESLint Security Analysis
        run: |
          echo "ğŸ” ESLint å®‰å…¨åˆ†æ..."
          npm run lint -- --format=json --output-file=eslint-results.json || true
          
          # æ£€æŸ¥å®‰å…¨ç›¸å…³çš„ ESLint è§„åˆ™
          echo "ğŸ” æ£€æŸ¥æ½œåœ¨å®‰å…¨é—®é¢˜..."
          if [ -f eslint-results.json ]; then
            node -e "
              const results = require('./eslint-results.json');
              const securityIssues = results.flatMap(r => r.messages)
                .filter(m => m.ruleId && (
                  m.ruleId.includes('security') || 
                  m.ruleId.includes('no-eval') ||
                  m.ruleId.includes('no-implied-eval')
                ));
              if (securityIssues.length > 0) {
                console.log('âš ï¸ å‘ç°å®‰å…¨ç›¸å…³é—®é¢˜:', securityIssues.length);
                securityIssues.forEach(issue => console.log(issue));
              } else {
                console.log('âœ… æœªå‘ç°å®‰å…¨ç›¸å…³çš„ ESLint é—®é¢˜');
              }
            "
          fi

      - name: TypeScript Security Check
        run: |
          echo "ğŸ” TypeScript å®‰å…¨æ£€æŸ¥..."
          
          # æ£€æŸ¥æ½œåœ¨çš„ä¸å®‰å…¨æ¨¡å¼
          echo "ğŸ” æ£€æŸ¥ eval ä½¿ç”¨..."
          if grep -r "eval(" src/ --include="*.ts" --include="*.js"; then
            echo "âš ï¸ å‘ç° eval ä½¿ç”¨ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©"
          else
            echo "âœ… æœªå‘ç° eval ä½¿ç”¨"
          fi
          
          echo "ğŸ” æ£€æŸ¥ innerHTML ä½¿ç”¨..."
          if grep -r "innerHTML" src/ --include="*.ts" --include="*.js"; then
            echo "âš ï¸ å‘ç° innerHTML ä½¿ç”¨ï¼Œè¯·ç¡®ä¿å·²è¿›è¡Œå®‰å…¨å¤„ç†"
          else
            echo "âœ… æœªå‘ç° innerHTML ä½¿ç”¨"
          fi

  license-compliance:
    name: License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: License Check
        run: |
          echo "ğŸ“„ è®¸å¯è¯åˆè§„æ£€æŸ¥..."
          
          # å®‰è£… license-checker
          npm install -g license-checker
          
          # ç”Ÿæˆè®¸å¯è¯æŠ¥å‘Š
          license-checker --json --out licenses.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç¦ç”¨çš„è®¸å¯è¯
          node -e "
            const licenses = require('./licenses.json');
            const forbidden = ['GPL-2.0', 'GPL-3.0', 'AGPL-1.0', 'AGPL-3.0'];
            const found = Object.entries(licenses)
              .filter(([pkg, info]) => forbidden.includes(info.licenses))
              .map(([pkg, info]) => ({ package: pkg, license: info.licenses }));
            
            if (found.length > 0) {
              console.log('âš ï¸ å‘ç°ç¦ç”¨è®¸å¯è¯:');
              found.forEach(item => console.log(\`  \${item.package}: \${item.license}\`));
              process.exit(1);
            } else {
              console.log('âœ… æ‰€æœ‰ä¾èµ–è®¸å¯è¯åˆè§„');
            }
          "

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json