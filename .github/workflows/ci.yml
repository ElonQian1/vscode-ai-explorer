# AI Explorer - æŒç»­é›†æˆ
name: CI

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build-test:
    name: Build & Test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [18, 20]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript compilation
        run: npm run compile

      - name: ESLint check
        run: npm run lint

      - name: Run tests
        run: npm run pretest

      - name: Dependency Architecture Check
        run: |
          echo "ğŸ” æ£€æŸ¥ä¾èµ–æ¶æ„..."
          if [ -f ".dependency-cruiser.cjs" ]; then
            npx depcruise src --config .dependency-cruiser.cjs --output-type dot > deps.dot
            echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"
            
            # ç”Ÿæˆä¾èµ–å›¾ (ä»…åœ¨ Ubuntu ä¸Š)
            if [ "${{ matrix.os }}" == "ubuntu-latest" ] && command -v dot >/dev/null 2>&1; then
              apt-get update && apt-get install -y graphviz || true
              dot -Tsvg deps.dot > deps.svg
              echo "ğŸ“Š ä¾èµ–å›¾å·²ç”Ÿæˆ"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° .dependency-cruiser.cjsï¼Œè·³è¿‡ä¾èµ–æ£€æŸ¥"
          fi
        shell: bash

      - name: CSP Security Check
        run: |
          echo "ğŸ”’ æ£€æŸ¥ Webview CSP å®‰å…¨..."
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…è”è„šæœ¬ï¼ˆé¿å… CSP è¿è§„ï¼‰
          find media webview -name "*.html" -type f 2>/dev/null | while read file; do
            if grep -q '<script[^>]*>[^<]' "$file" 2>/dev/null; then
              echo "âŒ å‘ç°å†…è”è„šæœ¬åœ¨ $fileï¼Œå¯èƒ½è¿å CSP ç­–ç•¥"
              exit 1
            fi
          done || echo "âœ… æœªå‘ç°å†…è”è„šæœ¬è¿è§„"
        shell: bash

      - name: Package VSIX
        run: |
          echo "ğŸ“¦ æ‰“åŒ… VS Code æ‰©å±•..."
          npx vsce package --no-dependencies
          echo "âœ… VSIX æ‰“åŒ…å®Œæˆ"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-node${{ matrix.node }}
          path: |
            *.vsix
            deps.*
            out/**
          retention-days: 7

  # ä¾èµ–å›¾è¯„è®ºåˆ° PRï¼ˆä»…åœ¨ PR äº‹ä»¶ä¸” Ubuntu ç¯å¢ƒï¼‰
  comment-dependencies:
    name: Comment Dependencies
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-latest-node20
          path: ./artifacts

      - name: Comment PR with dependency info
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: dependency-info
          message: |
            ## ğŸ—ï¸ æ„å»ºä¿¡æ¯
            
            âœ… **æ„å»ºçŠ¶æ€**: æˆåŠŸå®Œæˆ
            ğŸ“¦ **VSIX åŒ…**: å·²ç”Ÿæˆï¼Œè§æ„å»ºå·¥ä»¶
            ğŸ“Š **ä¾èµ–å›¾**: `deps.svg` (å¦‚æœ‰ç”Ÿæˆ)
            
            ### ğŸ” æ£€æŸ¥é¡¹ç›®
            - âœ… TypeScript ç¼–è¯‘
            - âœ… ESLint ä»£ç è§„èŒƒ 
            - âœ… å•å…ƒæµ‹è¯•
            - âœ… ä¾èµ–æ¶æ„æ£€æŸ¥
            - âœ… CSP å®‰å…¨æ£€æŸ¥
            - âœ… VSIX æ‰“åŒ…

            _æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ_