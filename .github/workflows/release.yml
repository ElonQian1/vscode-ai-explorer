# AI Explorer - è‡ªåŠ¨å‘å¸ƒ
name: Release

on:
  push:
    tags: ['v*.*.*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  discussions: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: |
          echo "ğŸ—ï¸ æ„å»ºæ‰©å±•..."
          npm run compile
          echo "âœ… æ„å»ºå®Œæˆ"

      - name: Run tests
        run: |
          echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
          npm run pretest
          echo "âœ… æµ‹è¯•é€šè¿‡"

      - name: Package VSIX
        run: |
          echo "ğŸ“¦ æ‰“åŒ… VSIX..."
          npx vsce package --no-dependencies
          ls -la *.vsix
          echo "âœ… VSIX æ‰“åŒ…å®Œæˆ"

      - name: Generate Release Notes
        id: release-notes
        run: |
          echo "ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜..."
          cat > release-notes.md << 'EOF'
          ## ğŸš€ AI Explorer v${{ github.ref_name }}
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸŒ³ **æ–‡ä»¶æ ‘è“å›¾**: å¯è§†åŒ–é¡¹ç›®ç»“æ„ï¼Œæ”¯æŒåŒå‡»æ–‡ä»¶åˆ†æ
          - ğŸ¤– **AI æ–‡ä»¶åˆ†æ**: é™æ€åˆ†æ + AI å¢å¼ºï¼Œæä¾›æ·±åº¦æ´å¯Ÿ
          - ğŸ¯ **æ™ºèƒ½å¯¼èˆª**: é¢åŒ…å±‘å¯¼èˆªï¼Œæ”¯æŒç›®å½•ä¸‹é’»å’Œè¿”å›
          - ğŸ“Š **å®æ—¶ç»Ÿè®¡**: èŠ‚ç‚¹æ•°é‡ã€è¾¹æ•°ã€æ·±åº¦ç­‰é¡¹ç›®æŒ‡æ ‡
          
          ### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
          - TypeScript + Webview æ¶æ„
          - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒæ‰©å±•
          - å®Œå–„çš„ç¼“å­˜æœºåˆ¶ï¼Œæå‡æ€§èƒ½
          - CSP å®‰å…¨ç­–ç•¥ï¼Œä¿éšœå®‰å…¨
          
          ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **æ„å»ºæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - **Node.js**: $(node --version)
          - **TypeScript**: $(npx tsc --version)
          - **å¹³å°**: Linux, Windows, macOS
          
          ---
          
          æ›´å¤šè¯¦æƒ…è¯·æŸ¥çœ‹ [CHANGELOG](./CHANGELOG.md) å’Œé¡¹ç›®æ–‡æ¡£ã€‚
          EOF
          
          echo "content=$(cat release-notes.md)" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: "*.vsix"
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true

      - name: Publish to VS Code Marketplace
        if: ${{ !contains(github.ref_name, 'alpha') && !contains(github.ref_name, 'beta') }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_TOKEN }}
        run: |
          echo "ğŸš€ å‘å¸ƒåˆ° VS Code Marketplace..."
          if [ -n "$VSCE_PAT" ]; then
            npx vsce publish --packagePath *.vsix --pat $VSCE_PAT
            echo "âœ… Marketplace å‘å¸ƒå®Œæˆ"
          else
            echo "âš ï¸ VSCE_TOKEN æœªé…ç½®ï¼Œè·³è¿‡å‘å¸ƒ"
          fi

      - name: Publish to Open VSX Registry
        if: ${{ !contains(github.ref_name, 'alpha') && !contains(github.ref_name, 'beta') }}
        env:
          OVSX_PAT: ${{ secrets.OVSX_TOKEN }}
        run: |
          echo "ğŸš€ å‘å¸ƒåˆ° Open VSX Registry..."
          if [ -n "$OVSX_PAT" ]; then
            npx ovsx publish *.vsix -p $OVSX_PAT
            echo "âœ… Open VSX å‘å¸ƒå®Œæˆ"
          else
            echo "âš ï¸ OVSX_TOKEN æœªé…ç½®ï¼Œè·³è¿‡å‘å¸ƒ"
          fi

      - name: Notify Release
        run: |
          echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
          echo "ğŸ“¦ VSIX: $(ls *.vsix)"
          echo "ğŸ”— Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"